/*
 * base
 * 不依赖其他模块,提供最基础的web开发函数库
 */object.define("webpager/lib/base","dom, events, net",function(e,t,n){if(window.asyncHTMLManager)var r=asyncHTMLManager.__timer.setTimeout,i=asyncHTMLManager.__timer.setInterval;else var r=window.setTimeout,i=window.setInterval;try{var s={setTimeout:r};s.setTimeout(function(){}),t.setTimeout=r,t.setInterval=i}catch(o){t.setTimeout=function(){return r.apply(window,arguments)},t.setInterval=function(){return i.apply(window,arguments)}}var u=function(e){e.readyQ=[],e.isReady=!1,e.ready=function(e){this.isReady?e.call(this):this.readyQ.push(e)},e.doReady=function(){for(var e=0;e<this.readyQ.length;e++)this.readyQ[e].call(this);this.isReady=!0}},a=e("dom"),f=e("events"),l=e("net");if(window.asyncHTMLManager&&window.asyncHTMLManager.dom)var a=window.asyncHTMLManager.dom;var c=a.Element.get("addEvent"),h=function(e,t,n){if(null==t||"object"!=typeof t)return t;var e=e||t.constructor();for(var r in t)t.hasOwnProperty(r)&&(!e[r]||n)&&(e[r]=t[r]);return e},p={site:"renren.com"},d=function(e){var t=document.createElement("div");t.style.display="none",document.body.appendChild(t),t.innerHTML=e;var n=document.createDocumentFragment();while(t.firstChild)n.appendChild(t.firstChild);return t.parentNode.removeChild(t),n};t.dom=a,t.addEvent=c,t.events=f,t.net=l,t.extend=h,t.$extend=$extend,t.Sizzle=Sizzle,t.readly=u,t.ENV=p,t.XN=XN,t.parseHTML=d}),object.define("webpager/lib/base/logger",function(e,t,n){var r=50,i=window._log_data=[],s={_output_filter:"",_listener:null,log:function(e,t){var n=Array.prototype.slice.call(arguments,2),s={service:e,type:t,content:n,time:new Date-0};i.length>r&&i.shift(),i.push(s),this._listener&&this._listener.apply&&(!this._output_filter||this.check(s,this._output_filter))&&this._listener(s)},apply:function(e){this.log.apply(this,e)},check:function(e,t){return!0},lookup:function(e,t,n){var r=0,s=[],o=i.length-t;while(o>=0){if(i[o]&&this.check(i[o],e)){if(++r>n)break;s.push(i[o])}o--}return s},listen:function(e,t){typeof e=="function"&&(t=e,e=null),this._listener=t,this._output_filter=e}},o=function(e){return Array.prototype.slice.call(e,0)},u=function(e){this.service=e};u.prototype={log:function(e){var t=o(arguments);t.unshift(this.service),s.apply(t)},tlog:function(e,t){var n=o(t);n=[this.service,e].concat(n),s.apply(n)},log1:function(){this.tlog("1",arguments)},log2:function(){this.tlog("2",arguments)},err:function(){this.tlog("error",arguments)},action:function(){this.tlog("useraction",arguments)},todo:function(){this.tlog("TODO",arguments)}};var a={};t.getInstance=function(e){if(a[e])return a[e];var t=new u(e);return a[e]=t,t},t.logger=s}),object.define("webpager/lib/tools","./base, ./base/logger, ./channel_api",function(require,exports,module){function two(e){return parseInt(e)>9?e:"0"+e}function scrub(e){return(new Option(e)).innerHTML.replace(/"/g,"&quot;")}function get_value(e,t){var n=t.split("."),e;while(n.length){if(!(n[0]in e))return!1;e=e[n.shift()]}return e}var base=require("./base"),Log=require("./base/logger"),channel=require("./channel_api"),webpager=window.webpager,$extend=base.$extend,Logger=Log.logger,logger=Log.getInstance("tools"),debug={level:0,on:function(e){var t=this;this.level=e||1,exports.isDebugging=!0,Logger.listen(function(e){var n=[t.getLogTime(e.time)," : ","["+e.type+"]"+e.service];n=n.concat(e.content),t.writeLog(n)})},off:function(){exports.isDebugging=!1,this.level=0,Logger.listen(null)},getLogTime:function(e){var t=new Date(e);return t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()}};window.webpager.debug=debug,function(){var e;XN.browser.IE||!window.console||!window.console.log?e=function(e){window.jash&&jash.print(e)}:e=function(e){console.log.apply(console,e)},debug.writeLog=e}(),window.location.toString().indexOf("debug")!=-1&&(debug.on(),XN.DEBUG_MODE=!0);var QA={log:function(e){},log2:function(e){},expt:function(e,t){}};QA.reportExpt=channel.imengine.WPC.reportExpt,QA.genTimer=function(){var e={start:new Date-0,logs:[],tags:{},_end:!1,tag:function(e){this.tags[e]=new Date-0},log:function(e){this._end&&(this.logs=[]);var t=this.tags[e]||this.start;this.logs.push(e+":"+(new Date-t)),this._end&&this.end()},end:function(){this._end=!0;var e="task=fbook_profile&uid="+User.id+"&start="+this.start,t="tags="+this.logs.join();try{window.imengine.WPC.reportLogMsg(e+"&"+t)}catch(n){}}};return e};var Bling=new Class(function(){this.__mixins__=[base.events.Events],this.fn0=null,this.fn1=null,this.onStart=null,this.initialize=function(e,t){base.extend(e,t,!0)},this.start=function(e){var t=0;e.inter&&clearInterval(e.inter),e.onStart&&e.onStart(),e.inter=setInterval(function(){t++%2?e.fn1():e.fn0()},e.timeInterv||1e3)},this.stop=function(e){clearInterval(e.inter),e.fireEvent("stop")}}),pagerTimer=new base.events.Events;pagerTimer.init=function(){var e=this;(function(){var t=arguments;base.setTimeout(function(){e.fireEvent("timeout"),t.callee()},1500)})(),function(){var t=arguments;base.setTimeout(function(){e.fireEvent("timeout10"),t.callee()},1e3)}()},pagerTimer.init();var resource={url:{NOTIFY:"http://notify."+XN.env.domain+"/get.notify?view=1&nid=0&limit=10&rand="+Math.random(),DEL_NOTIFY:"http://notify."+XN.env.domain+"/remove.notify",OFFLINE_IMG:"http://head.xiaonei.com/photos/0/0/men_tiny.gif",WEB_ONLINE:"http://s.xnimg.cn/imgpro/icons/web_online_std.png",WEB_ONLINE_IE6:"http://s.xnimg.cn/imgpro/icons/web_online_ie6.gif",RR_ONLINE:"http://s.xnimg.cn/imgpro/icons/rr_online_std.png",RR_ONLINE_IE6:"http://s.xnimg.cn/imgpro/icons/rr_online_ie6.gif",WPI_CLOSE:"http://s.xnimg.cn/imgpro/icons/wpi_close_std.png",WPI_CLOSE_IE6:"http://s.xnimg.cn/imgpro/icons/wpi_close_ie6.gif",WPI_STATUS_COMMON:"http://s.xnimg.cn/imgpro/icons/wpi_status_common.png",WPI_STATUS_HLIGHT:"http://s.xnimg.cn/imgpro/icons/wpi_status_hlight.png",WPI_WEBTALK_CAMERA:"http://s.xnimg.cn/imgpro/icons/webtalk_camera.png",WPI_PHOTO_COMMON:"http://s.xnimg.cn/imgpro/icons/wpi_photo_common.png",WPI_PHOTO_HLIGHT:"http://s.xnimg.cn/imgpro/icons/wpi_photo_hlight.png",WPI_SHARE_COMMON:"http://xnimg.cn/imgpro/icons/share.gif",WPI_BULB:"http://a.xnimg.cn/imgpro/icons/bulb.png"},msg:{INPUT_DEFAULT:"请输入聊天内容",TOO_LONG:"您发送的内容超过2000字, 发送失败",NOTICE:"为保护你的隐私，将默认此对话为悄悄话！",NOTICE2:"开启桌面通知，感受全新体验！",SPAM:{"-1":"您目前不在登录状态，请尝试重新登录后再试。如果您一直收到这个信息，请联系管理员",2:"该状态不存在",4:"请不要发布政治敏感内容、色情内容、商业广告或其他不恰当内容",5:"你短时间内发表了太多相同的内容"}}},u=XN.user,User={id:u.id,name:decodeURIComponent(u.name.replace(/\+/g," ")),head:u.tinyPic},isMyself=function(e){return User.id==e},getTime=function(e){if(e){if(!(e instanceof Date)){var t=e-0;if(!t)return e;var e=new Date(t*1e3)}}else var e=new Date;return two(e.getMonth()+1)+"-"+two(e.getDate())+" "+two(e.getHours())+":"+two(e.getMinutes())},getDate=function(e){var e=e&&new Date(e)||new Date;return e.getFullYear()+"-"+two(e.getMonth()+1)+"-"+two(e.getDate())},getDateTime=function(e){var e=e&&new Date(e)||new Date;return e.getFullYear()+"-"+two(e.getMonth()+1)+"-"+two(e.getDate())+" "+two(e.getHours())+":"+two(e.getMinutes())};getTime=getDateTime;var tryer=new Class({"@mixins":[base.events.Events],tryAWhile:function(e,t,n,r){e.clear(),e._inter=setInterval(function(){r()===!0&&(This.clear(),This.fireEvent("tryer_sus"))},t),e._timeout=base.setTimeout(function(){This.clear(),This.fireEvent("tryer_timeout")},n)},clear:function(e){clearInterval(e._inter),clearTimeout(e._timeout)}}),Cluster_Client=new Class(function(){function f(e,t){function i(){a=!1,channel.persistMgr.storageGet("cluster_"+t,1)==r?e(t):f(e,t)}if(a)return;a=!0;var t=t||Math.floor(99*Math.random()),n=null;for(;;){n=channel.persistMgr.storageGet("cluster_"+t,1);if(!n)break;t++}var r=Math.ceil(1e3*Math.random());channel.persistMgr.storageSet("cluster_"+t,r,1,1),base.setTimeout(i,2e3)}function c(){logger.log1("Cluster : start_digestion >>>>>");if(l)return;if(!parseInt(o)){var e=parseInt(window.name);if(!e){var t=arguments.callee;f(function(e){o=e,t()});return}o=e,n=!1}window.name=o,u.length&&(clearTimeout(l),l=base.setTimeout(function(){l=0;var e=u;u=[],logger.log1("Cluster : send queue",e),++i>20&&(i=1);var t="cluster_"+o+"_"+i;logger.log2("Cluster > broadcast Content :",JSON.stringify(e)),channel.persistMgr.storageSet(t,JSON.stringify(e),1)},200))}function h(t,n,r){msg={service:t,t:new Date-0,s:o,m:n},u.push(msg);if(r){var i=e[t];i.fireEvent("message",{data:n,source:o})}}var e={},t="cluster_clients",n=!0,r=[],i=0,s=channel.connectMgr.isLocalConnect(),o=0,u=[];webpager.addEvent("storage",function(n){var i,u,a=/cluster_(\d+)_\d+/g;while(i=a.exec(n.keys)){if(i[1]==o)continue;u=channel.persistMgr.storageGet(i[0],1),u=JSON.parse(u),logger.log2("Cluster > broadcast Recived :",u),u.forEach(function(t){var n=e[t.service];n&&n.fireEvent("message",{data:t.m,source:t.s})})}return}),base.setTimeout(function(){var t=!1;if(s!=channel.connectMgr.isLocalConnect()){s=!s;for(var n in e)e[n].fireEvent("master",{ismaster:s});if(s){t=!0;var i=channel.persistMgr.storageGet("cluster",1);if(i)try{i=JSON.parse(i),r=r.concat(i)}catch(o){}}}base.setTimeout(arguments.callee,1500);return},1500),base.setTimeout(function(){o&&channel.persistMgr.storageSet("cluster_"+o,new Date-0,1)},5e3);var a=!1,l=0;c(),this.__mixins__=[base.events.Events],this.initialize=function(t,n){if(n in e)return e[n];t.service=n,e[n]=t},this.isMaster=function(){return s},this.isNew=function(){return n},this.broadcast=function(e,t,n){h(e.service,t,!!n),c()}});exports.unescapeHTML=function(e){var t=document.createElement("div");return t.innerHTML=e,XN.browser.IE?t.innerText:t.textContent},exports.htmlFilter=function(e){return e=e.replace(/&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e},exports.getDom=function(e){var t=document.createElement("div");t.style.display="none",document.body.appendChild(t),t.innerHTML=e;var n=document.createDocumentFragment();while(t.firstChild)n.appendChild(t.firstChild);return t.parentNode.removeChild(t),n};var Focus=function(){function i(){t&&(r.broadcast(!1),t=!1,n--)}function s(){t||(r.broadcast(!0),t=!0,n++,e.fireEvent("focus",{data:!0,source:0}))}function o(){}var e=new base.events.Events,t=!1,n=0,r=new Cluster_Client("window_focus");return r.addEvent("message",function(t){t.data?(n++,e.fireEvent("focus",t)):n--}),window.addEvent("blur",i),window.addEvent("focus",s),window.addEvent("unload",function(){i()}),r.isNew()||r.broadcast(!1),o(),e.isFocusRR=function(){return n},e.isFocusMe=function(){return t},e},getWindowSize=function(){if(self.innerHeight)var e=self.innerWidth,t=self.innerHeight;else if(document.documentElement&&document.documentElement.clientHeight)var e=document.documentElement.clientWidth,t=document.documentElement.clientHeight;else if(document.body)var e=document.body.clientWidth,t=document.body.clientHeight;return{width:e,height:t}},winFrame=new Class(function(){this.__mixins__=[base.events.Events],this.frame=window,this.initialize=function(e){e.bindEvent()},this.bindEvent=function(e){XN.dom.ready(function(){base.addEvent(window,"resize",function(t){e.fireEvent("resize",{data:getWindowSize()})})});if(XN.browser.IE){var t=getWindowSize();pagerTimer.addEvent("timeout",function(){var n=getWindowSize();if(t.width!=n.width||t.height!=n.height)t=n,e.fireEvent("resize",{data:n})})}}}),parseHTML=function(e){var t=document.createElement("div");t.style.display="none",document.body.appendChild(t),t.innerHTML=e;var n=document.createDocumentFragment();while(t.firstChild)n.appendChild(t.firstChild);return t.parentNode.removeChild(t),n};exports.getClientHeight=function(){if(document.documentElement)return document.documentElement.clientHeight},exports.getClientWidth=function(){if(document.documentElement)return document.documentElement.clientWidth};var getPageScroll=function(){var e,t;return window.pageYOffset?(t=window.pageYOffset,e=window.pageXOffset):document.documentElement&&document.documentElement.scrollTop?(t=document.documentElement.scrollTop,e=document.documentElement.scrollLeft):document.body&&(t=document.body.scrollTop,e=document.body.scrollLeft),{x:e,y:t}};exports.inputPosition=function(e,t){var n=e;XN.isUndefined(t)&&(t=n.value.length);try{if(n.setSelectionRange)n.focus(),n.setSelectionRange(n.value.length,t);else if(n.createTextRange){var r=n.createTextRange();r.moveStart("character",t),r.collapse(!0),r.select(),n.focus()}else n.focus()}catch(i){}return this},exports.isInDom=function(e){var t=!1,n=e;while(n.parentNode){if(n.parentNode===document.body){t=!0;break}n=n.parentNode}return t},exports.noMoreThan=function(e,t,n,r){if(!e)return"";if(e&&e.length<=t)return e;if(n){var i=e.length,s=i-t;return e.substring(0,Math.floor((i-s)/2))+"..."+e.substring(Math.floor((i+s)/2))}return r?e.substring(0,t):e.substring(0,t)+"..."};var AsyncMgr=function(e){e&&$extend(this,e),this.asyncs=[]};AsyncMgr.prototype={doneNum:0,timeout:2e3,register:function(e){this.asyncs.push({t:e,done:!1})},thisDone:function(e){var t=this.asyncs.length;for(var n=0;n<t;n++)if(this.asyncs[n].t==e&&this.asyncs[n].done===!1){this.asyncs[n].done=!0,this.doneNum++;break}this.doneNum==t&&(this.doneNum=0,this.asyncs.length=0,this.stop(),this.fireEvent("asyncMgr_all_done"))},start:function(){var e=this;this.timer=setTimeout(function(){e.fireEvent("asyncMgr_timeout",e.asyncs)},this.timeout)},stop:function(){clearTimeout(this.timer)}},XN.event.enableCustomEvent(AsyncMgr.prototype),exports.makeHeadTinyurl=function(e){return e?(e.indexOf("http://")==-1&&(e.indexOf("_tiny.gif")!=-1?e="http://head.xiaonei.com/photos/"+e:e="http://hdn.xnimg.cn/photos/"+e),e):""},exports.makeProfileUrl=function(e){return"http://www.renren.com/profile.do?id="+e},exports.whiteList={_mice:!1,_spread:!1,spreadList:window.frames.imengine.shabby,list:["301005405","318504593","221751982","238995479","230961237"],checkMice:function(){if(this._mice)return!0;try{return this.list.indexOf(User.id)>=0?(this._mice=!0,!0):!1}catch(e){return!1}},checkSpread:function(){if(this.checkMice()||this._spread)return!0;try{return this.spreadList.indexOf(User.id)>=0?(this._spread=!0,!0):!1}catch(e){return!1}}},exports.isEmptyObject=function(e){for(var t in e)return!1;return!0};var renderTpl=function(fragment,vars){var blockregex=/\{\{(([@!]?)(.+?))\}\}(([\s\S]+?)(\{\{:\1\}\}([\s\S]+?))?)\{\{\/\1\}\}/g;return fragment.replace(/<script>[\w\W]*?<\/script>/img,function(){return""}).replace(blockregex,function(e,t,n,r,i,s,o,u){var a=get_value(vars,r),f="",l;if(!a)return n=="!"?renderTpl(i,vars):o?renderTpl(u,vars):"";if(!n)return renderTpl(s,vars);if(n=="@"){for(l in a)a.hasOwnProperty(l)&&(vars._key=l,vars._val=a[l],f+=renderTpl(i,vars));return delete vars._key,delete vars._val,f}}).replace(/\{\{([=%])(.+?)\}\}/img,function(e,t,n){var r=get_value(vars,n);return r||r===0?t=="%"?scrub(r):r:""}).replace(/\[([^\]]*?)\]/img,function(_,meta,key){var obj=eval("({"+meta.replace(/;/g,",")+"})"),ele=document.createElement("a");for(var i in obj){if(i=="btn")continue;ele.setAttribute(i,obj[i])}return ele.innerHTML=obj.btn,ele.href="javascript:;",ele.outerHTML})};exports.AsyncMgr=AsyncMgr,exports.winFrame=new winFrame,exports.focused=Focus(),exports.resource=resource,exports.User=User,exports.Cluster_Client=Cluster_Client,exports.tryer=tryer,exports.pagerTimer=pagerTimer,exports.debug=debug,exports.QA=QA,exports.Bling=Bling,exports.isMyself=isMyself,exports.getTime=getTime,exports.getDate=getDate,exports.getDateTime=getDateTime,exports.parseHTML=parseHTML,exports.getPageScroll=getPageScroll,exports.getLogger=Log.getInstance,exports.renderTpl=renderTpl}),object.define("webpager/lib/uikit","./uikit/common, ./uikit/window, ./uikit/pager, ./base, ./tools, ./emoticons, xn/mention",function(e,t,n){var r=e("./uikit/common");t.UIcommon=r.UIcommon,t.UIcomplex=r.UIcomplex,t.UIcontainer=r.UIcontainer;var i=e("./uikit/window");t.WinSlider=i.WinSlider,t.Window=i.Window,t.WindowWithDrawer=i.WindowWithDrawer;var s=e("./uikit/pager");t.WebPager=s.WebPager,t.PagerCase=s.PagerCase;var o=e("xn/mention").Mention,u=e("./base"),a=u.dom,f=u.events,l=e("./tools"),c=l.getLogger("uikit"),h=u.XN,p=e("./emoticons"),d=new Class(r.UIcommon,function(){this.__mixins__=[r.UIcontainer],this.messages=[],this._scroll_bottom=!0,this.initialize=function(e,t){e.buildFrame(),e._container=e.frame,e.now=new Date,e.totalDialogs=0,e.firstDialog=0,e.config=t||{}},this.buildFrame=function(e){var t=a.wrap(document.createElement("article"));return t.addClass("dialogs"),e.frame=t,t},this.pushDialog=function(e,t,n){var r=n?n(t):e.buildDialog(t);e.messages.push(t);var i=e._container,s=a.getElements("img",r.childNodes[r.childNodes.length-1]);for(var o=0;o<s.length;o++)s[o].onload=function(){e.scrollBottom()};return e._container.appendChild(r),e.scrollBottom(),r},this.scrollBottom=function(e){var t=e._container;t.scrollTop=t.scrollHeight},this.buildDialog=function(e,t){var n="";if(t.tag!="system"){e.totalDialogs++;var r=t.time.split(" "),i=r[0].split("-"),s=r[1].split(":"),o=parseInt(i[0]),u=parseInt(i[1])-1,a=parseInt(i[2]),f=parseInt(s[0]),c=parseInt(s[1]),s=(new Date(o,u,a,f,c)).getTime(),p=new Date(e.now.getFullYear(),e.now.getMonth(),e.now.getDate()),d=p.getTime()-864e5;beforYesterdayBegin=d-864e5,e.firstDialog==0?(e.baseTime=s,e.firstDialog=1,e.firstDialogTime=s):e.firstDialog==1&&(e.baseTime=e.firstDialogTime,e.firstDialog=2);var v=s-e.baseTime;if(e.firstDialog==1||v>=3e5||e.totalDialogs>10){var m="";s>p&&m<=p+864e5?m=t.time.split(" ")[1]:s>d&&s<=p?m="昨天 "+t.time.split(" ")[1]:s>beforYesterdayBegin&&s<=d?m="前天 "+t.time.split(" ")[1]:s>0&&s<=beforYesterdayBegin?m=t.time:m="",m?n=['<section class="sys-info">',m,"</section>"].join(""):n="",e.baseTime=s,e.firstDialog==1?"":e.totalDialogs=0}}if(t.tag=="system"){var g=['<section class="sys-info">',t.content,"</section>"].join("");return l.parseHTML(g)}var y=(t.uid||t.id)==h.user.id?"wp-chatlist wp-chatlist-self":"wp-chatlist";if(t.msg_headsrc){h.browser.IE6&&(window.fixIE6Size=function(e){if(e.width<100){e.style.height=e.height+"px";return}e.style.width="100px",e.style.height=e.height*100/e.width+"px"});var b=h.browser.IE6?'onload="fixIE6Size(this);"':'width="100"',g=[n,'<section class="',y,'">','<figure class="avatar">','<a href="'+t.profile+'" target="_blank" title="'+t.name+'">','<img width="35" height="35" src="'+t.avatar+'"/>',"</a>","</figure>",'<section class="wp-chat-pic wp-chat-content"><em class="wp-arrow"></em><em class="wp-arrow wp-arrow-inner"></em>','<p class="wp-img-wrap clearfix">','<a href="',t.msg_originalsrc,'" target="_blank">','<img class="wp-mini-pic" src="',t.msg_headsrc,'"',b," />","</a></p>",t.content==="undefined"?"":"<p>"+t.content+"</p>","</section>","</section>"].join("");return l.parseHTML(g)}if(t.msg_audiosrc){var g=[n,'<section class="',y,'">','<figure class="avatar">','<a href="'+t.profile+'" target="_blank" title="'+t.name+'">','<img width="35" height="35" src="'+t.avatar+'"/>',"</a>","</figure>","<section>",'<a href="#nogo" onclick="return false;" data-vocal="{\'url\': \'',t.msg_audiosrc,"', 'time': 235, 'ownerId': 123, 'voiceId': 234}\"  class=\"vocal-player float-left\"><span class=\"btn\"></span><span class=\"time\"></a>","</section>","</section>"].join("");return l.parseHTML(g)}var w=[n,'<section class="',y,'">','	<figure class="avatar">','		<a href="'+t.profile+'" target="_blank" title="'+t.name+'"><img width="35" height="35" src="'+t.avatar+'" /></a>',"	</figure>",'	<section class="wp-chat-content">','		<em class="wp-arrow"></em><em class="wp-arrow wp-arrow-inner"></em>',"		<p>"+t.content||"　</p>","	</section>",'	<footer><span class="wp-chat-time">'+t.time+"</span></footer>","</section>"].join(""),E=l.parseHTML(w);return E},this.buildCutoff=function(e,t){var n=['<section style="position: relative; top: -6px; padding: 5px; margin:0 6px; background: white; ">','	<fieldset style="height: 27px; border-width: 1px 0 0; border-style: solid; border-color: #EEE; line-height: 27px; text-align:center">','	<legend style="padding: 0 14px; color: #EEE; font-weight: bold; ">'+t+"</legend>","</fieldset></section>"].join(""),r=l.parseHTML(n);return r},this.buildEarlyBtn=function(e){var t=["<section>",'	<p class="wp-get-early">',"</p></section>"].join(""),n=l.parseHTML(t);return n},this.earlyContent=function(e,t,n){var r=document.createDocumentFragment(),i,s,o=[],u;while(u=t.shift())s=n(u),i=s?s(u):e.buildDialog(u),r.appendChild(i),o.push(i);var f=e.buildCutoff("更早的记录").firstChild;r.appendChild(f);var l=e._container,c=a.getElement("section.wp-chatlist",l);c?l.insertBefore(r,c):l.appendChild(r),l.scrollTop=f.offsetTop-100},this.replaceContent=function(e,t,n){e.messages=t,e.refresh(n)},this.refresh=function(e,t){if(e.messages.length>20)var n=e.messages.slice(e.messages.length-19);else var n=e.messages;var r=e._container;r.innerHTML="";if(e.config.early_btn){e.frame.appendChild(e.buildEarlyBtn());var i=a.getElement("p.wp-get-early",e.frame);i.addEvent("click",function(){}),e.earlyBtn=i}n.forEach(function(n){var r,i=t(n);i?r=i(n):r=e.buildDialog(n),e._container.appendChild(r)}),e.scrollBottom()}});if(webpager.imRunning||window.frames["imengine"].AD_FOR_RRZM==undefined)var v="";else{if(window.frames["imengine"].AD_FOR_RRZM.platform=="mac")var m="http://im.renren.com/mac?word0";else var m="http://im.renren.com/desktop/rrsetup-53.exe";var g="http://s.xnimg.cn/img/rrzm.png",y="color:#456B8A;height:26px;line-height:26px;padding-left:18px;background:url("+g+") no-repeat left;",b="padding-left:7px;width:200px;float:left;overflow:hidden;font-size:13px;_font-size:12px;",v='<div class="ad-button" style="'+b+'"><a target="_blank" title="点击下载" style="'+y+'" href="'+m+'">人人桌面</a>,实时挂机看回复!</div>'}var w=new Class(r.UIcommon,function(){this._disabled=!1,this._replyTo={},this._whisper=!1,this._features=["emotion","mention","invite","attachment","voice","history"],this.features={},this._pluginFeatures={},this.maxinput=2e3,this.maxinput_tip="不能超过2000字符.",this.initialize=function(e,t){t.maxinput&&(e.maxinput=t.maxinput.num,e.maxinput_tip=t.maxinput.tip),e.buildFrame("footer"),e.frame.addClass("wp-edit-box"),e.getUIRef(),e.bindEvent(),e.buildFeatures(t)},this.makeFrameHTML=function(e){var t=['	<div class="wp-chat-toolbar">',"	</div>",'	<form method="post" action="" class="editor">',"		<textarea></textarea>",'		<div class="wp-chat-send-box clearfix">'+v+'<a href="#nogo" onclick="return false;" class="wp-chat-send">发送</a></div>',"	</form>"].join("");return t},this.getUIRef=function(e){var t=e.frame,n={toolbar:t.getElement("div.wp-chat-toolbar"),form:t.getElement("form"),text:t.getElement("textarea")};n.sbtn=n.form.getElement("a.wp-chat-send"),e.nodes=n},this.bindEvent=function(e){var t=e.nodes,n=0;t.sbtn.addEvent("click",function(t){clearTimeout(n);if(e._disabled)return;e._sendText()}),t.text.addEvent("keydown",function(n){if(e._disabled)return!1;if(n.keyCode=="13"){if(n.shiftKey||n.ctrlKey)return;if(t.text.mention&&t.text.mention.selectorShow&&!t.text.mention.noMatch)return;e._sendText()}})},this.buildFeatures=function(e,t){if(!t)return;e._features.forEach(function(n){t[n]&&e.addFeature(n,t[n])})},this.plugFeature=function(e,t){e._features.push(t.name),e.features[t.name]=!0,e._pluginFeatures[t.name]=t},this.useFeature=function(e,t){var n=e._pluginFeatures[t];if(!n)return;e.nodes.toolbar.appendChild(n.trigger),n.init.call(e,e,n.trigger)},this.addFeature=function(e,t,n){var r=e.nodes;if(t=="emotion"){var i=document.createElement("div");i.innerHTML='<a href="#nogo" onclick="return false;" class="wp-chat-feelings" title="添加表情"></a><div class="emo_container"></div>',i=a.getElement("a",i),e.nodes.toolbar.appendChild(i),h.loadFile("http://s.xnimg.cn/csspro/module/minieditor.css",function(){window.webpager.emo=e.features.emotion=p.emoticons({input:e.nodes.text,button:i,url:"http://status.renren.com/getubblist.do?type=5",btnAlignType:"1-1",emoPopFixed:!0,btnOffsetY:-117,onShowEmoPop:function(){if(h.browser.IE6)return;var e=this.emotionsContainer,t=jxn("#dropmenuHolder").offset().left;e.setOffsetX(t)}})})}else if(t=="mention"){var s=l.parseHTML('<a href="#nogo" onclick="return false;" class="wp-at" title="点名"></a>').childNodes[0];e.nodes.toolbar.appendChild(s),o.init([{obj:r.text,ugcId:n.ugcId,ugcType:n.ugcType,ownerId:n.ownerId,popTop:!0,scrollable:!0,whisper:!1,button:s,initCallback:function(){}}]),h.cookie.get("at")||h.cookie.set("at","1",1,"/","renren.com")}else if(t=="history"){var i=document.createElement("div");i.innerHTML='<a href="#nogo" onclick="return false;" class="wp-chat-history">聊天记录</a>',i=a.getElement("a",i),e.nodes.toolbar.appendChild(i)}else if(t!="attachment"&&t!="audio"&&t=="invite"){var i=document.createElement("div");i.innerHTML='<a href="#nogo" onclick="return false;" class="wp-add-chat" title="添加聊天"></a>',i=a.getElement("a",i);var u=e.features.invite=new S;e.frame.appendChild(u.frame),u.bindTrigger(i,function(t){c.log1("uikit/Inputer: 添加好友 ",t),e.fireEvent("invite",{data:t,close:function(){u.fold(),u.selector.reset()}})}),e.nodes.toolbar.appendChild(i),r.text.addEvent("focus",function(e){(!u.getSelectedFrds()||!u.getSelectedFrds().length)&&u.fold()})}},this.reset=function(e,t){setTimeout(function(){e.nodes.text.value="",t&&e.nodes.text.focus()},10),e._replyTo=!1,e._whisper=!1},this._sendText=function(e,t){var n=e.nodes.text.value;n=n.replace(/\r?\n/g,"");if(!n.length){e.reset(),e.warnning();return}if(n.length>e.maxinput){h.DO.showError(e.maxinput_tip);return}n.trim()==""&&(n="　");var r=e._replyTo,i={content:n,isWhisper:e._whisper};r&&(i.replyTo=r.id,i.replyName=r.name,i.replyId=r.rid),e.fireEvent("send",{data:i})},this.replyTo=function(e,t){e._replyTo=t,e._whisper=!!t.whisper,e._wrapText()},this._wrapText=function(e){var t=e._replyTo;if(!t)return;var n=e.nodes.text,r=n.value;r=r.replace(/^回复.*：/,"");var i;e._whisper?(i="回复"+t.name+"(悄悄话)：",r=i+r):(i="回复"+t.name+"：",r=i+r),n.value=r,l.inputPosition(n)},this.disable=function(e){e._disabled=!0,e.nodes.text.disabled=!0},this.enable=function(e){e._disabled=!1,e.nodes.text.disabled=!1},this.focus=function(e){e.nodes.text.focus()},this.warnning=function(e){h.Effect.gradient(e.nodes.text,255,255,215,function(){e.nodes.text.style.backgroundColor="#fff"})}}),E=function(){var e=new h.ui.multiFriendSelector;return h.browser.IE6||(e.autoComplete.menu.onShow=function(){var e=this.menu.frame;e.style.top=parseInt(e.style.top)+l.getPageScroll().y+"px"}),u.addEvent(window,"scroll",function(t){e.autoComplete.frame.blur()}),e},S=new Class(r.UIcommon,function(){this.selector=null,this._fold=!0,this.initialize=function(e){e.frame=e.buildFrame()},this.buildFrame=function(e){var t=['<div class="wp-addchat-box" style="display:none">','	<div class="wp-addchat clearfix">','	<div class="wp-add-txt"></div>',"	</div>",'	<a href="#nogo" onclick="return false;" class="wp-addchat-btn">添加</a>',"</div>"].join(""),n=document.createElement("div");return n.innerHTML=t,n=a.getElement("div.wp-addchat-box",n),e.nodes={container:n.getElement("div.wp-add-txt"),sbtn:n.getElement("a")},n},this.newSelector=function(e){var t=E();e.selector=t;var n=e.nodes;n.container.appendChild(t.frame),n.sbtn.addEvent("click",function(){e.callback(t.getSelectedFriends())}),n.input=a.getElement("input",e.frame),n.container.addEvent("mouseup",function(){e.unfold()})},this.getSelectedFrds=function(e){return e.selector?e.selector.getSelectedFriends():[]},this.bindTrigger=function(e,t,n){t.addEvent("click",function(t){t.cancelBubble=!0,t.defaultPrevented=!0,e._fold?e.unfold():e.fold()}),e.callback=n},this.unfold=function(e){h.net.sendStats("http://message.renren.com/statistics/win/addfriend"),e.selector||e.newSelector(),e.frame.show(),e._fold=!1,e.nodes.input.focus()},this.fold=function(e){e.frame.hide(),e._fold=!0}}),x=new Class(S,function(){this.buildFrame=function(e){var t=['<div class="wp-addchat-box" style="display:none">','	<div class="wp-addchat clearfix">','	<div class="wp-add-txt"></div>',"	</div>",'	<a href="#nogo" onclick="return false;" class="wp-addchat-btn">添加</a>',"</div>"].join(""),n=document.createElement("div");return n.innerHTML=t,n=a.getElement("div.wp-addchat-box",n),e.nodes={container:n.getElement("div.wp-add-txt"),sbtn:n.getElement("a")},n}});t.TalkFlow=d,t.Inputer=w,t.IFeature_invite=S,t.IFeature_invite_set=x}),object.define("webpager/lib/uikit/common","../base, ../tools",function(e,t,n){var r=e("../base"),i=e("../tools"),s=r.dom,o=r.events,u=new Class(function(){this.__mixins__=[o.Events],this.frame=null,this.body=null,this.nodes={},this._on_render=[],this._hidden=!1,this.buildFrame=function(e,t,n){var t=t||"div",r=s.wrap(document.createElement(t));n&&(r.style.cssText=n);var o=e.makeFrameHTML();if(XN.browser.IE){var u=i.parseHTML(o);r.appendChild(u)}else r.innerHTML=o;return e.frame=r,r},this.makeFrameHTML=function(e){var t="";return t},this.show=function(e){e.frame.style.display="",e._hidden=!1},this.hide=function(e){e.frame.style.display="none",e._hidden=!0},this.getWidth=function(e){return e.body.offsetWidth},this.getHeight=function(e){return e.body.offsetHeight},this.setWidth=function(e,t){var n=t+"px";e.body?e.body.style.width=n:e.frame.style.width=n,e.fireEvent("resize",{width:t})},this.setHeight=function(e,t){var n=t+"px";e.body?e.body.style.height=n:e.frame.style.heigth=n,e.fireEvent("resize",{height:t})},this.destroy=function(e){var t=e.frame;t.parentNode&&t.parentNode.removeChild(t),t=null}}),a=new Class(function(){this.name="M",this.initialize=function(e){e.components={}},this._assemble=function(e,t,n){e.components[t]=n}}),f=new Class(function(){this.initialize=function(e){e._pool=[],e._container=null},this.append=function(e,t){e._pool.push(t),e._container.appendChild(t.frame)},this.rise=function(e,t){e._pool.push(t),e._pool.length,e._container.appendChild(t.frame)},this.riseBefore=function(e,t,n){e._container.insertBefore(t.frame,n.frame)},this.remove=function(e,t){return e._container.removeChild(t.frame),!0}});t.UIcommon=u,t.UIcomplex=a,t.UIcontainer=f}),object.define("webpager/lib/uikit/pager","../base, ./common",function(e,t,n){var r=e("../base"),i=e("./common"),s=r.dom,o=new Class(i.UIcommon,function(){this.__mixins__=[i.UIcontainer],this.initialize=function(e,t){e.frame=t,e._container=t}}),u=new Class(i.UIcommon,function(){this.__mixins__=[i.UIcontainer],this.initialize=function(e){var t=s.wrap(document.createElement("div"));t.addClass("panelbarpanels"),e.frame=t,e._container=t},this.setContent=function(e,t){e._container.innerHTML="",e.append(t),e.content=t},this.setWidth=function(e,t){this.parent(e,t),e.content&&e.content.setWidth(t)}});t.WebPager=o,t.PagerCase=u}),object.define("webpager/lib/uikit/window","./common, ../base, ../tools",function(e,t,n){var r=e("./common"),i=e("../base"),s=i.dom,o=e("../tools"),u=o.getLogger("window"),a=new Class(r.UIcommon,function(){this.__mixins__=[r.UIcomplex],this.name="A",this._fold=!0,this._highlight=!1,this.id,this.rebuild_message,this.initialize=function(e,t){u.log2("init Window");var n=e.buildFrame();n.addClass("popupwindow"),e.getUIRef(),e.bindEvent(),t&&e.applyConfig(t)},this.applyConfig=function(e,t,n){t.title&&e.setTitle(t.title),t.icon&&e.setIcon(t.icon),t.handler&&e.setHandler(t.handler),t.hlight&&e.highLight(n),t.fold&&(t.fold>0?e.fold(n):e.unfold(n)),t.no_xbtn&&(e.nodes.xbtn.hide(),e.nodes.xbtn2.hide()),t.max_msg_id&&(e.max_msg_id=t.max_msg_id)},this.getStat=function(e){var t={id:e.id,rebuild:e.rebuild_message,fold:e._fold?1:-1,hlight:e._highlight};return e.max_msg_id&&(t.max_msg_id=e.max_msg_id),t},this.makeFrameHTML=function(e){var t=['<div class="panelbarbutton" onselectstart="return false;">','	<a href="#nogo" onclick="return false;" class="wp-chat-close">关闭</a>','	<p class="" title="窗口名">窗口名</p>',"</div>",'<article class="chat-window"'+(XN.browser.IE6?'style="overflow-x:hidden;"':"")+">","	<header>","		<h4></h4>","		<menu>",'			<li title="最小化" label="最小化" class="minimize">最小化</li>','			<li title="关闭" class="close">关闭</li>',"		</menu>","	</header>",'	<section> <div class="dialog"></div> </section>',"</article>"].join("");return t},this.disable=function(e,t,n){var t=t||{},r=e.nodes.shade||document.createElement("div");return r.innerHTML="",r.style.display="block",r.style.position="absolute",r.style.width="100%",r.style.height="100%",t.opacity&&(r.style.opacity="0.7",r.style.filter="alpha(opacity=70)"),r.style.background=t.color||"#FFF",e.nodes.section.appendChild(r),n&&(r.innerHTML=n),XN.browser.IE6&&(r.style.height=e.getHeight()+"px",e.addEvent("resize",function(e){e.height&&(r.style.height=e.height+"px")})),e.nodes.shade=r,r},this.enable=function(e){e.nodes.shade.style.display="none"},this.getUIRef=function(e){var t=e.frame,n={bar:t.getElement("div.panelbarbutton"),handler:t.getElement("div.panelbarbutton p"),body:t.getElement("article"),title:t.getElement("h4"),header:t.getElement("header"),container:t.getElement("section>div.dialog"),section:t.getElement("section"),wmenu:t.getElement("header>menu")};n.xbtn=n.header.getElement("menu>li.close"),
n.xbtn2=t.getElement("a.wp-chat-close"),n.mbtn=n.header.getElement("menu>li.minimize"),e.body=n.body,e.nodes=n,e.panels={}},this.bindEvent=function(e){var t=e.nodes;t.bar.addEvent("click",function(t){e._fold?e.unfold(null,!0,!0,!0):e.fold()}),t.header.addEvent("click",function(t){if(t.target.tagName.toLowerCase()=="a")return;e.fold()}),t.body.addEvent("click",function(t){var t=s.wrap(t.target);(t.hasClass("close")||t.hasClass("wp-chat-close"))&&e.close();return}),t.xbtn2.addEvent("click",function(t){t.cancelBubble=!0,e.close()})},this.setTitle=function(e,t){e.nodes.title.innerHTML=t},this.setIcon=function(e,t){e.nodes.handler.addClass(t)},this.setHandler=function(e,t,n){var n=n||t,r=e.nodes.handler;r.innerHTML=t,r.title=n},this.message=function(e){e.fireEvent("message",{})},this.fold=function(e,t){XN.browser.IE6&&(e.frame.style.overflowX="hidden");if(e._fold)return;e.frame.removeClass("actived"),e._fold=!0,e.message(),e.fireEvent("unfocus"),t||e.fireEvent("fold",{data:1})},this.unfold=function(e,t,n,r){e.tag&&e.fireEvent("getRoomInfo",{}),r||e.fireEvent("toChatPanel",{});var i=!0;XN.browser.IE6&&(e.frame.style.overflowX=""),t&&(i=!1);if(!e._fold)return;e.frame.addClass("actived"),e._fold=!1,t||e.fireEvent("fold",{data:0}),e.fireEvent("focus",{focus:i}),e.highLight(-1)},this.show=function(e){e._fold||e.fireEvent("focus"),this.parent(e)},this.close=function(e,t){e.hide(),t||(e.fireEvent("close"),e._fold?XN.net.sendStats("http://message.renren.com/statistics/win/min"):XN.net.sendStats("http://message.renren.com/statistics/win/max")),e.fold(!0)},this.highLight=function(e,t){t?e._highlight&&(e._highlight=!1,e.frame.removeClass("wb-message-tip")):(e._highlight=!0,e.frame.addClass("wb-message-tip"))}}),f=new Class(a,{initialize:function(e){e.frame=document.createElement("div"),e.frame.style.display="none"}}),l=new Class(r.UIcommon,function(){this.__mixins__=[r.UIcontainer],this.windows={},this.order=[],this._placeholder=0,this._unfold_window=null,this._boundary=581,this._stack_left=[],this._stack_right=[],this._stack_left_num=0,this._stack_right_num=0,this.initialize=function(e){e.frame=e.buildFrame(),e.getUIRef(),e.bindEvent(),e._container=e.nodes.content},this.buildFrame=function(e){var t=s.wrap(document.createElement("div"));t.id="tasks-panel",t.addClass("panel");var n=['<div class="slide-box" style="display: none"><a href="#nogo" onclick="return false;" class="slide_left"></a></div> ','<div class="winslider"></div>','<div class="slide-box" style="display: none"><a href="#nogo" onclick="return false;" class="slide_right"></a></div>'].join("");return t.innerHTML=n,t},this.getUIRef=function(e){var t=e.frame,n={left:t.getElement("div.slide-box"),right:t.getElements("div.slide-box")[1],num_left:t.getElement("a.slide_left"),num_right:t.getElement("a.slide_right"),content:t.getElement("div.winslider")};e.body=n.content,e.nodes=n},this.bindEvent=function(e){var t=e.nodes;t.left.addEvent("click",function(){if(!e._stack_left.length)return;e.slideLeft()}),t.right.addEvent("click",function(){if(!e._stack_right.length)return;e.slideRight()})},this.getLength=function(e){return e.order.length-e._placeholder},this.isOverflow=function(e){if(!e.order.length)return!1;var t=parseInt(e._boundary/131),n=e.getLength();u.log2("Winslider/isOverflow: 当前窗口个数 "+n+"; 当前容器最大宽度 "+e._boundary+"; 可容纳窗口个数 "+t);var r=n-t;return r<=0?0:t},this.slideCheck=function(e){var t=e.isOverflow();if(t){e.show(),u.log2("Winslider/slideCheck: 发生overflow ",t);var n=0,r=e._stack_left.concat(e._stack_right),i=e.windows;for(var s=0;s<r.length;s++)i[r[s]]instanceof f&&n++;n=e.order.length-r.length-(e._placeholder-n)-t;if(n>0)while(n--)e.pushLeft();else{n=-n;while(n--)e.popLeft()||e.popRight()}}else e.hide(),e.popAll()},this.slideRight=function(e,t){if(!e._stack_right.length)return!1;e.pushLeft();var n=e.popRight();u.log2("viewer视窗向右滑动 ",e._stack_left,e._stack_right);if(!t){var r={lr:"right",target:"winslider_slide",to:n};e.fireEvent("changed",{data:r})}return n},this.slideLeft=function(e,t){if(!e._stack_left.length)return!1;e.pushRight();var n=e.popLeft();u.log2("viewer视窗向左滑动 ",e._stack_left,e._stack_right);if(!t){var r={lr:"left",target:"winslider_slide",to:n};e.fireEvent("changed",{data:r})}return n},this.pushLeft=function(e){var t;do{var n=e.order[e._stack_left.length];e._stack_left.push(n),t=e.windows[n]}while(t instanceof f);return t.hide(),e.updateStackNum("left",1),n},this.pushRight=function(e){var t,n;do{n=e.order.length;var r=e.order[n-e._stack_right.length-1];e._stack_right.push(r),t=e.windows[r]}while(t instanceof f);return t.hide(),e.updateStackNum("right",1),r},this.popRight=function(e){var t;do{var n=e._stack_right.pop();if(!n)return!1;t=e.windows[n]}while(t instanceof f);return t.show(),e.updateStackNum("right",-1),n},this.popLeft=function(e){var t;do{var n=e._stack_left.pop();if(!n)return!1;t=e.windows[n]}while(t instanceof f);return t.show(),e.updateStackNum("left",-1),n},this.updateStackNum=function(e,t,n){var n=e["_stack_"+t+"_num"]+=n;e.nodes["num_"+t].innerHTML=n},this.isInStack=function(e,t){var n=!1;for(var r=0;r<e._stack_left.length;r++)if(e._stack_left[r]==t)return"left";for(r=0;r<e._stack_right.length;r++)if(e._stack_right[r]==t)return"right";return!1},this.popAll=function(e){if(e._stack_left.length)while(e.popLeft());if(e._stack_right.length)while(e.popRight());},this.slideTo=function(e,t,n){var r,i;n=="left"?r=e.slideLeft:r=e.slideRight;while(i=r.call(e,!0))if(i==t||!i)break},this.foldAll=function(e,t){var n=!!t,r=e._unfold_window;r&&r!=t&&e.windows[r]&&e.windows[r].fold(n),e._unfold_window=t||!1,e.fireEvent("foldAll")},this.appendWindow=function(e,t,n,r){var n=t.id;if(e.windows[n]){var i=e.windows[n];if(i instanceof f){var s=i.stat;e.windows[n]=t,s.fold<0&&e.foldAll(n),t.applyConfig(s),e.riseBefore(t,i),e._placeholder--;var o=e.isInStack(n);o&&(t.hide(),e.updateStackNum(o,1))}else u.err(new Error("你怎么复写了一个窗口呢!!!! "+n));e.remove(i)}else e._stack_right.length&&(e._stack_right.unshift(n),t.hide(),e.updateStackNum("right",1)),e.append(t),e.order.push(n);e.windows[n]=t,e.slideCheck(),e.fireEvent("append"),setTimeout(function(){e.fireEvent("changed")});if(r)return;t.addEvent("fold",function(t){u.log2("窗口折叠/展开: ",t.data);var r=[];t.data?r.push({act:"fold",target:n}):r.push({act:"unfold",target:n}),r.length&&e.fireEvent("changed",{data:r})}),t.addEvent("message",function(){e.fireEvent("changed",{})}),t.addEvent("focus",function(r){e.foldAll(n);var i=e.isInStack(t.id);i&&e.slideTo(t.id,i),e.fireEvent("focus")}),t.addEvent("close",function(r){e.removeWindow(t);var i={act:"close",target:n};e.fireEvent("changed",{data:i})})},this.addPlaceholder=function(e,t){var n=new f;n.id=t.id,n.stat=t,e.windows[t.id]=n,e.append(n),e.order.push(t.id),e._placeholder++},this.applyChange=function(e,t){var t=[].concat(t);u.log2("winslider正在applyChange: ",t),t.forEach(function(t){if(t.target=="winslider")e._unfold_window=t.stat._unfold_window;else if(t.target=="winslider_slide")e.isInStack(t.to)==t.lr&&e.slideTo(t.to,t.lr);else{var n=e.windows[t.target];if(!n)return;n[t.act](!0),t.act=="close"&&e.removeWindow(n)}})},this.removeWindow=function(e,t){var n=t.id,r=e.order.indexOf(n);e.order.splice(r,1),delete e.windows[n],e.remove(t);var i=e.isInStack(n);i&&e.updateStackNum(i,-1),e.slideCheck(-1),e.fireEvent("remove",{data:n,rest:e.getLength()})},this.getStats=function(e){var t={};return e.getOrder().forEach(function(n){t[n]=e.windows[n].getStat()}),t.left=e._stack_left.length,t.right=e._stack_right.length,t},this.setWidth=function(e,t){var t=t-60;u.log2("设置winslider宽度 ",t),e._boundary=t,e.slideCheck(0)},this.show=function(e){var t=e.nodes;e.updateStackNum("left",0),e.updateStackNum("right",0),t.left.show(),t.right.show()},this.hide=function(e){var t=e.nodes;t.left.hide(),t.right.hide()},this.getOrder=function(e){return e.order}}),c=new Class(a,function(){this.name="B",this.makeFrameHTML=function(e){u.log2("init Drawer_Window");var t=['<div class="panelbarbutton">','	<a href="#nogo" onclick="return false;" class="wp-chat-close">关闭</a>','	<p class="" title="窗口名">窗口名</p>',"</div>",'<article class="chat-window"'+(XN.browser.IE6?'style="overflow-x:hidden;"':"")+">","	<header>","		<h4> </h4>","		<menu>",'			<li title="最小化" label="最小化" class="minimize">最小化</li>','			<li title="关闭" class="close">关闭</li>',"		</menu>","	</header>",'	<section> <div class="dialog with-topic"></div> ','	<article class="topic-box"> </article></section>',"</article>"].join("");return t},this.getUIRef=function(e){this.parent(e),e.nodes.drawer=e.frame.getElement("section>article.topic-box")},this.addExitBtn=function(e){var t=e.nodes,n=s.getDom('<li class="wp-quit" title="嫌他们烦,可以退出讨论">退出</li>');t.wmenu.insertBefore(n,t.mbtn),n=s.getElement("li.wp-quit",t.wmenu),n.addEvent("click",function(t){t.cancelBubble=!0,e.fireEvent("exit")})}});t.WinSlider=l,t.Window=a,t.WindowWithDrawer=c}),object.define("webpager/lib/emoticons","./base",function(e,t,n){var r=e("./base");(function(){function e(){this._cache={}}function n(e){var t=function(t){return this instanceof arguments.callee?(this.config={},$extend(this.config,e),this.ID=XN.util.createObjID(),$extend(this.config,t),this.init()):new arguments.callee(t)};return $extend(t.prototype,{name:"",init:function(){},getConfig:function(e){return this.config[e]},setConfig:function(e,t){return this.config[e]=t,this},getId:function(e){return this.name+"_"+this.ID+"_"+e},getEl:function(e){return $(this.getId(e))}}),t}function i(e){var t=!1,n=$extend({},e),r=null,i;return e.waitTime&&e.onTimeout&&(t=!0,n.onSuccess=function(t){window.clearTimeout(i),e.onSuccess(t)},n.onError=function(t){window.clearTimeout(i),e.onError(t)},i=setTimeout(function(){e.onTimeout.call(r);try{r.abort()}catch(t){XN.log(t)}},e.waitTime)),r=new XN.net.xmlhttp(n),r}e.prototype={add:function(e,t){this._cache[e]=t},del:function(e){return delete this._cache[e],null},get:function(e){return this._cache[e]}};var t=function(e){var t=Object.prototype.toString.call(e).replace(/\[object ([^\]]*)\]/,"$1").toLowerCase();return t.indexOf("html")!=-1&&(t="element"),t},s=new e,o=new e;XN.ui.emotions=n({url:"http://status."+XN.env.domain+"/getubblist.do?type=1&t="+Math.random(),container:"",isShowVipEmos:!1,emoKind:{0:{name:"默认表情",forvip:0,active:1},1:{name:"阿狸",forvip:1},2:{name:"囧囧熊",forvip:1}},onParseEmo:function(e,t){XN.log(e)}}),$extend(XN.ui.emotions.prototype,{name:"emotions",emoList:[],init:function(){return this.getConfig("container").getAttribute("emo_obj_id")?o.get(this.getConfig("container").getAttribute("emo_obj_id")):(this.getEmotions(),this)},getEmotions:function(){var e=this,t=this.getConfig("url"),n=function(){XN.DO.showError("获取表情列表失败，请稍候重试")};if(s.get(t)&&s.get(t).ubbList&&s.get(t).ubbList.length>0)return e.buildPanelHtml(),!1;new i({url:t,method:"GET",onSuccess:function(n){window.setTimeout(function(){s.add(t,n.responseText),e.buildPanelHtml()},0)},onError:n,waitTime:5e3,onTimeout:n})},formatData:function(e){var t=$extend({},this.getConfig("emoKind")),n;for(var r in t)t[r].data=[];for(var i=0,s=e.length;i<s;i++)n=e[i],t[n.kind].data.push(n);for(var r in t)t[r].data.length||delete t[r];return t},getSingleEmoHtml:function(e,t){var n=XN.browser.IE6?" onmouseover=\"this.style.borderColor='#808080'\" onmouseout=\"this.style.borderColor='#B8D4E8'\"":"",r='<li title={{alt}} {{_ie6patch}}><img emosrc="http://a.xnimg.cn{{src}}" alt="{{alt}}" emotion="{{ubb}}" preview="{{preview}}" forvip="{{forvip}}" /></li>';e.preview=e.size==2?1:0,e.forvip=t.forvip?1:0,e._ie6patch=XN.browser.IE6?n:"";for(var i in e)r=r.replace(new RegExp("{{"+i+"}}","g"),e[i]);return r},buildPanelHtml:function(){var e=XN.json.parse(s.get(this.getConfig("url")));e.emoKind&&(this.emoKind=e.emoKind),this.emoList=this.formatData(e.ubbList),this.config.isShowVipEmos=e.canParseVipEmos;var t=this.emoList,n=0,r=this,i=[],o=this.getConfig("emoKind"),u=[],a=[],f=0,l=null;for(var c in t){l=t[c],u.push('<ul class="emo-list" style="display:'+(l.active?"block":"none")+'" id="'+this.getId("emoList"+c)+'">'),f=0;while(l.data[f])u.push(this.getSingleEmoHtml(l.data[f],l)),f++;u.push("</ul>"),a.push('<li id="'+this.getId("emoTab"+c)+'"><a href="#nogo" onclick="return false;" onfocus="this.blur()"> '+l.name+" </a></li>")}var h=['<div class="m-editor-emo-holder" id="'+this.getId("emoHolder")+'" style="padding:1px">','<div class="emo-header" id="'+this.getId("emoTabHolder")+'" style="display:none">','<ul class="emo-tab" id="'+this.getId("emoTab")+'">',a.join(""),"</ul>",'<div class="emo-tab-switch" id="'+this.getId("emoTabSwitch")+'" style="display:none">','<a href="#nogo" onclick="return false;" title="前一组表情" class="left" id="'+this.getId("movLeft")+'" ><span ></span></a>','<a href="#nogo" onclick="return false;" title="后一组表情" class="right" id="'+this.getId("movRight")+'" ><span ></span></a>',"</div>","</div>",'<div class="emo-holder" id="'+this.getId("emoList")+'">',u.join(""),"</div>",'<div class="notVip-tip clearfix" id="'+this.getId("notVipTip")+'" style="display:none;">','<div class="emotion-icon">','   <img src="http://xnimg.cn/imgpro/icons/grade/cjbq.png"  />',"	<p>超级表情</p>","</div>",'<p>对不起，该功能需要<span class="red">等级9级以上</span>或者<span class="red">开通VIP</span>才可以使用。</p>','	<p class="btn">','	<a href="http://i.renren.com/pay/pre?wc=370000" class="join-vip" target="_blank"></a>','	<a href="http://sc.renren.com/scores/myscore" class="lookup-class" target="_blank"></a>或',"</p>","</div>","</div>"].join("");this.getConfig("container").setContent(h),this.cacheEls(),this.showFirstGroupEmos(),setTimeout(function(){r.renderTabs(),r.fireEvent("renderEmotions")},0)},renderTabs:function(){var e=0,t=this.tabView=new XN.ui.tabView({activeClass:"current"}),n="",r=this;for(var i in this.emoList)t.addTab({label:r.getId("emoTab"+i),active:r.emoList[i].active,onActive:function(e){return function(){var n=t.getCurrentTab().label.id||t.getCurrentTab().label,i=$(r.getId("emoList"+e));i.show(),r.emoList.imgRended||(i.innerHTML=i.innerHTML.replace(/emosrc/g,"src"),r.emoList[e].imgRended=!0),$(n.replace("emoTab","emoList")).hide(),r._previewHolder&&r._previewHolder.hide(),r.hideNotVip(),r.fireEvent("tabSwitch",$(r.getId("emoTab"+e)),$(r.getId("emoList"+e)))}}(i),onClick:function(e){return function(){r.fireEvent("tabClick",$(r.getId("emoTab"+e)),$(r.getId("emoList"+e)))}}(i)}),e++;this.uiEmoTabHolder[e>1?"show":"hide"](),e>0&&this.initTabSwitcher()},initTabSwitcher:function(){var e=!1,t=this;this.emoHolderInitX=this.getEl("emoTabHolder").realLeft(),this.emoHolderWidth=this.getEl("emoTabHolder").offsetWidth,this.emoHolderMaxX=this.emoHolderInitX+this.emoHolderWidth;for(var n in this.emoList)e||(e=this.getEl("emoTab"+n).realLeft()+this.getEl("emoTab"+n).offsetWidth>this.emoHolderMaxX?!0:!1);if(!e)return!1;this.getEl("emoTabSwitch").show(),this.tabArray=[],this.curTab=0;for(var n in t.emoList)this.tabArray.push(n);r.addEvent(t.getEl("movLeft"),"click",function(){t.curTab=--t.curTab<=0?0:t.curTab,t.moveTab(t.tabArray[t.curTab],t.curTab,t.tabArray)}),r.addEvent(t.getEl("movRight"),"click",function(){t.curTab=++t.curTab==t.tabArray.length?t.tabArray.length-1:t.curTab,t.moveTab(t.tabArray[t.curTab],t.curTab,t.tabArray)})},moveTab:function(e,t,n){var r=this.getEl("emoTab"+e).realLeft(),i=this.getEl("emoTab"+e).offsetWidth,s=0;t>0&&($(this.getEl("movLeft").getElementsByTagName("span")[0]).style.borderRightColor="#B8D4E8"),t==0&&($(this.getEl("movLeft").getElementsByTagName("span")[0]).style.borderRightColor="#CCC"),t==n.length-1&&($(this.getEl("movRight").getElementsByTagName("span")[0]).style.borderLeftColor="#CCC"),t<n.length-1&&($(this.getEl("movRight").getElementsByTagName("span")[0]).style.borderLeftColor="#B8D4E8"),s=this.emoHolderInitX-r,this.uiEmoTab.style.left=parseInt(XN.element.getStyle(this.uiEmoTab,"left"))+s+"px"},initEvent:function(){var e=this;r.addEvent(this.uiEmoHolder,"click",function(t){var n=t||window.event;e.parseEmotion(n),n.cancelBubbled?n.cancelBubbled=!0:n.stopPropagation()}),r.addEvent(this.uiEmoHolder,"mouseover",function(t){XN.event.stop(t||window.event),e.previewEmotion(t)}),r.addEvent(this.uiEmoHolder,"mouseout",function(t){e.hidePreviewEmotion(t)})},parseEmotion:function(e){var t=XN.event.element(e),n=this,r=t.tagName.toLowerCase();this.fireEvent("emoConClick");if(!/li|img/.test(r))return!1;r=="li"&&(t=t.getElementsByTagName("img")[0]);if(!t)return!1;var i=parseInt(t.getAttribute("forvip")),s=t.getAttribute("emotion"),o=this.getConfig("isShowVipEmos");i&&!o?n.showNotVip(e):n.getConfig("onParseEmo").call(n,{imgsrc:t.src,ubb:s,forvip:i},e)},hide:function(){this.uiEmoHolder.hide(),this._previewHolder&&this._previewHolder.hide()},cacheEls:function(){this.uiEmoList=this.getEl("emoList"),this.uiEmoHolder=this.getEl("emoHolder"),this.uiEmoTabHolder=this.getEl("emoTabHolder"),this.uiEmoTab=this.getEl("emoTab"),this.uiNotVipTip=this.getEl("notVipTip")},showFirstGroupEmos:function(){var e=this,t;for(var n in this.emoList)this.emoList[n].active&&(t=$(e.getId("emoList"+n)),t.innerHTML=t.innerHTML.replace(/emosrc/g,"src"));return this.uiEmoHolder.show(),this.initEvent(),!0},hideEmotion:function(){this._previewHolder&&this._previewHolder.hide(),this._emoHolder&&this._emoHolder.hide()},showNotVip:function(e){XN.event.stop(e||window.event),this.uiEmoList.hide(),this.uiNotVipTip.show(),this._previewHolder&&this._previewHolder.hide(),this.fireEvent("showNotVip")},hideNotVip:function(e){this.uiNotVipTip.hide(),this.uiEmoList.show()},previewEmotion:function(e){var t=XN.event.element(e),n=this,i=t.tagName.toLowerCase();i=="li"&&(t=t.getElementsByTagName("img")[0]);if(i!="li"&&i!="img")return this._previewHolder&&this._previewHolder.hide(),!1;if(!t)return!1;var s=parseInt(t.getAttribute("preview"));if(s){if(!this._previewHolder){var o=this._previewHolder=new XN.ui.fixPositionElement({alignWith:this.uiEmoList,tagName:"div",alignType:"2-2",offsetX:XN.browser.IE6?-1:XN.browser.IE?1:0,offsetY:XN.browser.IE?1:0});o.container.setStyle("background:#fff;padding:1px;width:50px;height:50px;border:1px solid #B8D4E8;"),o.container.className="meditor-emo-preview",o.container.id=this.getId("mEditorPreviewHolder"),o.setContent('<img id="'+this.getId("previewIMG")+'" class="m-editor-preview-img" src="'+t.src+'" />'),r.addEvent(this.getEl("mEditorPreviewHolder"),"mouseover",function(){var e=o.alignType=="1-1"?"2-2":"1-1";if(XN.browser.IE6){var t=o.alignType=="1-1"?-1:1;o.setOffsetX(t)}o.setAlignType(e)})}this.getEl("previewIMG").src=t.src,this._previewHolder.show()}},hidePreviewEmotion:function(e){el=XN.event.element(e),el.tagName.toLowerCase()=="ul"&&this._previewHolder&&this._previewHolder.hide()}}),XN.event.enableCustomEvent(XN.ui.emotions.prototype),XN.ui.quickSwfupload=n({uploadUrl:"http://upload."+XN.env.domain+"/uploadservice.fcgi?pagetype=gossipAddPhoto&societyguester="+XN.cookie.get("societyguester")+"&hostid="+XN.cookie.get("id")+"&t="+XN.cookie.get("t"),swfPath:"http://s.xnimg.cn/jspro/swfupload.v2.2.0.1/swfupload.swf",replaceElId:null,onUploadSuccess:function(e){XN.log(e)},onUploadProgress:function(e,t,n){XN.log(e,t,n)},buttonTxt:null,buttonWidth:null,buttonHeight:null,buttonStyle:".text {text-align:left;color:#005EAC;font-family:tahoma,simsun;font-size:12px;font-family:Tahoma,Verdana,simsun,sans-serif;}"}),$extend(XN.ui.quickSwfupload.prototype,{name:"miniUpload",init:function(){return $(this.getConfig("replaceElId"))?window.SWFUpload?(this.getConfig("buttonTxt")||(this.config.buttonTxt=$(this.getConfig("replaceElId")).innerHTML),this.getConfig("buttonWidth")||(this.config.buttonWidth=$(this.getConfig("replaceElId")).offsetWidth),this.getConfig("buttonHeight")||(this.config.buttonHeight=$(this.getConfig("replaceElId")).offsetHeight),this.renderUI(),this):(XN.log("依赖的swfupload.js没有引入"),!1):(XN.log("必须传入一个被flash替换的元素"),!1)},renderUI:function(){var e=this;this.uploader=new SWFUpload({upload_url:e.getConfig("uploadUrl"),flash_url:e.getConfig("swfPath"),file_size_limit:"10 MB",file_types:"*.jpg;*.jpeg;*.png;*.bmp;*.gif",file_types_description:"All Image Files",file_upload_limit:60,file_queue_limit:0,debug:!1,button_placeholder_id:e.getConfig("replaceElId"),button_cursor:SWFUpload.CURSOR.HAND,button_width:e.getConfig("buttonWidth"),button_height:e.getConfig("buttonHeight"),button_image_url:"http://a.xnimg.cn/a.gif",button_text:e.getConfig("buttonTxt"),button_text_style:e.getConfig("buttonStyle"),button_text_top_padding:2,button_action:SWFUpload.BUTTON_ACTION.SELECT_FILE,button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,file_queued_handler:function(){this.startUpload()},upload_error_handler:function(e,t,n){XN.DO.showError(n+""+t+""+e)},upload_progress_handler:function(t,n,r){e.getConfig("onUploadProgress").call(e,t,n,r)},upload_success_handler:function(t,n){var r=XN.json.parse(n);$extend(r,{file:t}),e.getConfig("onUploadSuccess").call(e,r)}})}});var u=new e;getEmoticonsInstance=function(e){return u.get(e)},XN.ui.emoticons=n({input:null,button:null,atButton:null,isShowVipEmos:!1,showAddPhoto:!1,keepShow:!1,hideEmoBtn:!1,emoBtnDes:"表情",emoPopDelay:0,emoPopFixed:!1,btnAlignWith:null,btnAlignType:"3-2",btnOffsetX:0,btnOffsetY:-1,onShowEmoPop:XN.func.empty,onEmoTabSwitch:XN.func.empty,onEmoTabClick:XN.func.empty,onEmoConClick:XN.func.empty,onEmoNotVip:XN.func.empty}),$extend(XN.ui.emoticons.prototype,{name:"miniEditor",pos:{},init:function(){return $(this.getConfig("input"))?this.getConfig("input").getAttribute("eicons_obj_id")?u.get(this.getConfig("input").getAttribute("eicons_obj_id")):(this.setConfig("emoTrigger",[]),this.input=$(this.getConfig("input")),this.initEvent(),this.initEmotions(),this.getConfig("showAddPhoto")&&this.initQuickSwfupload(),this.getConfig("atBtn")&&this.initMentionBtn(),this.input.setAttribute("eicons_obj_id",this.ID),u.add(this.ID,this),this):(XN.log("必须传入要赋值的input"),!1)},initEvent:function(){var e=this.input,t=this.getInputPos.bind(this);r.addEvent(e,"keyup",t),XN.browser.WebKit?r.addEvent(e,"blur",t):r.addEvent(e,"focus",t),r.addEvent(e,"mouseup",t),XN.dom.ready(t)},initEmotions:function(){var e=this;this.emotionsContainer=new XN.ui.fixPositionElement({alignWith:e.getConfig("btnAlignWith")||e.input,tagName:"div",alignType:e.getConfig("btnAlignType"),offsetX:e.getConfig("btnOffsetX"),offsetY:e.getConfig("btnOffsetY")}),this.emotionsContainer.frame.style.width="338px",this.emotionsContainer.container.addClass("m-editor"),this.emotionsContainer.hide(),this.getConfig("emoPopFixed")&&(XN.browser.IE6?(this.emotionsContainer.frame.style.position="absolute",r.addEvent(window,"scroll",function(t){e.hideEmoPop()})):this.emotionsContainer.frame.style.position="fixed"),setTimeout(function(){e.initEmoEvents()},0)},hideEmoPop:function(){this.emotionsContainer.hide(),this.emotions&&this.emotions._previewHolder&&this.emotions._previewHolder.hide(),this.showEmoBtn(!0),this.fireEvent("hideEmoticons")},showEmoPop:function(e){var t=this,n=function(){setTimeout(function(){this.showEmoBtn(!1),this.emotionsContainer.show(),this.fireEvent("showEmoticons"),this.getConfig("onShowEmoPop").bind(this)()}.bind(this),this.getConfig("emoPopDelay"))}.bind(this),r=function(){this.getConfig("onEmoTabSwitch").bind(this)()}.bind(this);scProxy=function(){this.getConfig("onEmoTabClick").bind(this)()}.bind(this),sVipProxy=function(){this.getConfig("onEmoNotVip").bind(this)()}.bind(this),sECProxy=function(){this.getConfig("onEmoConClick").bind(this)()}.bind(this);if(!this.emotions){var t=this,i={container:t.emotionsContainer.container,isShowVipEmos:t.getConfig("isShowVipEmos"),onParseEmo:function(e,n){t.setValue(e.ubb),!n.ctrlKey&&!t.getConfig("keepShow")&&t.hideEmoPop()}};$extend(i,this.getConfig("url")?{url:t.getConfig("url")}:{}),this.emotions=new XN.ui.emotions(i),this.emotions.addEvent("renderEmotions",n),this.emotions.addEvent("tabSwitch",r),this.emotions.addEvent("tabClick",scProxy),this.emotions.addEvent("showNotVip",sVipProxy),this.emotions.addEvent("emoConClick",sECProxy)}else n();XN.event.stop(e||window.event)},showEmoBtn:function(e){if(this.getConfig("hideEmoBtn"))return!1;this.getEl("emoBtn")&&this.getEl("emoBtn")[e===!0?"show":"hide"]()},initEmoEvents:function(){var e=this,n=this.showEmoPop.bind(this);this.getConfig("button")&&this.getConfig("emoTrigger").push({el:e.getConfig("button"),evt:"click"}),XN.array.each(this.getConfig("emoTrigger"),function(e,i){if(t(i)==="string"){var s=i.split(":");i={el:s[0],evt:s[1]}}i.evt.toLowerCase()=="focus"&&(i.evt="click"),r.addEvent(i.el,i.evt,n)}),r.addEvent(document,"click",this.hideEmoPop.bind(this)),this.input.mention&&this.input.mention.addEvent("refocus",function(){e.getInputPos()})},initQuickSwfupload:function(){},initMentionBtn:function(){var e=this;r.addEvent(this.getConfig("atBtn"),"click",function(){var t="@",n=XN.form.help(e.input).getRealValue();n.slice(e.pos.start-1,e.pos.start)=="@"&&(t=""),e.setValue(t),setTimeout(function(){e.input.mention&&e.input.mention.check(),e.input.mention.addEvent("refocus",function(){e.getInputPos()})},0)})},pos:{},getInputPos:function(e){try{this.pos=XN.form.help(this.input).cursorPosition()}catch(t){this.pos={start:0,end:0,item:[0,0]},XN.log(t)}},setValue:function(e){var t=this.input,n=this,r=XN.form.help(t).getRealValue();t.value=r.slice(0,n.pos.start)+e+r.slice(n.pos.end),XN.form.help(t).focus(n.pos.start+e.length),XN.browser.WebKit?window.setTimeout(function(){n.getInputPos()},0):n.getInputPos()},fireFocus:function(){if(document.createEvent){var e=document.createEvent("MouseEvents");e.initEvent("click",!0,!1),this.input.dispatchEvent(e)}else this.input.fireEvent("onfocus")}}),XN.event.enableCustomEvent(XN.ui.emoticons.prototype)})(),t.emoticons=XN.ui.emoticons}),object.define("webpager/lib/channel_api","./base",function(e,t,n){var r=e("./base"),i=window.webpager,s={getWpiCookie:function(e){return window.imengine.imHelper.getCookie(e)},setWpiCookie:function(e,t,n,r){var i=this;this.cookieTimer&&clearTimeout(this.cookieTimer);var s=function(){window.imengine.imHelper.setCookie(e,t,n),i.preModelStatus=t};r?s():this.cookieTimer=setTimeout(function(){s()},50)},storageSet:function(e,t){return window.webpager.setItem.apply(window.webpager,arguments)},storageGet:function(e){return window.webpager.getItem.apply(window.webpager,arguments)}},o={isOnline:!1,connConf:1,init:function(){this.connTry=new XN.webpager.tryer,this.disconnTry=new XN.webpager.tryer,s.getWpiCookie("c")===0&&this.disConnect(),this.bindEvent()},bindEvent:function(){var e=this;s.addEvent("persist_conn_dif",function(t){t?e.fireEvent("mgr_connected"):(i.isLocalConnect()&&e.disConnect(),e.fireEvent("mgr_disConnected"))}),this.connTry.addEvent("tryer_timeout",function(){e.connectFaild()}),this.connTry.addEvent("tryer_sus",function(){e.fireEvent("mgr_connected")}),this.disconnTry.addEvent("tryer_sus",function(){e.fireEvent("mgr_disConnected")})},isLocalConnect:function(){return i.isLocalConnect()},connect:function(){var e=this;this.isOnline=!0,this.fireEvent("mgr_connecting"),i.enableConn(!0),this.connTry.tryAWhile(1e3,2e4,function(){logger.log1("连接状态: "+i.getConnState());if(i.getConnState())return e.saveConn(!0),!0})},disConnect:function(e){var t=this;this.isOnline=!1,i.enableConn(!1),this.disconnTry.tryAWhile(1e3,2e4,function(){logger.log1("连接状态: "+i.getConnState());if(!i.getConnState())return e!==!1&&t.saveConn(!1),!0})},saveConn:function(e){this.connConf=e,s.savethis("c",e?1:0)},getConnState:function(){return i.getConnState()},connectFaild:function(){this.isOnline=!1,this.fireEvent("mgr_connectFaild")}};XN.event.enableCustomEvent(o),t.connectMgr=o,t.persistMgr=s,t.playSound=function(){window.imengine.imHelper.playSound()},t.imengine=window.imengine}),object.define("webpager/lib/voice","./base, ./tools",function(e,t,n){function d(){var e=l.getAttribute("time");l.className="voice",l.innerHTML="<var>"+e+'</var><sub>"</sub>',l.title="点击播放语音"}var r=e("./base"),i=r.XN,s=r.readly,o=r.dom,u=o.getElement("#bottombar"),a=document.createElement("span");voice_decode_obj=document.createElement("span"),a.id="voice_encode_obj",voice_decode_obj.id="voice_decode_obj",u.appendChild(a),document.getElementsByTagName("html")[0].appendChild(voice_decode_obj);var f=null,l=null,c=null,h=null,p=0;t.loadEncodeSwf=function(){t.getTicket(function(e){i.loadFile("http://s.xnimg.cn/n/lib/swfobject-2.2/swfobject.js",function(){var t={wmode:"transparent",allowscriptaccess:"always"},n={userId:i.user.id,userTick:e};swfobject.embedSWF("http://s.xnimg.cn/apps/session/res/swf/encode-voice.swf?v=48","voice_encode_obj","320","160","10.0.0","",n,t)})})},t.getTicket=function(e){new i.net.xmlhttp({url:"http://message.renren.com/message/ticket/voice",method:"get",onSuccess:function(n){e.call(t,n.responseText)}})},t.checkMicro=function(e){window.setTimeout(function(){c.style.visibility="visible",c.isSuportMic()?(p=0,e.onVoiceStart(c),c.startRecording()):e.noneMicroTip()},0)},t.sendOgg=function(){c.sendOgg()},t.prepVoice=function(e,n){if(f){if(window.confirm("正在录音是否取消?")){cancelVoice();return}return}!c||p?n.onVoiceLoading():t.checkMicro(n),f=n,t.cur_obj=f,window.cancelVoice=function(e){e&&(p=1),c.style.visibility="hidden",f=null,t.cur_obj=null,t.pauseCurPlay()},window.sendVoice=function(e,r){c.style.visibility="hidden",n.onVoiceFinished(e,r),f=null,t.cur_obj=null},window.loadEncodeSwfSuc=function(){setTimeout(function(){o.getElement(".wp-voice-prep",f.frame).dispose(),c=document.getElementById("voice_encode_obj"),t.checkMicro(f)},0)},window.allowDevice=function(){setTimeout(function(){c.style.height="66px",c.style.overflow="hidden"},10)}},t.loadDecodeSwf=function(){i.loadFile("http://s.xnimg.cn/n/lib/swfobject-2.2/swfobject.js",function(){var e={wmode:"transparent",allowscriptaccess:"always"};swfobject.embedSWF("http://s.xnimg.cn/apps/session/res/swf/decode-voice.swf?v=7","voice_decode_obj","1","1","10.0.0","","",e)})},t.playVoice=function(e){if(!h){l=e,t.loadDecodeSwf();return}l&&l.getAttribute("path")!=e.getAttribute("path")&&t.pauseCurPlay(),l=e,e.className="play",e.innerHTML="",e.title="点击暂停播放",setTimeout(function(){h.voicePlay(e.getAttribute("path"))},0)},t.completePlay=function(){d(),l=null},t.pauseCurPlay=function(){if(!l)return;d(),h.voicePlay(l.getAttribute("path"))},t.prepPlay=function(){window.loadDecodeSwfSuc=function(){h=document.getElementById("voice_decode_obj"),t.playVoice(l)},window.playFinish=function(){t.completePlay()}}}),object.define("webpager/FriendSelect","webpager/lib/base, webpager/lib/tools",function(e,t,n){var r=e("webpager/lib/base"),i=r.dom,s=e("webpager/lib/tools");t.FriendSelect=new Class(function(){this.__mixins__=[r.events.Events],this.initialize=function(e,t){e.url="http://friend."+XN.env.domain+"/friendsSelector.do",e.p={init:!0,uid:!0,uhead:!0,uname:!0,page:"",query:"",param:{}},e.p2=encodeURIComponent(JSON.stringify(e.p)),e.friendList=null,e.allFriends=null,e.query=null,e.onChangeInterval=null,e.delayInterval=500,e.searcher=null,e.memberList=[],e.memberName=[],e.Memberlen=0,e.buildFrame(t)},this.clear=function(e){jxn(".wp-friend-slider .member").remove(),jxn(".wp-friend-list .selected").removeClass("selected"),e.members&&e.members.wrap.css("margin-left",0),e.prevBtn&&e.prevBtn.addClass("disabled"),e.nextBtn&&e.nextBtn.addClass("disabled"),e.confirmBtn&&e.confirmBtn.addClass("wp-friend-confirm-disable"),e.memberList=[],e.memberName=[],e.searcher&&e.searcher.val(""),e.resetList()},this.enableBtn=function(e){e.confirmBtn&&e.confirmBtn.removeClass("wp-friend-confirm-disable")},this.disableBtn=function(e){e.confirmBtn&&e.confirmBtn.addClass("wp-friend-confirm-disable")},this.resetList=function(e){e.initFriendList(e.p2)},this.buildFrame=function(e,t){var n=['<div id="wp-friend-select">','	<div class="wp-friend-search">','		<input type="text" value="" class="wp-friend-input">',"	</div>",'	<div class="wp-friend-list">','		<ul class="list">',"			<li>加载中...</li>","		</ul>","	</div>",'	<div class="wp-friend-footer">','		<div class="wp-friend-slider">','			<span class="wp-friend-slider-prev disabled"> < </span>','			<span class="wp-friend-slider-next disabled"> > </span>','			<div class="list-wrap"><ul class="clearfix">','			<li class="last"></li></ul></div>',"		</div>",'		<a href="#nogo" onclick="return false;" class="wp-friend-confirm wp-friend-confirm-disable btn">确定</a>',"	</div>","</div>"].join("");jxn(t).append(jxn(n)),setTimeout(function(){e.friendList=jxn(".wp-friend-list .list"),e.searcher=jxn(".wp-friend-input"),e.confirmBtn=jxn(".wp-friend-confirm"),e.members={wrap:jxn(".wp-friend-footer .list-wrap ul"),lastItem:jxn(".wp-friend-footer .list-wrap .last")},e.prevBtn=jxn(".wp-friend-slider-prev"),e.nextBtn=jxn(".wp-friend-slider-next"),e.initFriendList(),e.bindEvent()},0)},this.initFriendList=function(e,t){t||(t=encodeURIComponent(JSON.stringify(e.p))),new XN.NET.xmlhttp({url:e.url,method:"post",useCache:!0,data:"p="+t,onSuccess:function(t){t=JSON
.parse(t.responseText),e.firstQuery||(e.firstQuery=!0,t.candidate.length==0&&(e.noFriends=!0)),e.allFriends=e.buildList(t),jxn(".wp-friend-list .list > li").each(function(){jxn(this).remove()}),e.friendList.append(e.allFriends),e.friendItem=jxn(".wp-friend-list li")},onError:function(e){}})},this.rebuildFrame=function(e,t){if(t==""&&e.inputSearchChanged){e.resetList(),e.inputSearchChanged=!1;return}e.p.init=!1,e.p.limit=20,e.p.page=!1,e.p.qkey="friend",e.p.query=t||" ",e.inputSearchChanged=!0,e.initFriendList()},this.buildList=function(e,t){var n=[];if(t.candidate.length>0){for(var r=0;r<t.candidate.length;r++){var i=t.candidate[r],s=['<li data-id="',i.id,'"><span class="checkbox-wrap"></span><p><img src="',i.head,'" width="30" height="30" /><span>',i.name,"</span></p></li>"].join("");n.push(s)}n=n.join("")}else e.noFriends?(jxn(".wp-friend-list .list").empty(),n='<li class="no-click">您没有任何好友</li>'):n='<li class="no-click">您的好友中没有 '+e.p.query+"</li>";return jxn(n)},this.bindEvent=function(e){e.searcher.bind("blur",function(){clearInterval(e.onChangeInterval),e.query=""}),e.searcher.bind("focus",function(){clearInterval(e.onChangeInterval),e.onChangeInterval=setInterval(function(){e.searcher.val()!=e.query&&(e.query=e.searcher.val(),e.rebuildFrame(e.query))},e.delayInterval)}),e.friendList.delegate("#wp-friend-select .wp-friend-list li","click",function(t){if(jxn(this).hasClass("no-click"))return;var n=this,r={id:jxn(this).attr("data-id"),portrait:jxn(this).find("img").attr("src"),name:jxn(this).find("p span").text()};e.addEvent("selectedItem",function(t){var n=t.data;e.addMembers(n),jxn(".wp-friend-list .list li[data-id = "+n.id+"]:first").addClass("selected")}),jxn(this).hasClass("selected")?(e.removeMembers(r),jxn(this).removeClass("selected")):e.room?e.room.fireEvent("selected",{data:r}):e.fireEvent("selected",{data:r})}),e.prevBtn.on("click",function(){if(e.prevBtn.hasClass("disabled"))return;var t=parseInt(e.members.wrap.css("margin-left"))+e.perWidth;t=t>0?0:t,e.members.wrap.css("margin-left",t+"px"),e.page--,e.page<=0&&(e.page=0,e.prevBtn.addClass("disabled")),e.nextBtn.removeClass("disabled")}),e.nextBtn.on("click",function(){if(e.nextBtn.hasClass("disabled"))return;var t=parseInt(e.members.wrap.css("margin-left"))-e.perWidth;t=t>0?0:t,e.members.wrap.css("margin-left",t+"px"),e.page++,e.page>=e.totalWidth/e.perWidth-1&&(e.page=e.totalWidth/e.perWidth-1,e.nextBtn.addClass("disabled")),e.prevBtn.removeClass("disabled")}),e.members.wrap.delegate(".wp-friend-slider .member","mouseover",function(t){e.delBtn=jxn(this).find(".wp-friend-del"),e.delBtn.show()}),e.members.wrap.delegate(".wp-friend-slider .member","mouseleave",function(t){e.delBtn.hide()}),e.members.wrap.delegate(".wp-friend-slider .member","click",function(t){var n=jxn(this).attr("data-id"),r=jxn(this).attr("data-name");e.setMemberList(),e.friendItem.each(function(t){jxn(t).attr("data-id")==n&&(e.memberList.splice(e.memberList.indexOf(n),1),e.memberName.splice(e.memberName.indexOf(r),1),jxn(t).removeClass("selected"))}),jxn(this).remove(),e.memberList.length<=0&&e.confirmBtn.addClass("wp-friend-confirm-disable")})},this.buildMemberList=function(e,t){return['<li class="member" data-id="',t.id,'" data-name="'+t.name+'"><img src="',t.portrait,'" width="30" height="30"><span class="wp-friend-del" title="删除"></span></li>'].join("")},this.addMembers=function(e,t){if(e.memberList.indexOf(t.id)>-1)return;e.memberList.push(t.id),e.memberName.push(t.name);var n=e.buildMemberList(t);jxn(n).insertBefore(e.members.lastItem),e.setMemberList(),e.confirmBtn.removeClass("wp-friend-confirm-disable")},this.removeMembers=function(e,t){var n=e.memberList.indexOf(t.id);jxn(".wp-friend-footer .list-wrap li:eq("+n+")").remove(),e.memberList.splice(e.memberList.indexOf(t.id),1),e.memberName.splice(e.memberName.indexOf(t.name),1),e.setMemberList(),e.memberList.length<=0&&e.confirmBtn.addClass("wp-friend-confirm-disable")},this.setMemberList=function(e){e.members.item=jxn("li",e.members.wrap),e.Memberlen=e.members.item.length,e.members.wrap.css("width",e.Memberlen*36+"px"),e.page=Math.floor(e.Memberlen/6),e.totalWidth=e.Memberlen*36,e.perWidth=216,e.Memberlen>6?(e.prevBtn.removeClass("disabled"),e.nextBtn.addClass("disabled"),e.members.wrap.css("margin-left",-(e.Memberlen-6)*36+"px")):(e.prevBtn.addClass("disabled"),e.members.wrap.css("margin-left",0))}})}),object.define("webpager/lib/jqtpl",function(e,t,n){function i(e){return e?e.replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\\\/g,"\\"):null}function s(e){return new Function("$","$item",'var call,_=[],$data=$item.data;with($data){_.push("'+e.trim().replace(/([\\"])/g,"\\$1").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\$\{([^\}]*)\}/g,"{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g,function(e,n,r,s,o,u,a){var f=t.tag[r],l,c,h;if(!f)throw new Error("Template command not found: "+r);return l=f._default||[],u&&!/\w$/.test(o)&&(o+=u,u=""),o?(o=i(o),a=a?","+i(a)+")":u?")":"",c=u?o.indexOf(".")>-1?o+i(u):"("+o+").call($item"+a:o,h=u?c:"(typeof("+o+')==="function"?('+o+").call($item):("+o+"))"):h=c=l.$1||"null",s=i(s),'");'+f[n?"close":"open"].split("$notnull_1").join(o?"typeof("+o+')!=="undefined" && ('+o+")!=null":"true").split("$1a").join(h).split("$1").join(c).split("$2").join(s||l.$2||"")+'_.push("'})+'");}return _.join("");')}function o(e,n,r){return t.tmpl(t.template(e),n,r)}var r=Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"};t.each=function(e,t){var n;if(r(e))for(n=0;n<e.length;++n)t.call(e[n],n,e[n]);else for(n in e)t.call(e[n],n,e[n])},t.escape=function(e){return String(e).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;")},t.tag={tmpl:{_default:{$2:"null"},open:"if($notnull_1){_=_.concat($item.nest($1,$2));}"},wrap:{_default:{$2:"null"},open:"$item.calls(_,$1,$2);_=[];",close:"call=$item.calls();_=call._.concat($item.wrap(call,_));"},each:{_default:{$2:"$index, $value"},open:"if($notnull_1){$.each($1a,function($2){with(this){",close:"}});}"},"if":{open:"if(($notnull_1) && $1a){",close:"}"},"else":{_default:{$1:"true"},open:"}else if(($notnull_1) && $1a){"},html:{open:"if($notnull_1){_.push($1a);}"},"=":{_default:{$1:"$data"},open:"if($notnull_1){_.push($.escape($1a));}"},"!":{open:""}},t.template=function(t,n){t=t||n;var r=arguments.callee[t];return n!=null&&!r&&(r=arguments.callee[t]=s(n)),r},t.tmpl=function(e,n,i){var s=typeof e=="function"?e:t.template(null,e),u="",a;n=n||{},i=i||{},i.data=n,i.nest=o;if(r(n))for(a=0;a<n.length;++a)i.data=n[a],u+=s.call(i.scope,t,i);else u=s.call(i.scope,t,i);return u}}),object.define("webpager/service","./lib/tools, ./service/messager, ./service/friendbook, ./service/notify, ./service/ubbparser",function(e,t,n){var r=e("./lib/tools"),i=r.getLogger("service");t.messager=e("./service/messager"),t.friendbook=e("./service/friendbook"),t.notify=e("./service/notify"),t.ubbparser=e("./service/ubbparser");var s={};t.regService=function(e,t){if(!e)return;s[e]=t,i.log1("service注册了一个新服务 ",e)},t.request=function(e){if(!s[e]){i.log1("调用了不存在的服务:  ",e);return}var t=Array.prototype.slice.call(arguments,1);return s[e].apply("",t)};var o={sKey:"preferences",preValue:{ban_stranger:!1,im_disabled:!1,quiet_mode:!1,quiet_birthday:!1,notify_viewer:!1},userPrefer:{},init:function(){var e=this;this.cluster=new r.Cluster_Client("preferences"),this.cluster.addEvent("message",function(t){t.data=="save"&&e.load()}),this.load()},load:function(){var e=window.webpager.getItem(this.sKey,1);if(e){try{var t=JSON.parse(e)}catch(n){return}this.userPrefer=t}},save:function(){window.webpager.setItem(this.sKey,JSON.stringify(this.userPrefer),1,1)},get:function(e){var t=null;return e in this.userPrefer?t=this.userPrefer[e]:e in this.preValue&&(t=this.preValue[e]),t},set:function(e,t){this.userPrefer[e]=t;if(e=="ban_stranger")return;this.save(),this.cluster.broadcast("save")},isSet:function(e){return e in this.userPrefer}};o.init(),t.preferences=o}),object.define("webpager/service/friendbook","../lib/channel_api, ../lib/base, ../lib/tools, ./messager",function(e,t,n){function v(e){var t=0;return d.test(e)&&(t=e.replace(d,"")),t||e}var r=e("../lib/base"),i=e("../lib/tools"),s=i.getLogger("friendbook"),o=e("../lib/channel_api"),u=e("./messager"),a=r.$extend,f=r.readly,l=r.XN,h=i.AsyncMgr,p=i.QA,d=/[\u0000-\u001f]/g,m="http://a.xnimg.cn/webpager/res/group-avatar.png",g=Class({"@mixins":[r.events.Events],table:{},list:[],cats:{},robots:[],groups:[],recent:[],onlineCount:0,skey:"friendbook",ready:!1,superUser:!1,_updateFrequency:6e4,_updateTimestamp:0,initialize:function(e){e.load()},save:function(e){var t={contacts:e.list,groups:e.groups,robots:e.robots,o:new Date-0,t:l.cookie.get("t")};o.persistMgr.storageSet(e.skey,JSON.stringify(t),1,1)},_do_ready:function(e){if(e.ready)return;e.ready=!0,e.fireEvent("ready")},update:function(e,t){function o(){++i>=2&&(clearTimeout(s),e.save(),e._do_ready())}var n=new Date;if(n-e._updateTimestamp<e._updateFrequency)return;var i=0,s=0;n-t.o<1800?(o(),o(),o()):(e.fetchFullRecent("recent",function(e,t){o()}),e.fetchFullRecent("online",function(t,n){if(t)return;n.online&&n.online.length&&e.applyOnlineStatus(n.online),o()}),e.getRobots(function(){o()})),s=r.setTimeout(function(){p.reportExpt("fbook_update_timeout",new Error("更新最近联系人,超时; "),""),o(!0)},15e3),e._updateTimestamp=new Date},applyOnlineStatus:function(e,t){var n={};e.onlineCount=t.onlineFriendsCount,e.list.forEach(function(e){e.status&&(n[e.userId]=e,e.status=0)});var r=e.table,i=[];t.forEach(function(e){var t=e.userId;if(!r[t]){i.push(e);return}r[t].status=e.status,t in n?delete n[t]:n[t]=r[t]}),e.informChange(n,null,n),i.length&&e.appendContacts(i)},load:function(e){var t=o.persistMgr.storageGet(e.skey,1);try{if(t){t=JSON.parse(t);if(t.t==l.cookie.get("t")){e.appendContacts(t.contacts),e.groups=t.groups,e.robots=t.robots||[],e.update(t);return}window.frames.imengine.WPC.PersistMgr.clear()}}catch(n){p.reportExpt("fbook_load",n,"")}var r=new h({timeout:1e5});r.register("fetchAllFriend"),r.register("getRecent"),r.register("getRobots"),r.addEvent("asyncMgr_all_done",function(){e._do_ready()}),r.addEvent("asyncMgr_timeout",function(t){p.reportExpt("fbook_load_timeout",new Error("完整加载,超时; "),""),s.err("asyncMgr: 必要的请求超时或者返回出错, 或者有返回但是发生了错误. 请求状况如下: ",t),e._do_ready()}),e.fetchAllFriends(function(t){r.thisDone("fetchAllFriend"),t||e.save()}),e.fetchFullRecent("recent",function(e){r.thisDone("getRecent")}),e.getRobots(function(){r.thisDone("getRobots")}),r.start()},getRobots:function(e,t){new l.net.xmlhttp({url:"http://photo.renren.com/photo/simsimiGetChatInfo",method:"GET",onSuccess:function(n){try{var r=JSON.parse(n.responseText);if(r.code)return;e.robots=[{status:2,robotInput:r.chat,profile:r.url,tiny:r.head,userId:r.id,userName:r.name||"小黄鸡",shortName:r.name||"小黄鸡"}]}catch(i){}finally{t()}},onError:function(){t()}})},fetchAllFriends:function(e,t){function c(e,n){if(e===0)a+=u,u=0,f.push("ok");else{if(e!==1)return f.push(n),++u>=5?(a+=u,t("error!!"),p.reportExpt("fbook_fetch_all",new Error("超出重试次数 - "+a+"/"+f.length),f.join()),!0):!1;t(),a&&p.reportExpt("fbook_fetch_all",new Error("有错误重试成功 - "+a+"/"+f.length),f.join())}}t=t||function(){};var n,r=0,o=1e3,u=0,a=0,f=[];(function(){var t=arguments.callee;new l.net.xmlhttp({url:"http://notify.renren.com/wpi/getallfullfriends.do?id="+i.User.id+"&begin="+r+"&limit="+o+"&t="+new Date%18e4,method:"get",onSuccess:function(r){if(!r.responseText){c("error","blank")||setTimeout(t,1001);return}try{var i=JSON.parse(v(r.responseText))}catch(o){p.reportExpt("fbook_fetch_all_json",o,r.responseText),c("error","JSON")||setTimeout(t,1001);return}c(0),n=i.allFriendsCount,n>=1e3&&(e.superUser=!0,n=1e3);try{i.friends.length&&e.appendContacts(i.friends)}catch(o){s.err(o)}try{i.groups.length&&e.replaceGroups(i.groups)}catch(o){s.err(o)}c(1)},onError:function(e){if(c("error","net"))return;setTimeout(t,1001)}})})()},fetchFullRecent:function(e,t,n){var r={recent:"opt=0&",online:"opt=1&"}[t];new l.net.xmlhttp({url:"http://notify.renren.com/wpi/getfullrecentfriends.do?"+r+"t="+Math.random(),method:"get",onSuccess:function(t){try{var r=JSON.parse(v(t.responseText))}catch(s){s.msg="服务器返回数据格式错误,JSON解析出错",n(s);return}if(r.code){var s=new Error(" fetchFullRecent 服务器内容错误");s.msg=r.msg,n(s);return}if(r.recents&&r.recents.length){var o=[];r.recents.forEach(function(e){e=e[0];if(e.id=="")return;e.userId=e.id,e.userName=e.name,e.type==2?e.tiny=m:e.tiny=i.makeHeadTinyurl(e.head),o.push(e)}),e.recent=o}n(null,r)},onError:function(e){e.msg="获取最新在线列表失败,由于网络问题,请稍后再试. ",n(e)}})},appendContacts:function(e,t){var n=e.list,r=e.table,i=e.cats,s={},o={},u={},a={};t.forEach(function(e){s[e.userId]=e;var t=e.cats.slice(0)||[];if(r[e.userId]){u[e.userId]=e;var f=r[e.userId],l=f.cats||[];l.forEach(function(e){var n=t.indexOf(e);n>=0?t.splice(n,1):(a[e]=0,i[e].splice(i.indexOf(f)))})}else o[e.userId]=e,n.push(e);t.forEach(function(t){a[t]=0,i[t]||(i[t]=[]),i[t].push(e)}),r[e.userId]=e}),t.length&&e.informChange(s,o,u,a)},informChange:function(e,t,n,r,i){var i=i||{};for(c in i)i[c]=e.cats[c].length;var s={touch:t,add:n||{},update:r||{},cats:i};e.fireEvent("change",s)},replaceGroups:function(e,t){var n=e.groups=[];t.forEach(function(e){n.push({tiny:m,userId:e.id,userName:e.name,type:2})})},fetchGroupOnly:function(e,t){new l.net.xmlhttp({url:"http://notify.renren.com/wpi/getallfullfriends.do?begin=0&limit=1&t="+new Date%18e4,method:"post",onSuccess:function(e){if(!e.responseText&&t){t(null);return}var n=JSON.parse(e.responseText);t&&t(n)}})}}),y=new g,b=new r.events.Events;return f(b),r.extend(b,{_pending:{},_getting:[],_pending_getting:0,_cache_search:{},_requesting_onlinecount:[],init:function(){var e=this;y.addEvent("change",function(t){var n={touch:t.touch,update:t.update,add:t.add,cats:t.cats};e.fireEvent("change",n)}),y.ready?e.doReady():y.addEvent("ready",function(){e.doReady()})},update:function(){y.update()},getFriendsCount:function(){return y.superUser?"1000+":y.list.length},getCats:function(){var e=["最近联系","在线好友"],t={};t[e[0]]=!0;for(cat in y.cats)t[cat]||(e.push(cat),t[cat]=!0);return y.groups.length&&e.push("我的讨论组"),e},getOnline:function(){var e=y.list,t=[],n;for(var r=0;r<e.length;r++)n=e[r],n.status>0&&t.push(n);return t=y.robots.concat(t),t},getRecent:function(){var e=[],t=y.table;return y.recent.forEach(function(n){t[n.userId]?e.push(t[n.userId]):e.push(n)}),e},getBuddiesInCat:function(e){var t=this;return e=="在线好友"?t.getOnline():e=="最近联系"?t.getRecent():e=="我的讨论组"?y.groups:y.cats[e]||[]},isOnline:function(e){var t=y.table[e];return t?t.status>0:!1},getStatus:function(e){var t=y.table[e];return t?t.status:0},getLocalFriend:function(e){if(!e)return null;var t=y.table[e];return!t||t.isStranger?null:t},getOnlineCount:function(e){var t=this;if(y.onlineCount)var n=y.onlineCount;else{var n=t.getOnline().length;y.onlineCount=n}return n},getFriendsInfo:function(e,t){var n=this,s=[],o={},e=[].concat(e);e.forEach(function(e){var t=y.table[e];if(!t)if(i.isMyself(e)){var r=i.User;t={userName:r.name,tiny:r.head,userId:r.id}}else y.robots.length&&y.robots[0].userId==e?t=y.robots[0]:(n._pending[e]||(n._pending[e]=!0,s.push(e)),t={id:e,name:"未知",tiny:i.resource.url.OFFLINE_IMG});else t=a({},t);o[e]=t});if(s.length){if(t){var u=t;t=function(e){r.extend(o,e,!0),u(o)}}n.asyncGet(s,t)}else t&&t(o);return o},asyncGet:function(e,t){function r(){n._getting=[],n.getUserInfo(e,t)}var n=this,e=n._getting.concat(e);clearTimeout(n._pending_getting),t?r():(n._pending_getting=setTimeout(r,50),n._getting=e)},getUserInfo:function(e,t){var n=this;new l.net.xmlhttp({url:"http://notify.renren.com/wpi/getuserinfo2.do",data:"uids="+e.join(),method:"get",onSuccess:function(e){var r=l.json.parse(e.responseText),i=y.table,s,o=[],u=n._pending;for(s in r)delete u[s],r[s].isStranger=1,i[s]=r[s],o.push(s);o.length&&n.fireEvent("update",{data:o}),t&&t(r,o)}})},asyncSearch:function(e,t){var n=this,r=n._cache_search;e=encodeURIComponent(e);if(r[e]&&t){t(r[e]);return}new l.net.xmlhttp({url:"http://sg.renren.com/s/f?q="+e+"&l=7",method:"get",onSuccess:function(n){var i;try{i=JSON.parse(n.responseText)}catch(s){i={candidate:[]}}r[e]=i,t&&t(i)}})},isRobot:function(e){var t=y.robots;for(var n=0;n<t.length;n++)if(t[n].userId==e)return t[n];return!1}}),b.init(),b}),object.define("webpager/service/messager","../lib/channel_api, ../lib/base, ../lib/tools",function(e,t,n){var r=e("../lib/channel_api"),i=e("../lib/base"),s=e("../lib/tools"),o=s.QA,u=s.getLogger("messager"),a=XN.user.id%10==0||XN.user.id%10==1||XN.user.id%10==2||XN.user.id%10==3||XN.user.id%10==4||XN.user.id=="702403929"||XN.user.id=="236235312"||XN.user.id=="30314"||XN.user.id=="200484432"||XN.user.id=="245321166"||XN.user.id=="330480037"||XN.user.id=="299094607",f=new Class(function(){this.__mixins__=[i.events.Events],this.initialize=function(e){e.listenServerPush()},this.sendConv=function(e,t){t.data.icode?webpager.sendMessage(t.data,"spam"):webpager.sendMessage(t.data)},this.send=function(e,t){e.fireEvent("message",t)},this.listenServerPush=function(e){function t(e,t,r){var i=n(e);i&&webpager.fireEvent("notifySys",{roomid:e,msg:t}),r&&setTimeout(function(){i.model.getRoomInfo(!0)},1e3)}function n(e){return webpager.roomKeeper.findRoom(e)}window.webpager.addEvent("group_open",function(e){window.webpager.service.request("chat/group/start",e.from)}),function(){var e=['<iq id="disco2" type="get">\n','<query xmlns="http://muc.talk.renren.com/grouplist"/>\n',"</iq>\n\0"].join("");webpager.sendMessage(e,"newProtocal")}(),window.webpager.addEvent("group_name",function(e){t(e.from,e.info),window.webpager.fireEvent("upAllGroupName",e)}),window.webpager.addEvent("group_inviteitem",function(e){t(e.roomid,e.info)}),window.webpager.addEvent("group_config",function(e){}),window.webpager.addEvent("group_invite",function(e){var t=n(e.from);t.ui.nodes.header.innerHTML=t.ui.panels.chat.header.innerHTML,t.buildChatPanel()}),window.webpager.addEvent("group_quit",function(e){}),window.webpager.addEvent("group_quititem",function(e){e.uid!=XN.user.id&&t(e.from,e.info)}),window.webpager.addEvent("group_sr",function(e){if(!+e.msgkey)return;var t=n(e.to);t&&(t.ui.max_msg_id&&t.ui.max_msg_id!=e.last_msgkey&&setTimeout(function(){window.webpager.getChatLastestMsg(t.model.id,"g")},500),webpager.fireEvent("notifyClearInput",{roomid:e.to}),t.ui.max_msg_id=e.msgkey,t.ui.message(),t.model.inputText=null)}),window.webpager.addEvent("group_message",function(e){setTimeout(function(){var t=n(e.groupid),r=0;e.type=="muc_self"&&(r=1),t.upMaxMsgKey(e.msgkey);var i={msgkey:e.msgkey,fromuin:e.groupid};t&&t.buildReport(i,r)},800)}),window.webpager.addEvent("chat_sr",function(e){if(!+e.msgkey)return;var t=n(e.to);t&&(t.ui.max_msg_id&&t.ui.max_msg_id!=e.last_msgkey&&setTimeout(function(){window.webpager.getChatLastestMsg(t.model.id,"u")},500),webpager.fireEvent("notifyClearInput",{roomid:e.to}),t.ui.max_msg_id=e.msgkey,t.ui.message(),t.model.inputText=null)}),window.webpager.addEvent("chat_message",function(e){setTimeout(function(){var t=n(e.from)||n(e.to),r=0;e.type=="chat_self"&&(t=n(e.to),r=1);var i={id:e.from,msgkey:e.msgkey};t&&t.buildReport(i,r)},800)}),window.webpager.addEvent("realTime_got",function(t){var n=JSON.parse(t.content);if(n&&(n.ugc_content||n.is_at)){o.log2(42),u.log1("new realTIme_got: ",t),o.log2(41);var r={service:"ugc_chat",source:"renren.com",actor:"renren.com",action:"message",data:n};e.fireEvent("message",{sgl:r}),XN.net.sendStats("http://notifystat.renren.com/webpager?uid="+XN.user.id+"&json="+encodeURI(JSON.stringify(r.data)))}else n.source=="10000-1"?e.fireEvent("message",{service:"qun",source:"qun.renren.com",data:t}):n.bigtype&&webpager.isLocalConnect()&&(XN.net.sendStats("http://notifystat.renren.com/bubble?uid="+XN.user.id+"&json="+encodeURI(JSON.stringify(n))),e.headerNotify(n))}),webpager.addEvent("message_got",function(t){var n={service:"oto_chat",source:"wpi.renren.com",data:t};e.fireEvent("message",{sgl:n})}),webpager.addEvent("groupmsg_got",function(t){var n=XN.json.parse(t.content);n.msgkey=t.msgkey;var r={service:"group_chat",source:"wpi.renren.com",data:n};n.attachment=t.attachment,n.localid=t.localid,n.msg_audiosrc=t.msg_audiosrc,n.msg_headsrc=t.msg_headsrc,n.msg_originalsrc=t.msg_originalsrc,n.fname=t.fname,n.timestamp=t.timestamp,n.chat_tag=t.chat_tag,e.fireEvent("message",{sgl:r})}),webpager.addEvent("spam_got",function(t){var n={service:"spam",source:"wpi.renren.com",data:t};e.fireEvent("message",{sgl:n})})},this.headerNotify=function(e,t){e.fireEvent("message",{service:"notify",source:"webpager",data:t})}});return new f}),this.appendStytemInfo=function(e){var t=self.makeAttendee(e);self.frame.getElement("dl").appendChild(tools.getDom(t))},object.define("webpager/service/notify","../lib/base, ../lib/channel_api, ../lib/tools",function(e,t,n){function d(e,t){if(!e)return 0;var n=0,r=0,i=e.length;if(t){t*=2;while(e[r]){e.charCodeAt(r)>255?n+=2:n++,r++;if(n>=t&&e[r])return!0}return!1}for(r=0;r<i;r++)e.charCodeAt(r)>255?n+=2:n++;return Math.ceil(n/2)}function g(e,t,n){var r=setTimeout(function(){if(e){w(e);try{n()}catch(t){}}},t);return r}function y(e,t,n,r,i,s,o){var u=new Date,a=i,f=s,l=e,c=r-n;(function(){var e=arguments.callee,r=new Date-u,i=r/a;i=i>=1?1:i,l.style[t]=n+Math.ceil(c*i)+"px",i!=1?setTimeout(e,f):o()})()}var r=e("../lib/base"),i=r.dom,s=r.events,o=e("../lib/channel_api"),u=e("../lib/tools"),a=u.getLogger("notify"),f=new r.events.Events;r.extend(f,{notify_list:[],tobe_valid:[],storage_tag:"webim_notify",i:0,count:0,_new_content:!1,init:function(){var e=this;a.log1("notify开始初始化 ",f);var t=new u.Cluster_Client("webpager_notify");e.cluster=t,t.addEvent("master",function(t){e.load()}),e.bindEvent(),t.isMaster()&&e.load()},bindEvent:function(){var e=this;window.addEvent("unload",function(e){a.log1("窗口unload,需要把桌面提醒都删除 ")}),u.focused.addEvent("focus",function(t){a.log1("窗口被focus,取消新消息提示 "),e.newContent(-1)})},load:function(){var e=this;e.notify_list=[],e.count=0;var t=o.persistMgr.storageGet(e.storage_tag,1,1);t?(t=JSON.parse(t),t.t==u.User.t&&(e.tobe_valid=t.ntf,e.i=t.i)):e.i=0,a.log1("seervice/notify: 加载了LocalStorage的数据,准备提供服务 ",t),e.fireEvent("load",{data:t})},save:function(){var e={t:u.User.t,ntf:this.notify_list,i:this.i,c:this.count};o.persistMgr.storageSet(this.storage_tag,JSON.stringify(e),1,1),a.log1("service/notify: 保存到LocalStorage: ",e)},refresh:function(e){var t=this;a.log2("service/notify: 当前notify_list: ",t.notify_list),t.count!=t.notify_list.length&&(t.count=t.notify_list.length,t.fireEvent("count",{data:t.count,silent:e})),t.save()},newNotify:function(e){var t=this;a.log1("service/notify: 收到Notify请求: ",e);if(!e)return 0;var n=[].concat(e),r;while(r=n.shift())r.id=++t.i,t.notify_list.push(r),r.content&&t.fireEvent("message",r);t.refresh()},newContent:function(e){e?this._new_content=!1:this._new_content=!0},delBySource:function(e){var t=this,n=t.notify_list,r=0,i=[];while(n[r])if(n[r].source==e){var s=n.splice(r,1)[0];s.content&&(i=i.concat(s.content))}else r++;t.refresh(),i.length&&i.forEach(function(e){e.callback&&new XN.net.xmlhttp({url:e.callback})})},clear:function(){var e=this;e.notify_list=[],e.refresh(!0)},valid:function(e){var t=this,n=t.tobe_valid,r=!1,i=0;while(n[i])e==n[i].source?(t.notify_list.push(n.splice(i,1)[0]),r=!0):i++;return r&&t.refresh(!0),r}});var l=function(){var e=this,t="【新消息】- ",n="【　　　】- ",r=function(){var e=document.title,r=e.indexOf(t);return r==-1&&(r=e.indexOf(n)),r!=-1?e.substring(r+7):e},i=new u.Bling({onStart:function(){if(document.title.indexOf("【")!=-1)return;this.oldtitle=document.title},fn1:function(){document.title=t+r()},fn0:function(){document.title=n+r()}});return i.addEvent("stop",function(){document.title=r()}),i}(),c={ns:[],init:function(){},tipMessage:function(e){this.makeSound();var t=showNotification(content);t.onclick=e.callback},showNotify:function(){},cancelAll:function(){}};f.addEvent("count",function(e){e.data?(a.log2("Notify count: "+e.data," 开启闪烁 "),l.start(),e.silent||o.playSound()):(a.log2("Notify count: "+e.data," 关闭闪烁 "),l.stop())}),window.webkitNotifications&&f.addEvent("message",function(e){if(!f.cluster.isMaster())return;var t=[].concat(e.content);t.forEach(function(t){if(!t.content||!t.avatar||!t.name)return;var n=u.unescapeHTML(t.content);window.webpager.notificationShow({head:t.avatar,name:t.name,content:n,callback:e.callback})})}),f.init();var h,p,v=null,m=[],b=function(t,n){h||(h=document.createElement("div"),h.id="seehere-box",i.getElement("#bottombar").appendChild(h));if(v){if(v==t)return;if(m.some(function(e){return e==t}))return;m.push(t);return}v=t;var r=h.style.height=h.offsetHeight;h.appendChild(t),setTimeout(function(){var e=r+t.offsetHeight;y(h,"height",r,e,400,20,function(){h.style.height=""})}),t.addEvent("mouseover",function(e){clearTimeout(p),e.cancelBubble=!0}),t.addEvent("mouseout",function(e){clearTimeout(p),p=g(t,2e3)}),p=g(t,8e3,function(){n("auto-drop")}),n("bubble")},w=function(t){if(t==v)y(t,"left",0,200,200,20,function(){h.removeChild(t),t.style.left="",v=null,m.length&&b(m.shift())});else for(var n=0;n<m.length;n++)m[n]==t&&m.splice(n,1)},E=function(t,n){var s,o=document.createElement("div");o.className="seehere-message";var u=document.createElement("div");u.innerHTML=t.content,XN.browser.IE?s=d(u.innerText)>60:s=d(u.textContent)>60,u=null;var a="";t.actor&&(a=['<div class="actor"><figure>','	<a href="'+t.actor.link+'" click="head" title="'+t.actor.name+'" target="_blank">','	<img src="'+t.actor.image+'" click="head" width="32" alt="头像"></a>',"</figure></div>"].join(""));var f=['<header><a href="javascript:;" class="remove-btn" click="drop" title="忽略">&nbsp;</a></header>',a,'<div class="content"'+(s&&XN.browser.IE6?' style="height:78px;"':"")+">"+t.content+"</div>",t.overfollow?'<p style="margin-left:46px;">...</p>':"",'<div class="actions">'+(t.actions||"")+"</div>"].join("");o.appendChild(r.parseHTML(f)),i.wrap(o),o.addEvent("click",function(e){var t=e.target,r=t.getAttribute("click");typeof r!="string"&&(r=null);if(r)r=="drop"&&w(o),n(r);else{if(t.tagName.toLowerCase()=="a")return;n("none")}}),this.frame=o,this.callback=n=n||function(){}};E.prototype={show:function(){b(this.frame,this.callback)},drop:function(){w(this.frame)}};var S=new r.events.Events;return r.extend(S,{add:function(){if(!f.cluster.isMaster())return;f.newNotify.apply(f,arguments)},delBySource:function(){if(!f.cluster.isMaster())return;f.delBySource.apply(f,arguments)},clear:function(){if(!f.cluster.isMaster())return;f.clear()},valid:function(e){if(!f.cluster.isMaster())return;return f.valid(e)},createTip:function(e,t){var n=new E(e,t);return n}}),f.addEvent("load",function(){a.log1("notify服务重新load"),S.fireEvent("load")}),S}),object.define("webpager/service/ubbparser","../lib/base, ../lib/tools",function(e,t,n){var r=e("../lib/base"),i=e("../lib/tools"),s=i.QA,o=r.XN,u={_ubbMap:{},skey:"ubbList",init:function(){var e=this,t=webpager.getItem(e.skey,1);if(t){var n=t.slice(0,10)+"000";n=new Date(parseInt(n)),new Date-n<36e5?e.replaceUbb(t.slice(10)):this.getUbbList()}else this.getUbbList()},getUbbList:function(e){var t=this;new o.net.xmlhttp({url:"http://shell.renren.com/ubb/doingubb",method:"get",onSuccess:function(n){var r=n.responseText;if(!r)return;t.replaceUbb(r);var i=parseInt(new Date/1e3);webpager.setItem(t.skey,i.toString()+r,1,1),e&&e(r)}})},replaceUbb:function(e){var t=this;try{var e=JSON.parse(e).ubbList,n,r;for(var i=0;i<e.length;i++)r=e[i],r.imgTag='<img src="http://a.xnimg.cn'+r.src+'" alt="'+r.alt+'">',t._ubbMap[r.ubb]=r;t.doReady()}catch(s){}},getUbbImg:function(e){var t=this._ubbMap[e];return t?t.imgTag:!1},mapMobileEmo:function(e){var t="http://a.xnimg.cn/webpager/res/emo/",n={"[象扑君--委屈]":"xiangpujun/weiqu","[象扑君--揉脸]":"xiangpujun/roulian","[象扑君--摇摆]":"xiangpujun/yaobai","[象扑君--摔]":"xiangpujun/suai","[象扑君--撒娇]":"xiangpujun/sajiao","[象扑君--纠结]":"xiangpujun/jiujie","[象扑君--舞]":"xiangpujun/wu","[象扑君--跑]":"xiangpujun/pao","[罗小黑--下雪了]":"luoxiaohei/xiaxuele","[罗小黑--哦也]":"luoxiaohei/ouye","[罗小黑--喵]":"luoxiaohei/miao","[罗小黑--奔跑]":"luoxiaohei/benpao","[罗小黑--得意]":"luoxiaohei/deyi","[罗小黑--扫灰]":"luoxiaohei/saohui","[罗小黑--拍地笑]":"luoxiaohei/paidixiao","[罗小黑--生气]":"luoxiaohei/shengqi","[罗小黑--舒服]":"luoxiaohei/shufu","[小幺鸡--不要呀]":"xiaoyaoji/buyaoy","[小幺鸡--寂寞呀]":"xiaoyaoji/jimoy","[小幺鸡--尿急]":"xiaoyaoji/niaoji","[小幺鸡--江南style]":"xiaoyaoji/jiangnan","[小幺鸡--泪奔]":"xiaoyaoji/leiben","[小幺鸡--滚筒]":"xiaoyaoji/guntong","[小幺鸡--猫女]":"xiaoyaoji/maonv","[小幺鸡--疯啦]":"xiaoyaoji/fengla","[小幺鸡--鸭子舞]":"xiaoyaoji/yaziwu","[小幺鸡--麦霸]":"xiaoyaoji/maiba","[阿狮马--上课了]":"ashima/shangkele","[阿狮马--扩胸运动]":"ashima/kuoxiongyundong","[阿狮马--冲锋枪]":"ashima/chongfengqiang","[阿狮马--压腿运动]":"ashima/yatuiyundong","[阿狮马--双枪]":"ashima/shuangqiang","[阿狮马--呸]":"ashima/pei","[阿狮马--得瑟]":"ashima/dese","[阿狮马--摇头]":"ashima/yaotou","[阿狮马--腿部运动]":"ashima/tuibuyundong","[阿狮马--顶牛右边]":"ashima/dingniuyoubian"};return n[e]?'<img class="emo-mobile" src="'+t+n[e]+'.gif" />':!1},hasUbb:function(e){var t=/(\(|\[)([^(\(|\[(\)|\]]+)(\)|\])/g;return t.test(e)},parseTxt:function(e){var t=/(\(|\[)([^(\(|\[(\)|\]]+)(\)|\])/g,n=e.match(t),r={"(":")","[":"]"};if(!n||!n.length)return e;var i=null,s,o=null;for(var u=0;u<n.length;u++){s=n[u],o=this.getUbbImg(s)||this.mapMobileEmo(s);if(!o)continue;s="\\"+s.slice(0,s.length-1)+"\\"+r[s.slice(0,1)],e=e.replace(new RegExp(s),o)}return e}};return r.readly(u),u.init(),u}),object.define("webpager/im","./lib/uikit, ./lib/base, ./lib/tools, ./im/roomkeeper,./im/birthday, ./buddy, ./service, ./im/preferpanel,./ugc/radio",function(e,t,n){reportExpt=window.frames.imengine.WPC.reportExpt;var r=e("./lib/uikit"),i=e("./lib/base"),s=i.dom,o=e("./lib/tools"),u=o.getLogger("im"),a=e("./im/preferpanel"),f=e("./ugc/radio"),l=e("./service");window.webpager.service=l,window.webpager.messager=l.messager,window.fireEvent||s.wrap(window),window.fireEvent("webpagerReady",{webpager:window.webpager});var c=e("./im/roomkeeper"),h=e("./im/birthday"),p=e("./buddy"),d=s.getElement("#bottombar");d.style.zIndex="1999";var v=s.wrap(document.createElement("div"));v.id="webpager",v.addClass("webpager"),d.appendChild(v),v.addEvent("focus",function(e){e.cancelBubble=!0});try{var m=document.getElementById("webpager_css_loading");m&&(v.style.height="33px")}catch(g){}var y=new r.WebPager(v),b=new r.PagerCase;b.frame.style.right=0;var w=new r.PagerCase;w.frame.id="webpager-miniradio";var E=new r.WinSlider;E.setWidth(580);var S=new r.Window({no_xbtn:!0}),x=window.webpager.prefer_menu=new a.PreferMenu;S.nodes.bar.appendChild(x.frame),E.addEvent("foldAllPreferMenu",function(e){x.pickup()});var T=function(){function u(){var e=o.get(t);if(!e||!/\d+\:\d+\:\d+/.test(e))return null;var r=e.split(":");n.zdate=r[0],n.ver=r[1],n.act=r[2],n.n=r[3]}function a(){var e=[n.zdate,n.ver,n.act,n.n].join(":");o.set(t,e,30)}if(webpager.imRunning||window.frames["imengine"].AD_FOR_RRZM==undefined)return null;var e=window.frames.imengine.AD_FOR_RRZM,t="rrzm_ad",n={},r=new Date,i=r.getMonth().toString()+r.getDate().toString(),o=window.frames.imengine.WPC.cookie,f=['<div class="panelbarbutton" style="width: 97px;">','	<p class="wp-rrzm-ico">下载人人桌面</p>',"</div>"].join(""),l=s.wrap(document.createElement("div"));l.className="popupwindow",l.appendChild(s.getDom(f));var c={bar:s.getElement(".panelbarbutton",l),corner:s.getElement("span",l)},h=null,p={frame:l,_auto_hide_timer:0,init:function(){var e=this,t=0;c.bar.addEvent("mouseover",function(){t=setTimeout(function(){e.show()},500)}),c.bar.addEvent("mouseout",function(){clearTimeout(t),e.autoHide(2e3)}),c.bar.addEvent("click",function(){if(!e._download||e._download=="undefined")return;window.open(e._download)})},show:function(){var t=this;if(h){h.show(),t.autoHide();return}t.popup(e.standby)},hide:function(){h&&h.hide()},autoHide:function(e){var t=this;e=e||5e3,clearTimeout(t._auto_hide_timer),t._auto_hide_timer=setTimeout(function(){t.hide()},e)},shrink:function(){var e=this;c.bar.style.width="17px",c.bar.style.fontSize="0"},stretch:function(){c.bar.style.width="97px",c.bar.style.fontSize=""},popup:function(e){var t=this,r=parseInt(e.length*Math.random()),i=e[r];t._download=i.download,h=s.wrap(document.createElement("div")),h.addClass("wp-rrzm-popup");var o=new Image;o.onload=function(){h.style.width=o.width+"px",h.style.height=o.height+"px",t.autoHide(3e4)},o.src=i.image,h.style.backgroundImage="url("+i.image+")";var u;u=['<a class="btn-close" href="javascript:;" title="关闭"></a>','<a class="jump-link" style="'+i.style+'" target="_blank" href="'+i.url+'"></a>'],h.addEvent("click",function(e){var r=e.target;r.title=="关闭"?(n.act=1,a(),t.close()):r.tagName.toLowerCase()!="a"&&window.open(i.url)}),h.addEvent("mouseover"
,function(e){clearTimeout(t._auto_hide_timer)}),h.addEvent("mouseout",function(e){t.autoHide(2e3)}),h.innerHTML=u.join(""),t.frame.appendChild(h),t.autoHide(3e4)},close:function(){h.parentNode.removeChild(h),h=null}};return E.addEvent("append",function(){p.shrink()}),E.addEvent("remove",function(e){e.rest==0&&p.stretch()}),E.addEvent("focus",function(e){p.hide()}),p.init(),u(),setTimeout(function(){if(E._unfold_window)return;e.ver!=n.ver&&(n.act=0,n.ver=e.ver),i!=n.zdate&&(n.zdate=i,n.n=0),n.act!=1&&n.n<3&&(p.popup(e.standby),n.n++),a()},2e3),p}(),N=s.wrap(document.createElement("div"));N.addClass("panel"),N.id="friends-panel",N.style.marginLeft="5px",T!=null&&N.appendChild(T.frame),N.appendChild(S.frame);try{b.frame.appendChild(N),p.init(S)}catch(g){reportExpt("buddy_init",g,"")}b.append(E),y.append(b),y.append(w);var C=parseInt(XN.user.id)%10;(C==8||C==7||C==1||XN.user.id==229528266&&!XN.browser.IE6)&&new h.birthdayRemind(S,x);var k=v;if($("container-for-pager")){var L=s.getElement("#navigation-for-pager"),A=s.getElement("#container-for-pager"),O={_layout:0,_close:!1,init:function(){var e=this,t=s.getElement("#dropmenuHolder");i.addEvent(document,"click",function(n){var r=n.target;if(!r||!r.tagName)return;if(r.tagName.toLowerCase()=="a")return;if(r.tagName.toLowerCase()=="object")return;var i=!0;do{if(r==t||r==k||r.parentNode==null){i=!1;break}r=r.parentNode}while(r&&r!=document.body);i&&(E.foldAll(),e._layout||S.fold())});if(!L||XN.browser.IE6||window.location.host=="apps.renren.com"){o.winFrame.addEvent("resize",function(){e.updateWidth(),e.shading()}),e.updateWidth();return}o.winFrame.addEvent("resize",function(){e.checkExpand()}),S.addEvent("unfocus",function(t){e._layout&&(e._close=!0),setTimeout(function(){e.frameLayout(0),e.updateWidth()})}),S.addEvent("focus",function(t){e._close=!1,setTimeout(function(){e.checkExpand()})}),e.checkExpand()},checkExpand:function(){var e=this,t=o.getClientWidth();!e._close&&t>=1220?e.coexist():e.shading(t),e.updateWidth(t)},updateWidth:function(e){var t=this,e=e||o.getClientWidth(),n=160,r=201,i=980;if(t._layout)var s=0,u=(e-r-i)/2;else var u=(e-i)/2,s=5;var a=e-Math.ceil(u);w.frame.style.left=u+"px",N.style.marginRight=s+"px",E.setWidth(a-n-s-r)},shading:function(e){var t=this;t._layout&&t.frameLayout(0);var n=o.getClientHeight();if(n<555){var r=n-128;S.setHeight(r)}else S.setHeight(420)},coexist:function(){var e=this;e._layout||e.frameLayout(1),S._fold&&S.unfold();var t=o.getClientHeight()-30;S.setHeight(t)},frameLayout:function(e){var t=this;t._layout=e,e?(L.addClass("fixWidthForPager"),A.addClass("fixWidthForPager")):(L.removeClass("fixWidthForPager"),A.removeClass("fixWidthForPager")),window.fireEvent("changeLayout",{layout:e})}};(function(){function n(t){XN.cookie.set(e,t?0:1,365,"/","renren.com")}function r(){var t=XN.cookie.get(e)=="1"?0:1;parseInt(t)==0?S.unfold(!0):(S.fold(!0),O._close=!0)}var e="l4pager",t=new o.Cluster_Client("buddy");t.addEvent("message",function(e){u.log1("收到一条cluster:buddy广播: ",e),e.data?S.fold(!0):S.unfold(!0)}),S.addEvent("fold",function(e){t.broadcast(e.data),n(e.data)}),r();var i=$("wp-buddylist-placeholder");i&&(i.style.display="none")})(),O.init(),window.imengine.WPC.reportLogMsg("old_sb_buddy")}else(function(){function a(){var i=e.checkExpand();!S._fold&&i.full?r(i):n(i),u(i),t!=i.layout&&self.frameLayout(t),i.loading&&e.noLoading()}var e=XN.smartyBuddy,t=0,n=function(e){t&&(t=0);if(e.height<555){var n=e.height-128;S.setHeight(n)}else S.setHeight(420)},r=function(e){t||(t=1);var n=e.height-30-35;S.setHeight(n)},u=function(e){var n=n||o.getClientWidth(),r=160,i=201,s=980;if(t)var u=0,a=(n-i-s)/2;else var a=(n-s)/2,u=5;var f=n-Math.ceil(a);w.frame.style.left=a+"px",N.style.marginRight=u+"px",E.setWidth(f-r-u-N.offsetWidth)};o.winFrame.addEvent("resize",a),S.addEvent("unfocus",a),S.addEvent("focus",a);var f=new o.Cluster_Client("buddy");f.addEvent("message",function(e){var t=e.data;if(t&&t.type=="grouplist"){setTimeout(function(){var t=window.webpager.groupListInfo=e.data.list;window.webpager.initGroupList&&window.webpager.initGroupList(t),window.webpager.fireEvent("groupListReady",t)},1e3);return}if(t&&t.type=="sn"){window.webpager.handleSN&&window.webpager.handleSN(t);return}if(t&&t.type=="clearSN"){window.webpager.clearGroupUntreat(t.id,t.t);return}if(t&&t.type=="upName"){window.webpager.fireEvent("updateGroupName",t);var n=window.webpager.roomKeeper.findRoom(t.from),r={name:t.name};n.buildChatPanel(t.name),n.ui.updateProfile(r);return}if(t&&t.type=="setStrange"){window.webpager.fireEvent("setStrange");return}if(t&&t.type=="getStrange"){window.webpager.fireEvent("getStrange",t);return}t?S.fold(!0):S.unfold(!0)});var l=[];window.webpager.addEvent("chat_sn",function(e){l.push(e),setTimeout(function(){var e=l.length;if(e>1&&l[0].from)for(var t=0;t<e;t++){if(t==e-1)break;l[t].from==l[t+1].from&&(l.splice(t,1),t--,e=l.length)}l.forEach(function(e,t){var n=e;n.type="sn",f.broadcast(n,1),l.splice(t,1)})},2e3)}),window.webpager.addEvent("loadLastestMsg",function(e){var t=e;e.type="clearSN",f.broadcast(t,1)}),window.webpager.addEvent("upAllGroupName",function(e){var t=e;e.type="upName",f.broadcast(t,1)}),window.webpager.addEvent("setStrangeInfo",function(e){var t=e;e.type="setStrange",f.broadcast(t,1)}),window.webpager.addEvent("getStrangeInfo",function(e){var t=e;e.type="getStrange",f.broadcast(t,1)}),S.addEvent("fold",function(t){f.broadcast(t.data),e.saveStat(!t.data)}),window.webpager.addEvent("group_list",function(e){var t=e.items;setTimeout(function(){f.broadcast({type:"grouplist",list:t},1)},500)});var c=e.readStat();c?S.unfold(!0):S.fold(!0),a();var h=s.getElement("#dropmenuHolder");i.addEvent(document,"click",function(e){var n=s.wrap(e.target);if(!n||!n.tagName)return;n.hasClass("start-groupchat")&&E.foldAll();if(n.tagName.toLowerCase()=="a")return;if(n.tagName.toLowerCase()=="object")return;var r=!0;do{if(n==h||n==k||n.parentNode==null){r=!1;break}n=n.parentNode}while(n&&n!=document.body);r&&(E.foldAll(),t||S.fold())})})();setTimeout(function(){try{c.init(E)}catch(e){reportExpt("roomKeeper_init",e,"")}});if(XN.disableMiniRadio!==!0)if(typeof window.music_playSongBook=="undefined"){var M=["http://s.xnimg.cn/apps/radio/js/radio-main.js","http://s.xnimg.cn/apps/radio/css/radio-main-all-min.css"];f.radio.seedInit(M,"webpager-miniradio")}else XN.loadFiles(["http://s.xnimg.cn/apps/radio/js/radio-home.js","http://s.xnimg.cn/apps/radio/css/radio-home-v6.css"],function(){XN.radio.home.init("","webpager-miniradio")});if(!XN||!XN.user)return;var _=parseInt(XN.user.id)||0,D=_%10,P=["462464478","200000032","200000521","136536176","254627805","193535156","243313519","303395580","248750157"].join("&");(D==2||D==3||P.indexOf(_)>-1)&&setTimeout(function(){object.execute("xn/apps/status/tiper")})}),object.define("webpager/im/chatroom","../lib/base, ../lib/uikit, ../service, ../lib/tools, ../service/ubbparser, ../lib/voice,../FriendSelect",function(e,t,n){var r=e("../lib/base"),i=e("../lib/uikit"),s=e("../service"),o=e("../lib/tools"),u=e("../service/ubbparser"),a=e("../lib/voice"),f=r.dom,l=r.events,c=r.XN,h=o.getLogger("chatroom"),p=new o.Cluster_Client("chatroom"),d=e("../FriendSelect"),v=new Class(i.Window,function(){this.__mixins__=[i.UIcomplex],this.initialize=function(e,t){this.parent(e,t);var n=e.nodes;n.title.innerHTML='<p class="header-title" style="height:19px"><a title="设置" class="chatroom-set" href="#nogo"  onclick="return false;"></a><span class="title-bg-l"><span class="title-bg-r"></span> </span></p> ',n.setbtn=f.getElement(".chatroom-set",n.title),n.title=f.getElement("span.title-bg-r",n.title),e.buildTalkflow(),e.buildInputer(),e.nodes.body.style.width="320px"},this.buildTalkflow=function(e){var t={};t.early_btn=!1;var n=new i.TalkFlow(t);e._assemble("talkflow",n),e.nodes.container.appendChild(n.frame),e.addEvent("focus",function(e){setTimeout(function(){n.scrollBottom()})})},this.buildInputer=function(e){var t=new i.Inputer({emotion:!0,history:!0,attachment:!0,voice:!0,maxinput:{num:2e3,tip:"单聊每次最多发送2000个字符."}});e._assemble("inputer",t),e.nodes.container.appendChild(t.frame)},this.pushDialog=function(e,t,n){var r=e.components.talkflow.pushDialog(t,n);return e._fold&&t.chat_tag!="self"&&e.highLight(),r},this.dropdownLayer=function(e,t){if(e.dropdown_layer)return e.dropdown_layer;var t=t||{};t.block&&e.disable({color:"#FFF",opacity:1});var n=e.nodes.dropdown||(e.nodes.dropdown=document.createElement("div"));n.style.cssText="width:100%;position:absolute;padding-bottom:10px;overflow:hidden;",e.nodes.section.appendChild(n);var r={frame:n,destroy:function(){n.parentNode.removeChild(n),e.enable(),e.dropdown_layer=null}};return e.dropdown_layer=r,r}}),m=new Class(function(){this.__mixins__=[r.events.Events],this.service="oto_chat",this._status=0,this._dead=0,this._relatedUsers={},this.templaters=[],this.strangerList=[],this.initialize=function(e){e.prepare(),e.buildUI(),e.finish(),e.buildModel(),e.bindEvent(),e.model.attmap?e.model.addEvent("roomInfoLoaded",function(){e.model.upTime==1&&e.model.loadHistory()}):e.model.loadHistory(),setTimeout(function(){if(e.ui._highlight){var t=e.model.chatType=="muc"?"g":"u",n=window.webpager.clearGroupUntreat;n&&n(e.model.id,t,!0)}},0)},this.prepare=function(e){},this.buildUI=function(e){var t=new v;e.ui=t},this.finish=function(e){return},this.getDialogTemplate=function(e,t){if(!e.templaters.length)return null;var n=null;for(var r=0;r<e.templaters.length;r++){n=e.templaters[r](t);if(n)break}return n},this.buildModel=function(e){var t=new w;e.model=t},this.buildSearchPanel=function(e){var t=e.ui;t.panels.status="search",e.hideAllPanels(),o.isEmptyObject(t.panels.search)?($extend(t.panels,{search:{header:{},section:{}}}),t.panels.search.header.innerHTML=e.buildPanelTitle("search","添加好友"),t.panels.search.section.innerHTML=['<div class="chat-panel search-panel">',"</div>"].join(""),jxn(t.nodes.section).append(t.panels.search.section.innerHTML),setTimeout(function(){e.loadFriendSection()},0)):e.loadFriendSection(),t.nodes.header.innerHTML=t.panels.search.header.innerHTML},this.buildChatPanel=function(e,t,n){var r=e.ui;r.panels.status="chat",r.panels.chat?r.nodes.header.innerHTML=r.panels.chat.header.innerHTML:($extend(r.panels,{chat:{search:{},header:{}}}),r.panels.chat.header.innerHTML=r.nodes.header.innerHTML),t&&(r.nodes.title=f.getElement("span.title-bg-r",r.body),n?r.nodes.title.innerHTML=t:(r.nodes.title.innerHTML=o.noMoreThan(t,16),r.nodes.title.title=t),r.panels.chat.header.innerHTML=r.nodes.header.innerHTML),e.hideAllPanels(),jxn(r.nodes.section).find(".dialog").show(),r.components.talkflow.scrollBottom()},this.loadFriendSection=function(e){var t=e.ui,n=f.id("wp-friend-select"),r=f.getElement(".search-panel",t.nodes.section);n?(r.appendChild(n),r.style.display="block"):webpager.fs=new d.FriendSelect(r),webpager.fs.room=e,webpager.fs.room.addEvent("selected",function(t){if(e.model.attmap){var n=t.data;if(n.id in e.model.attmap){c.Do.showMessage(n.name+"已在讨论组中，不能再添加。");return}}if(e.model.id){var n=t.data;if(n.id==e.model.id){c.Do.showMessage(n.name+"不能再添加了。");return}}webpager.fs.fireEvent("selectedItem",t)}),webpager.fs.clear()},this.buildSetPanel=function(e){var t=e.ui;t.panels.status="set",e.hideAllPanels();if(o.isEmptyObject(e.ui.panels.set)){var n=e.getUser(e.id);$extend(t.panels,{set:{header:{},section:{}}}),t.panels.set.header.innerHTML=e.buildPanelTitle("set","聊天设置"),t.panels.set.section.innerHTML=['<div class="chat-panel set-panel">','	<div class="f-area clearfix">','		<ul class="clearfix"><li>','			<a href="',o.makeProfileUrl(n.userId),'" target="_blank">','				<img src="',n.tiny,'">',"			</a>","			<em>",n.userName,"</em>","		</li>",'		<li class="chat-search">','			<a href="#nogo"  onclick="return false;">+</a>',"			<em>添加好友</em>","		</li></ul>","	</div>",'	<div class="wp-chat-set">',"	</div>","</div>"].join(""),jxn(t.nodes.section).append(t.panels.set.section.innerHTML)}else jxn(t.nodes.section).find(".set-panel").show();t.nodes.header.innerHTML=t.panels.set.header.innerHTML},this.buildHistoryMessagePanel=function(e){var t=e.ui;t.panels.status="hm",e.hideAllPanels();if(o.isEmptyObject(e.ui.panels.hm)){$extend(t.panels,{hm:{header:{},section:{}}}),t.panels.hm.pageIndex=1,t.panels.hm.pageMaxIndex=9999,t.panels.hm.header.innerHTML=e.buildPanelTitle("hm","聊天记录"),t.panels.hm.section.innerHTML=['<div class="history-message">','	<div class="history-messages">',"	</div>",'	<p class="hm-ft clearfix"><a href="#nogo" title="上一页" class="prev">&lt;</a><a href="#nogo" title="下一页" class="disable next">&gt;</a></p>',"</div>"].join("");var n=jxn(t.nodes.section);n.append(t.panels.hm.section.innerHTML),t.panels.hm.btnPrev=jxn(".hm-ft .prev",n),t.panels.hm.btnNext=jxn(".hm-ft .next",n),e.bindPaginationEv(t)}else jxn(t.nodes.section).find(".history-message").show();t.nodes.header.innerHTML=t.panels.hm.header.innerHTML,e.getHistoryMessage(t)},this.resetHistoryMesagePanels=function(e,t){o.isEmptyObject(t.panels.hm)||(t.panels.hm.pageIndex=1,t.panels.hm.pageMaxIndex=9999,t.panels.hm.section.innerHTML="")},this.bindPaginationEv=function(e,t){jxn(".hm-ft a",jxn(t.nodes.section)).click(function(n){var r=jxn(this).attr("class");if(r=="prev")t.panels.hm.pageIndex++;else{if(r!="next")return;t.panels.hm.pageIndex--}e.getHistoryMessage(t)})},this.setPaginationBtnStatus=function(e,t,n){n=="enable"?(t.panels.hm.btnPrev.attr({"class":"prev",title:"上一页"}),t.panels.hm.btnNext.attr({"class":"next",title:"下一页"})):n=="disable"&&(t.panels.hm.btnPrev.attr({"class":"prev disable",title:""}),t.panels.hm.btnNext.attr({"class":"next disable",title:""}))},this.togglePaginationStatus=function(e,t){var n=t.panels.hm.pageIndex;e.setPaginationBtnStatus(t,"enable"),n<=1&&t.panels.hm.btnNext.attr({"class":"next disable",title:""}),n>=t.panels.hm.pageMaxIndex&&t.panels.hm.btnPrev.attr({"class":"prev disable",title:""})},this.getHistoryMessage=function(e,t,n){n||e.setPaginationBtnStatus(t,"disable");var r=n?1:t.panels&&t.panels.hm.pageIndex,i="sessionId="+e.model.id+"&isgroupchat="+(e.model.info?"1":"0")+"&page="+r;new c.net.xmlhttp({url:"http://chatlist."+c.env.domain+"/message/get",method:"post",data:i,onSuccess:function(r){var i=c.json.parse(r.responseText);if(n){n(i);return}i.code=="0"?i.chatlist.length<20&&(t.panels.hm.pageMaxIndex=t.panels.hm.pageIndex):i.code=="1"&&(t.panels.hm.pageIndex=Math.max(1,--t.panels.hm.pageIndex),t.panels.hm.pageMaxIndex=t.panels.hm.pageIndex,jxn(".history-messages",jxn(t.nodes.section)).html('<p class="nomsgdata">没有历史聊天记录</p>')),e.togglePaginationStatus(t),e.renderHistoryMessage(i.chatlist)},onError:function(){}})},this.renderHistoryMessage=function(e,t){if(t.length<=0)return;e.ui.panels.hm.baseTime=null,e.ui.panels.hm.baseIndex=null;var n=jxn(".history-messages",jxn(e.ui.nodes.section));jxn("> section, .nomsgdata",n).each(function(){jxn(this).remove()});for(var r=0,i=t.length;r<i;r++){var s=c.json.parse(t[r].info),a=o.makeHeadTinyurl(s.head),f=t[r].name,l=t[r].time,h=t[r].messageid,p=c.json.parse(t[r].content),d=p.contenttype=="0"?o.htmlFilter(p.content):p.content;n.append(e.renderTimestamp(e.ui,l,r)),u.hasUbb(d)&&(d=u.parseTxt(d)),n.append(['<section class="wp-chatlist '+(h==c.user.id?"wp-chatlist-self":"")+'">','<figure class="avatar">','<a title="'+f+'" target="_blank" href="http://www.renren.com/profile.do?id='+h+'"><img width="35" height="35" src="'+a+'"></a>',"</figure>",'<section class="wp-chat-content">','<em class="wp-arrow"></em>','<em class="wp-arrow wp-arrow-inner"></em>',"<p>"+d+"</p>","</section>","</section>"].join(""))}n.scrollTop(9999)},this.getTimestamp=function(e,t,n,r){var i=864e5,s="";return t>=0?s=n:t<0&&t>=-i?s="昨天 "+n:t<-i&&t>=-i*2?s="前天 "+n:s=r,'<section class="sys-info">'+s+"</section>"},this.renderTimestamp=function(e,t,n,r){var i=n;n=n.split(" ");var s=n[0].split("-"),o=n[1].split(":"),u=parseInt(s[0]),a=parseInt(s[1])-1,f=parseInt(s[2]),l=parseInt(o[0]),c=parseInt(o[1]),h=(new Date(u,a,f,l,c)).getTime(),p=new Date,d=p.getFullYear(),v=p.getMonth(),m=p.getDate(),g=(new Date(d,v,m)).getTime(),y=h-g;return!e.ui.panels.hm.baseTime||h-e.ui.panels.hm.baseTime>3e5||r-e.ui.panels.hm.baseIndex>=10?(e.ui.panels.hm.baseTime=h,e.ui.panels.hm.baseIndex=r,e.getTimestamp(y,n[1],i)):""},this.showOriginalImage=function(e,t){jxn(t).delegate("[originalsrc]","click",function(){window.open(jxn(this).attr("originalsrc"))})},this.hideAllPanels=function(e){var t=e.ui;jxn(t.nodes.section).children(":not(.topic-box)").forEach(function(e){jxn(e).hide()})},this.buildPanelTitle=function(e,t,n){var r=document.createElement("h4");r.innerHTML=[' 	<p class="header-title">','		<a class="chat-history"  href="#nogo"  onclick="return false;" title="返回" tag="',t,'">返回</a>',"		<span>",n,"</span>","	</p>"].join("");var i=r.outerHTML+'<menu><li title="最小化" label="最小化" class="minimize">最小化</li><li title="关闭" class="close">关闭</li></menu>';return e.ui.nodes.header.innerHTML=i,i},this.buildReport=function(e,t,n){if(e.ui._fold||n){var r=e.model.attmap?"muc":"chat",i=['<ack from="',top.XN.user.id,'" to="',t.fromuin||t.id||t.uid,'" msgkey="',t.msgkey,'" type="dr" chat_type="',r,'"/>\n\0'].join("");webpager.sendMessage(i,"newProtocal")}else e.buildRR(t,1)},this.buildRR=function(e,t,n){var r=e.model.attmap?"muc":"chat",i=['<ack from="',top.XN.user.id,'" to="',t.fromuin||t.id||t.uid,'" msgkey="',t.msgkey,'" type="rr" chat_type="',r,'" ext_flag="',n,'"/>\n\0'].join("");webpager.sendMessage(i,"newProtocal")},this.upMaxMsgKey=function(e,t){e.ui.max_msg_id=t,e.ui.message()},this.popupCaptcha=function(e,t,n){if(e.model.chatType=="muc"||e.ugc)return!0;var r=e.getUser(e.id);return r.isStranger&&r.isStranger==1&&e.strangerList.indexOf(e.id)==-1?(e.icode&&e.close_icode(),e.popupICode("101",t,n),!1):!0},this.popupICode=function(e,t,n,r){e.show_icode({content:n,attachment:"",story:e.model.sysmsgs[t].story},function(){new c.net.xmlhttp({url:"http://chatlist.renren.com/message/check",method:"post",data:"verifycode="+e.icode.nodes.input.value,onSuccess:function(t){e.close_icode();var i=c.json.parse(t.responseText);i.code=="4"?e.popupICode("102",n):(e.strangerList.push(e.id),r())}})},"gossip")},this.bindEvent=function(e){e.model.addEvent("message",function(t){var n=t.data;n.forEach(function(t,r){n[r]=e.extendMessage(t);if(t.isAt)delete n[r].content,e.ui.highLight();else{var i=(n[r].uid||n[r].id)!=top.XN.user.id,s=n[r].localid||+(new Date);if(e.localid==s)return;e.localid=s,t.msgkey&&e.upMaxMsgKey(t.msgkey),e.ui.pushDialog(n[r],e.getDialogTemplate(t))}});if(n[0].tag=="system"||n[0].chat_tag=="self")return;e.ui.getStat().fold>0||e.ui._hidden?s.notify.add({source:e.id,content:n,callback:function(t){e.ui.unfold(null,!0)}}):n.forEach(function(e){e.callback&&new c.net.xmlhttp({url:e.callback,method:"post"})})}),e.ui.addEvent("focus",function(t){s.notify.delBySource(e.id),t.focus&&setTimeout(function(){e.ui.components.inputer.focus()})}),e.ui.addEvent("fold",function(t){if(!e.ui._fold&&e.ui._highlight){var n={id:e.model.id,msgkey:e.ui.max_msg_id};e.buildRR(n,0);var r=e.model.attmap?"g":"u";window.webpager.handleLastMessage(e.model.id,r)}!e.ui._fold&&e.ui.panels.status=="hm"&&(e.resetHistoryMesagePanels(e.ui),e.buildHistoryMessagePanel())}),e.model.addEvent("historyReplace",function(t){var n=t.data;n.sort(function(e,t){if(e.msgkey){if(+e.msgkey>+t.msgkey)return 1;if(+e.msgkey<=+t.msgkey)return-1}else{if(e.replyTime>t.replyTime)return 1;if(e.replyTime<=t.replyTime)return-1}});var r=n.length;if(r>1&&n[0].msgkey)for(var i=0;i<r;i++){if(i==r-1)break;n[i].msgkey==n[i+1].msgkey&&(n.splice(i,1),i--,r=n.length)}var s=[];n.forEach(function(t,n){s[n]=e.extendMessage(t)}),e.ui.components.talkflow.replaceContent(s,function(t){return e.getDialogTemplate(t)})});var t=e.ui;t.components.inputer.addEvent("send",function(t){e.ui.components.inputer.reset(!0);var n=e.popupCaptcha(t.data.content,function(){var n=e.model.send(t.data);n&&e.fireEvent("signal",n)});if(n){var r=e.model.send(t.data);r&&e.fireEvent("signal",r)}}),e.ui.body.addEvent("click",function(t){t.cancelBubble=!0,t.defaultPrevented=!0;var n=f.wrap(t.target);if(n.hasClass("chat-history")){var r=n.getAttribute("tag");if(r=="set"||r=="hm")e.ui.nodes.header.innerHTML=e.ui.panels.chat.header.innerHTML,e.buildChatPanel();r=="hm"&&e.resetHistoryMesagePanels(e.ui),r=="search"&&(e.buildSetPanel(),window.webpager.fs.resetList())}n.hasClass("chatroom-set")&&e.buildSetPanel(),n.hasClass("btn-shield"),n.hasClass("btn-reset"),window.webpager.emo&&window.webpager.emo.emotionsContainer.hide(),n.hasClass("wp-chat-history")&&e.buildHistoryMessagePanel(),jxn(t.target).attr("originalsrc")&&window.open(jxn(t.target).attr("originalsrc"))}),e.ui.addEvent("focus",function(){var t=f.id("add-friend-box"),n=e.ui;t&&t.hide(),n.panels&&n.panels.status=="search"&&e.buildSearchPanel()}),e.ui.addEvent("toChatPanel",function(t){e.buildChatPanel()})},this.extendMessage=function(e,t){return u.hasUbb(t.content)&&(t.content=u.parseTxt(t.content)),t},this.zombie=function(e){s.notify.delBySource(e.id),e._dead=new Date-0,e.ui.components.inputer.reset(),e.fireEvent("dead")},this.resume=function(e){e._dead=0,e.ui.show(),e.fireEvent("resume")},this.destroy=function(e){e.ui.destroy(),e.model.destroy()},this.getText=function(e,t,n){var r=e.textCollection[t];if(r){var i=r;for(var s in n)i=i.replace("%"+s+"%",n[s]);return i}return""},this.lookupHistory=function(e,t,n){n?n.location=t:window.open(t)}}),g=new Class(i.UIcommon,function(){this.id=0,this._code_loaded=0,this.initialize=function(e,t){e.submit=t.submit,e.param=t,e.buildFrame("div","width:200px;position:relative;margin:auto;background:#EEE;padding:10px;box-shadow:0 0 7px #888"),e.getUIRef(),e.bindEvent()},this.makeFrameHTML=function(e,t){var n=["<p>"+e.param.tiptext+"<br/>请输入验证码：</p> ",'<p style="margin:9px 0"><a class="spam_geticode" title="看不清,换一个" href="#nogo"> -> 获取验证码</a></p>','<p><input type="text" style="width:50px"> <button>确定</button></p>'].join("");return n},this.getUIRef=function(e){var t=e.frame,n={btn_get:t.getElement("a.spam_geticode"),img:t.getElement("img"),input:t.getElement("input"),submit:t.getElement("button")};e.nodes=n},this.bindEvent=function(e){function n(){var n=t.input.value;if(!e._code_loaded){e.reloadCode();return}if(!n)return;e.submit(n)}var t=e.nodes;t.btn_get.addEvent("click",function(t){e.reloadCode()}),t.submit.addEvent("click",n),t.input.addEvent("keyup",function(e){e.keyCode==13&&n()})},this.reloadCode=function(e){e._code_loaded=1,setTimeout(function(){e.nodes.btn_get.innerHTML='<img src="http://icode.renren.com/getcode.do?t='+(e.param.captcha?e.param.captcha:"privmessage")+"&rnd="+(new Date).getTime()+'" />'}),e.nodes.input.focus()}}),y=new Class(m,function(){this._status=0,this._dead=0,this.id,this.textCollection={title_online:'<a target="_blank" title="TA的主页" href="%profile%">%userName%</a><img alt="在线" title="在线" src="http://a.xnimg.cn/a.gif" class="wp-online" />',title_offline:'<a target="_blank" title="TA的主页" href="%profile%">%userName%</a>',title_busy:"%userName%",handler:"与%userName%聊天"},this._oto=1,this.initialize=function(e,t){e.id=t,this.parent(e),e.updateProfile(),setTimeout(function(){e.ui.max_msg_id=e.ui.getStat().max_msg_id},0)},this.showStrangeTip=function(e){e.getStrangeInfo(function(){var t=document.createElement("p"),n=e.ui.nodes.body;console.log(f.getElement("strange-tip"));if(f.getElement("strange-tip"))return;t.className="strange-tip",t.innerHTML='如果觉得打扰，<a href="#nogo" onclick="return false;" class="set">点击这里</a>屏蔽所有陌生人消息，<a href="#nogo" onclick="return false;" class="prevent">不再提醒</a>。',n.insertBefore(t,n.firstChild),setTimeout(function(){f.wrap(t).addEvent("click",function(n){var r=f.wrap(n.target);r.hasClass("set")&&window.webpager.prefer_menu.setStrangerState(1),r.hasClass("prevent")&&e.preventStrange(),jxn(t).remove()})},0),setTimeout(function(){t&&jxn(t).remove()},5e3)})},this.preventStrange=function(e){new c.net.xmlhttp({url:"http://chatlist.renren.com/webpagger/page/setnotifyflag",method:"post",onSuccess:function(e){}})},this.getStrangeInfo=function(e,t){new c.net.xmlhttp({url:"http://chatlist.renren.com/webpagger/page/getnotifyflag",method:"get",onSuccess:function(e){e.responseText=="true"&&t()}})},this.buildUI=function(e){var t=new v({icon:"wp-chat-ico"});t.rebuild_message={service:"oto_chat",data:{fromuin:e.id,touin:o.User.id}},t.id=e.id,window.talkflows?window.talkflows.push(t):window.talkflows=[t],e.ui=t},this.buildModel=function(e){var t=new w(e.id);e.model=t},this.bindEvent=function(e){this.parent(e),s.friendbook.addEvent("update",function(t){t.data.indexOf(e.id.toString())>=0&&(e._relatedUsers=s.friendbook.getFriendsInfo(e.id),e.updateProfile(),e.model.fireEvent("historyReplace",{data:e.model.msgs}))});var t=e.ui.components.inputer;e.ui.addEvent("invite",function(t){var n=t.data;if(!n.length)return;n.push(o.User.id),n.push(e.id),s.request("chat/group/create",n)&&t.close()}),e.ui.components.talkflow.addEvent("early",function(){e.loadEarlyMsg(10)}),t.addEvent("lookupHistory",function(t){var n="http://message.renren.com/message/gossip/"+e.id;e.lookupHistory(n,t.new_window)}),p.addEvent("message",function(t){if(t.data.id==e.id)switch(t.data.msg){case"show_icode":e.show_icode(t.data.spam);break;case"close_icode":e.close_icode()}}),e.model.addEvent("need_icode",function(t){p.broadcast({id:e.id,msg:"show_icode",spam:t.data},1)}),e.ui.body.addEvent("click",function(t){t.cancelBubble=!0,t.defaultPrevented=!0;var n=f.wrap(t.target);if(n.hasClass("wp-friend-confirm")){if(n.hasClass("wp-friend-confirm-disable"))return;window.webpager.fs.disableBtn();var r=webpager.fs.memberList,i=webpager.fs.memberName;if(r.length==1&&r[0]==e.model.id){c.DO.showMessage("不能仅选择当前聊天的人创建群。");return}if(!r.length>0){c.DO.showMessage("请至少选择一个好友。");return}r.push(o.User.id),i.push(o.User.name),r.push(e.model.id),i.push(e.getUser(e.model.id).userName),s.request("chat/group/create",r,i),webpager.fs.clear(),e.buildChatPanel()}var u="chat-search";(n.hasClass(u)||f.wrap(n.parentNode).hasClass(u))&&e.buildSearchPanel()}),e.model.addEvent("message",function(t){var n=t.data;n.forEach(function(t){var n=e.getUser(e.id);n.isStranger&&n.isStranger==1&&e.strangerList.indexOf(e.id)==-1&&e.showStrangeTip()})})},this.loadEarlyMsg=function(e,t,n){n,e.model.earlyMsg(t,function(t,r){var i=[];r.forEach(function(t){i.push(e.extendMessage(t))});var s=n?"replaceContent":"earlyContent";e.ui.components.talkflow[s](i,function(t){return e.getDialogTemplate(t)})})},this.show_icode=function(e,t,n,r){if(e.icode)return;var i=e.ui.dropdownLayer({block:1}),s=new g({submit:n||function(n){e.model.send({content:t.content,attachment:t.attachment,icode:n}),e.close_icode(),p.broadcast({id:e.id,msg:"close_icode"})},tiptext:t.story,captcha:r});i.frame.appendChild(s.frame),i.frame.style.zoom=1,s.nodes.input.focus(),e.icode=s},this.close_icode=function(e){e.icode.destroy(),e.icode=null,e.ui.dropdown_layer.destroy()},this.extendMessage=function(e,t){var n=t.fromuin,r=e.getUser(n),i={content:t.msg_content,avatar:r.tiny,name:r.userName,userName:r.userName,time:o.getTime(new Date(parseInt(t.timestamp)))||t.time,attachment:t.attachment,profile:"http://www.renren.com/profile.do?id="+n,id:n,msgkey:t.msgkey,msg_headsrc:t.msg_headsrc,msg_originalsrc:t.msg_originalsrc,msg_audiosrc:t.msg_audiosrc,localid:t.localid,chat_tag:t.chat_tag};return this.parent(e,i)},this.getUser=window.webpager.service.getUser=function(e,t){if(!e)return s.friendbook.getFriendsInfo(t)[t];var n=e._relatedUsers;if(!n[t]){var r=s.friendbook.getFriendsInfo(t);n[t]=r[t]}return n[t]},this.updateProfile=function(e){var t=e.getUser(e.id),n={userName:t.userName,profile:o.makeProfileUrl(t.userId)},r=e.ui,i="";t.status?(i=e.getText("title_online",n),r.setTitle(i)):(i=e.getText("title_offline",n),r.setTitle(i)),e.buildChatPanel(i,!0),r.setHandler(n.userName)},this.finish=function(e){this.parent(e),e.ui.components.inputer.useFeature("attachment")}}),b=new Class(function(){this.__mixins__=[r.events.Events],this.msgs=[],this.id,this.initialize=function(e,t){e.id=t},this.send=function(e,t){},this.loadHistory=function(e){var t=[],n;if(e.attmap){var r=webpager.getMessageHistory("g"+e.id);while(n=r.pop())t.push(n)}else{var r=webpager.getMessageHistory("u"+e.id);while(n=r.pop())t.push({msg_content:n.msg_content,fromname:n.fromname,fromuin:n.fromuin,attachment:n.attachment,msg_headsrc:n.msg_headsrc,msg_originalsrc:n.msg_originalsrc,msg_audiosrc:n.msg_audiosrc,localid:n.localid,msgkey:n.msgkey,timestamp:n.timestamp})}e.replaceHistory(t)},this.replaceHistory=function(e,t){e.msgs=t,e.fireEvent("historyReplace",{data:t})},this.destroy=function(e){}}),w=new Class(b,function(){this.sysmsgs={101:{msg:"need_icode",story:"对方不是好友!<br/>为证明你不是发广告的机器,"},102:{msg:"wrong_icode",story:"验证码输入错误!"}},this.send=function(e,t,n){var r;if(r=s.friendbook.isRobot(e.id)){new c.net.xmlhttp({url:r.robotInput,data:"message="+encodeURIComponent(t.content)}),window.frames.imengine.WPC.MsgMgr.addMsgHistory({from:c.user.id,fname:c.user.name,to:e.id,msg_content:t.content});return}var i=t.attachment,u=t.icode;e.inputText=t.content;var t=o.htmlFilter(t.content),a=+(new Date);u&&(f.icode=u);var f={fromuin:o.User.id,fromname:o.User.name,touin:e.id,msg_content:t,attachment:"",localid:a},l=['<message fname="',o.User.name,'" from="',o.User.id,'@talk.m.renren.com" to="',e.id,'@talk.m.renren.com" type="chat">\n','<richbody type="dialog" localid="',a,'">\n',"<font>",t,"</font>\n","</richbody>\n","</message>\n\0"].join("");webpager.sendMessage(l,"newProtocal",f)},this.pushMessage=function(e,t){var n=[].concat(t),r=e.msgs.length;n.forEach(function(t,n){e.msgs.push(t)}),e.fireEvent("message",{data:e.msgs.slice(r)})},this.sysMessage=function(e,t){var n=e.sysmsgs[t.code],r={code:t.code,content:t.content,attachment:t.attachment,story:n.story};e.fireEvent("need_icode",{data:r})},this.earlyMsg=function(e,t,n){var r=e.msgs.length,i=["hostId="+o.User.id,"guestId="+e.id,"offset="+r,"limit="+t];new c.net.xmlhttp({url:"http://message.renren.com/message/getlistforwp?"+i.join("&"),method:"GET",onSuccess:function(t){try{var r=JSON.parse(t.responseText)}catch(i){n({msg:"服务器返回JSON解析失败!"});return}if(!r.join){n({msg:"服务器返回数据格式不是列表"},r);return}var s,u=[];while(s=r.pop())u.push({msg_content:s.content,time:o.getTime(s.time),fromname:s.memberinfo.name,fromuin:s.memberinfo.id,attachment:s.attach?s.attachment:undefined});e.msgs=u.concat(e.msgs),n(null,u)}})}});t.Chatroom=m,t.ConvChatroom=y,t.ChatroomModel=b,t.ConvChatroom_window=v,t.ConvChatroom_model=w}),object.define("webpager/im/groupchat","../lib/base, ./chatroom, ../service, ../lib/tools, ../lib/uikit",function(e,t,n){var r=e("../lib/base"),s=r.dom,o=e("./chatroom"),u=e("../service"),a=e("../lib/tools"),f=e("../lib/uikit"),l=a.getLogger("groupchat"),c=a.QA,h=new a.Cluster_Client("groupchatroom"),p=new Class(o.Chatroom,function(){this.service="group_chat",this.initialize=function(e,t,n){e.id=t,e.info=n,this.parent(e);var r=e.model.getGroupInfo(t);n.name=e.model.info.name=r.name||"",e.ui.updateProfile(n),e.buildChatPanel(n.name),e.ui.tag="group",e.model.upTime=0},this.buildUI=function(e){var t=new m({title:e.info.name,icon:"wp-group-ico",handler:e.info.name});t.id=e.id,t.rebuild_message={service:"group_chat",data:{info:{roomid:e.id,roomname:e.info.name},type:"groupchat"}},e.ui=t},this.buildModel=function(e){var t=new d(e.info);t.addEvent("attendee",function(){var n=t.attendee.slice(0);l.log1("成员列表有更新:  ",n),e.ui.components.attendee.setContent(n)}),t.addEvent("infoChange",function(t){e.ui.updateProfile(t.data);var n=e.model.info.name;e.ui.nodes.title=s.getElement("span.title-bg-r",e.ui.body),e.ui.nodes.title.innerHTML=a.noMoreThan(n,16),e.ui.nodes.title.title=n,e.ui.panels.chat.header.innerHTML=e.ui.nodes.header.innerHTML}),t.addEvent("exit",function(n){clearTimeout(t._exit_action_timeout);var r=['<iq id="123121" to="',e.id,'@muc.talk.renren.com" type="set">\n','	<query xmlns="http://muc.talk.renren.com/quit"/>\n',"</iq>\n\0"].join("");webpager.sendMessage(r,"newProtocal"),e.ui.close()}),e.model=t},this.inviteFriends=function(e,t,n){if(!t.length)return;var r=21-e.model.attendee.length-t.length;if(r<0){n({code:2,msg:"最多容纳21个成员(只能再添加"+(t.length+r)+"个)"});return}new XN.net.xmlhttp({url:"http://message.renren.com/session/join",data:"sessionid="+e.id+"&userid="+t.join(","),onSuccess:function(e){if(!e.responseText){XN.DO.showError("服务器返回异常. ");return}var r=JSON.parse(e.responseText);r.ids=t,n(r)}})},this.updateRoom=function(e,t){e.model.memberList=t.items,e.model.name=t.name,e.model.info={name:t.name},r.setTimeout(function(){e.model.fireEvent("infoChange",{data:e.model.info})}),r.setTimeout(function(){e.model.replaceAttendee(t.items),++e.model.upTime,e.model.fireEvent("roomInfoLoaded",{})})},this.bindEvent=function(e){this.parent(e);var t=e.ui.components.inputer;e.ui.addEvent("invite",function(t){e.inviteFriends
(t.data,function(n){n.code?XN.DO.showError(n.msg):(t.close(),u.friendbook.getFriendsInfo(n.ids,function(t){var n=0;for(n in t)e.model.pushAttendee({id:t[n].userId,tiny:t[n].tiny,name:t[n].userName})}))})}),e.ui.addEvent("exit",function(t){e.model.quit(),webpager.fireEvent("groupExit",{sessionId:e.id}),XN.net.sendStats("http://message.renren.com/statistics/win/quit")}),t.addEvent("lookupHistory",function(t){var n="http://message.renren.com/message/list/"+e.id+"/2";e.lookupHistory(n,t.new_window)}),e.ui.body.addEvent("click",function(t){t.cancelBubble=!0,t.defaultPrevented=!0;var n=s.wrap(t.target);n.hasClass("btn-save-common");if(n.hasClass("btn-set-name")){var r=s.getElement(".chat-name",n.getParent(".chat-panel"));if(r.value.trim()==""){XN.DO.showMessage("讨论组名称不能为空！"),r.focus();return}if(r.value.trim()==e.model.info.name){XN.DO.showMessage("讨论组名称没有改变！");return}var i=['<iq id="create3" to="',e.id,'@muc.talk.renren.com" type="set">\n','	<query xmlns="http://muc.talk.renren.com/config">\n',"		<name>",a.htmlFilter(r.value),"</name>\n","	</query>\n","</iq>\n\0"].join("");e.model.info.name=r.value.trim(),webpager.sendMessage(i,"newProtocal")}if(n.hasClass("exitgroup")){e.model.fireEvent("exit");var o=jxn("#wp-group-list"),u=o.find("dt")[0],f=/(\d+)/.exec(u.innerHTML)[0];f==1&&o.remove(),o.find("dd[uid=g"+e.id+"]").remove(),u.innerHTML="讨论组("+ --f+")"}if(n.hasClass("wp-friend-confirm")){if(n.hasClass("wp-friend-confirm-disable"))return;window.webpager.fs.disableBtn();var l=webpager.fs.memberList,c=[];if(!l.length>0){XN.DO.showMessage("请至少选择一个好友。");return}l.forEach(function(e){c.push("		<member>"+e+"</member>\n")});var i=['<iq id="121" to="',e.id,'@muc.talk.renren.com">\n','	<query xmlns="http://muc.talk.renren.com/invite">\n',c.join(""),"	</query>\n","</iq>\n\0"].join("");webpager.sendMessage(i,"newProtocal")}var h="chat-search";(n.hasClass(h)||s.wrap(n.parentNode)&&s.wrap(n.parentNode).hasClass(h))&&e.buildSearchPanel(),n.hasClass("fbtn")&&e.fbtnSlide(n)}),h.addEvent("message",function(e){var t=webpager.roomKeeper.findRoom(e.data.from);t&&t.updateRoom(e.data)}),window.webpager.addEvent("group_item",function(e){var t=webpager.roomKeeper.findRoom(e.from);setTimeout(function(){t&&h.broadcast(e,1)},0)}),e.ui.addEvent("getRoomInfo",function(){e.model.getRoomInfo()}),e.model.addEvent("message",function(t){e.model.getRoomInfo()})},this.fbtnSlide=function(e,t){if(t.hasClass("fbtn-disabled"))return;if(t.hasClass("fbtn-prev")){var n=parseInt(e.wpGroupchatWrap.css("margin-left"));e.fbtnNext.removeClass("fbtn-disabled");if(e.curPage>=e.maxPage-1){e.wpGroupchatWrap.css("margin-left",0),e.curPage=e.maxPage,t.addClass("fbtn-disabled");return}e.curPage++,e.wpGroupchatWrap.css("margin-left",n+250+"px");return}if(t.hasClass("fbtn-next")){var n=parseInt(e.wpGroupchatWrap.css("margin-left")),r=jxn(".actived .wp-groupchat li").length;e.fbtnPrev.removeClass("fbtn-disabled");if(e.curPage<=e.minPage+1){e.wpGroupchatWrap.css("margin-left",(-r+5)*50+"px"),e.curPage=e.minPage,t.addClass("fbtn-disabled");return}e.curPage--,e.wpGroupchatWrap.css("margin-left",n-250+"px");return}},this.finish=function(e){this.parent(e),e.ui.components.inputer.useFeature("attachment")},this.buildMemberList=function(e){var t=[],n=e.model.memberList||[];for(var r=0;r<n.length;r++)t.push(["		<li>",'			<a href="http://www.renren.com/',n[r].uid,'/profile" target="_blank">','				<img src="',n[r].portrait,'">',"			</a>","			<em>",a.noMoreThan(n[r].name,4,!1,!0),"</em>","		</li>"].join(""));return t.join("")};var e=0,t=null;this.buildSetPanel=function(n){if(!n.model.memberList){e==20&&n.model.getRoomInfo();if(e>40){clearTimeout(t),n.buildSetPanelHtml(),e=0;return}t=setTimeout(function(){e++,n.buildSetPanel()},100)}else clearTimeout(t),n.buildSetPanelHtml(),e=0},this.buildSetPanelHtml=function(e){var t=e.ui;t.panels.status="set",e.hideAllPanels(),$extend(t.panels,{set:{header:{},section:{}}}),jxn(t.nodes.section).find(".set-panel").remove(),t.panels.set.header.innerHTML=e.buildPanelTitle("set","聊天设置"),t.panels.set.section.innerHTML=['<div class="chat-panel set-panel">','	<div class="f-area clearfix">','		<a href="#nogo"  onclick="return false;" class="fbtn fbtn-prev fbtn-disabled"><</a>','		<a href="#nogo"  onclick="return false;" class="fbtn fbtn-next fbtn-disabled">></a>','		<div class="wp-groupchat"><ul class="clearfix">',e.buildMemberList(),'		<li class="chat-search">','			<a href="#nogo"  onclick="return false;">+</a>',"			<em>添加好友</em>","		</li></ul></div>","	</div>",'	<div class="wp-chat-set">',"		<h3>修改讨论组名称</h3>",'		<p><a href="#nogo"  onclick="return false;" class="btn btn-set-name">完成</a><input type="text" class="chat-name" maxlength="20" value=',e.model.info.name,"></p>","	</div>",'		<p class="exitgroup-wrap"><a href="#nogo"  onclick="return false;" class="exitgroup">退出讨论组</a></p>',"</div>"].join(""),jxn(t.nodes.section).append(t.panels.set.section.innerHTML),t.nodes.header.innerHTML=t.panels.set.header.innerHTML;var n=jxn(e.ui.body).find(".wp-groupchat ul"),r=n.find("li").length;n.css("width",r*50+"px"),e.maxPage=Math.floor(r/5),r%5!=0&&(e.maxPage+=1),e.minPage=1,e.curPage=e.minPage,e.wpGroupchatWrap=n,e.fbtnNext=jxn(e.ui.body).find(".fbtn-next"),e.fbtnPrev=jxn(e.ui.body).find(".fbtn-prev"),r>5&&(n.css("margin-left",-(r-5)*50+"px"),e.fbtnPrev.removeClass("fbtn-disabled"))}}),d=new Class(o.ChatroomModel,function(){this.attendee=[],this.attmap={},this.info={},this.settings={notify:!0},this._history_att={},this.initialize=function(e,t){e.id=t.id,e.chatType="muc",e.info=t},this.getGroupInfo=window.webpager.service.getGroupInfo=function(e,t){var n={},r=window.webpager.groupListInfo;return r?(r.forEach(function(e){e.id==t&&(n=e)}),n):n},this.removeMember=function(e,t){var n=e.memberList.length,r=0;for(var i=0;i<n;i++)if(t==e.memberList[i].uid){r=i;break}e.memberList.splice(r,1),e.replaceAttendee(e.memberList)},this.addMember=function(e,t){var n=t.items;if(!e.memberList)return;e.memberList=e.memberList.concat(n),e.replaceAttendee(e.memberList)},this.pushMessage=function(e,t){var n=t.info;n.roomname&&e.info.name!=n.roomname&&(e.info.name=n.roomname,e.fireEvent("infoChange",{data:e.info}));switch(t.type){case"groupchat":var r=e.extendMessage(t);r.attachment=t.attachment,e.fireEvent("message",{data:[r]});break;case"entergroup":e.pushAttendee({id:n.userid,name:t.name,tiny:a.makeHeadTinyurl(t.tiny),status:t.status});break;case"leftgroup":e.pushAttendee({id:n.userid,name:t.name,tiny:a.makeHeadTinyurl(t.tiny),status:0});break;case"exitgroup":a.isMyself(n.userid)?e.fireEvent("exit"):e.delAttendee(n.userid);break;case"settingchange":l.log1("没有处理的群消息: settingChange!!! ",t)}},this.extendMessage=function(e,t){var n=e.getAttendee(t.uid||t.info.userid),r=t.timestamp||new Date;e.msgs.push({chat:t.chat,uid:n.id});var i={avatar:n.tiny||n.portrait||a.resource.url.OFFLINE_IMG,profile:a.makeProfileUrl(n.id||n.uid),id:t.info.roomid,uid:n.uid,name:decodeURIComponent(n.name||t.fname),time:a.getTime(new Date(parseInt(t.timestamp)))||t.time,content:t.chat,attachment:t.attachment,msgkey:t.msgkey,msg_headsrc:t.msg_headsrc,msg_originalsrc:t.msg_originalsrc,msg_audiosrc:t.msg_audiosrc,localid:t.localid,chat_tag:t.chat_tag};return i},this.send=function(e,t,n){var r=a.User,i=+(new Date);e.inputText=t.content;var s=a.htmlFilter(t.content).replace(/  /img,"　"),o=['<message fname="',r.name,'" from="',r.id,'@muc.talk.renren.com/uid" to="',e.id,'@muc.talk.renren.com" type="muc">\n','	<richbody type="dialog" localid="',i,'"><font>',s,"</font></richbody>\n","</message>\n\0"].join(""),s={from:e.id+"@group.talk.xiaonei.com/"+r.name+"(0)-"+r.id,roomid:e.id,to:r.id+"@talk.xiaonei.com/WTalkProxy6_0",content:'{type:"groupchat",info:{roomid:"'+e.id+'",userid:"'+r.id+'"}, chat:"'+s.replace(/\"/img,'\\"').replace(/\\/img,"\\\\")+'"}',attachment:t.attachment||"",msg_headsrc:"",msg_originalsrc:"",msg_audiosrc:"",localid:i};webpager.sendMessage(o,"newProtocal");return},this.replaceHistory=function(e,t){t.sort(function(e,t){if(+e.msgkey>+t.msgkey)return 1;if(+e.msgkey<=+t.msgkey)return-1}),e.msgs=[];var n=[];t.forEach(function(t){var r=XN.json.parse(t.content);r.time=t.time,r.msg_headsrc=t.msg_headsrc,r.msg_originalsrc=t.msg_originalsrc,r.msg_audiosrc=t.msg_audiosrc,r.msgkey=t.msgkey,r.fname=t.fname,r.localid=t.localid,r.timestamp=t.timestamp;var i={service:"group_chat",source:"wpi.renren.com",data:r};n.push(e.extendMessage(r))}),e.fireEvent("historyReplace",{data:n})},this.getRoomSetting=function(e){var t=this;new XN.net.xmlhttp({url:"http://qun.renren.com/qun/"+e.id+"/chatFlag",method:"get",onSuccess:function(t){var n=JSON.parse(t.responseText);n&&n.code==0?(e.settings=n.chatFlag,e.fireEvent("setting")):l.log1("加载群聊roomSetting返回错误 ",n)}})},this.getRoomInfo=function(e,t){if(e.memberList&&!t)return;var n=['<iq id="',+(new Date),'" to="',e.id,'@muc.talk.renren.com" type="get">\n','	<query xmlns="http://muc.talk.renren.com/items"/>\n',"</iq>\n\0"].join("");webpager.sendMessage(n,"newProtocal")},this.replaceAttendee=function(e,t){e.attendee=t;var n={},r=[];t.forEach(function(e){n[e.id||e.uid]=e,r.push(e.id)});var i={name:XN.user.name,uid:XN.user.id,tiny:XN.user.tinyPic};n[i.uid]=i,e.attmap=n},this.getAttendee=function(e,t){var n;return(n=e.attmap[t])?n:(n=e._history_att[t])?n:{tiny:"",name:"",id:t}},this.delAttendee=function(e,t){var n=t.id||t,r=e.attendee.length;for(var i=0;i<r;i++)if(e.attendee[i].id==n){t=e.attendee[i],e.fireEvent("attendeeLeft",{data:e.attendee.splice(i,1)[0]});break}e.fireEvent("attendee",{data:t}),delete e.attmap[n]},this.pushAttendee=function(e,t){e.attmap[t.id]?r.extend(e.attmap[i],t,!0):(e.fireEvent("attendeeIn",{data:t}),e.attendee.push(t),e.attmap[t.id]=t),e.fireEvent("attendee",{data:t})},this._exit_action_timeout=0,this.quit=function(e){clearTimeout(e._exit_action_timeout),new XN.net.xmlhttp({url:"http://message.renren.com/session/quit",data:"sessionId="+e.id,method:"post",onSuccess:function(t){var n=XN.json.parse(t.responseText);n.code==0?e._exit_action_timeout=r.setTimeout(function(){XN.DO.showError("聊天服务器5秒钟还没有响应,请重试.")},5e3):XN.DO.showError(n.msg)},onError:function(){XN.DO.showError("网络通信失败,请重试")}})}}),v=new Class(f.UIcommon,function(){this.initialize=function(e){var t=e.frame=s.wrap(document.createElement("div"));t.innerHTML="loading...",t.className="topic wp-group-members",t.addEvent("click",function(e){var n=e.target;if(n.className!="wp-profile"){while(n.tagName.toLowerCase()!="dd"){if(n===t||n.tagName.toLowerCase()=="dl"||!n.parentNode)return;n=n.parentNode}var r=n.getAttribute("uid");r=parseInt(r),r&&(a.isMyself(r)?XN.DO.showError("不能自言自语-_-！"):u.request("chat/conv/open",r))}})},this.setContent=function(e,t){var n=[];t.length?t.forEach(function(t){n.push(e.makeAttendee(t))}):n.push("<dd>获取到的成员列表为空,可能是服务器返回错误了. </dd>"),e.frame.innerHTML='<dl class="wp-group-list">'+n.join("")+"</dl>"},this.makeAttendee=function(e,t){var n=t.status>0?'<img src="http://a.xnimg.cn/a.gif" title="在线" class="wp-online" />':"",r="http://www.renren.com/profile.do?id="+t.id;return['<dd uid="'+t.id+'"><a href="'+r+'" title="TA的主页" class="wp-profile" target="_blank">个人主页</a>','<a href="#nogo" onclick="return false;" title="与TA单聊" class="wp-g-avatar-box">','<img class="wp-g-avatar" src="'+(t.tinyurl||t.tiny)+'" /></a>','<div class="wp-g-info"><span>'+a.noMoreThan(t.name||t.userName,8)+"</span>"+n+"</div>","</dd>"].join("")},this.appendAttendee=function(e,t){var n=e.makeAttendee(t);e.frame.getElement("dl").appendChild(a.getDom(n))}}),m=new Class(f.WindowWithDrawer,function(){this.__mixins__=[f.UIcomplex],this.initialize=function(e,t){this.parent(e,t);var n=e.nodes;n.title.innerHTML='<p class="header-title" style="height:19px"><a title="设置" class="chatroom-set" href="#nogo" onclick="return false;"></a><span class="title-bg-l"><span class="title-bg-r"></span> </span></p> ',n.setbtn=s.getElement(".chatroom-set",n.title),n.title=s.getElement("span.title-bg-r",n.title);var r=new f.IFeature_invite;n.container.appendChild(r.frame),e.buildTalkflow(),e.buildInputer(),e.nodes.body.style.width="320px"},this.buildAttendeeList=function(e){var t=new v;e._assemble("attendee",t),e.nodes.drawer.appendChild(t.frame)},this.buildTalkflow=function(e){var t={};t.early_btn=!1;var n=new f.TalkFlow(t);e._assemble("talkflow",n),e.nodes.container.appendChild(n.frame),e.addEvent("focus",function(e){setTimeout(function(){n.scrollBottom()},0)})},this.buildInputer=function(e){var t=new f.Inputer({emotion:!0,history:!0});e._assemble("inputer",t),e.nodes.container.appendChild(t.frame)},this.pushDialog=function(e,t,n){var r=e.components.talkflow.pushDialog(t,n);return e._fold&&t.tag!="system"&&t.chat_tag!="self"&&e.highLight(),r},this.updateProfile=function(e,t){setTimeout(function(){var n=jxn(".title-bg-r",e.nodes.header);n.html(a.noMoreThan(t.name,16)),n[0]&&(n[0].title=t.name)},0),e.setHandler(t.name)},this.appendAttendee=function(e,t){e.components.attendee.appendAttendee(t)}});t.GroupChatroom=p}),object.define("webpager/im/roomkeeper","../lib/base, ../lib/tools, ../lib/channel_api, ../service, ../lib/uikit, ./chatroom, ./groupchat, ../ugc, ../ugc/gift",function(e,t,n){var r=e("../lib/base"),i=e("../lib/tools"),s=e("../lib/channel_api"),o=i.getLogger("roomkeeper"),u=i.QA,a=e("../service"),f=a.preferences,l=e("../lib/uikit"),c=e("./chatroom"),h=e("./groupchat"),p=e("../ugc"),d=e("../ugc/gift"),v=new i.Cluster_Client("chat"),m=function(e){if(!e)return;switch(e.service){case"oto_chat":roomKeeper.throwToChatRoom(e);break;case"group_chat":roomKeeper.throwToGroupChatRoom(e);break;case"ugc_chat":if(!e.target){var t=e.data,n=t.feed_actor+"_"+t.feed_source+"_"+t.feed_stype;e.target=n}roomKeeper.dispatch(e);break;case"spam":roomKeeper.processSpam(e)}};t.init=function(e){webpager.imRunning?f.set("im_disabled",!0):(f.get("im_disabled")&&(window.frames.imengine.WPC.reportLogMsg("bug_imDisabled"),t.nlog_once=!0),f.set("im_disabled",!1)),v.addEvent("message",function(e){if(e.data&&e.data.tag=="notifySys"){var t=roomKeeper.findRoom(e.data.roomid);t&&(t.model.fireEvent("message",{data:[{content:e.data.msg,tag:"system"}]}),t.buildChatPanel());return}if(e.data&&e.data.tag=="clearInput"){var t=roomKeeper.findRoom(e.data.roomid);t&&t.ui.fireEvent("room_input_reset",{});return}if(e.data&&e.data.tag=="error"){var t=roomKeeper.findRoom(e.data.id);t&&XN.Do.showMessage(e.data.msg);return}if(e.data&&e.data.tag=="sr_error"){var t=roomKeeper.findRoom(e.data.id);t&&(t.ui.components.inputer.nodes.text.value=t.model.inputText);return}if(e.data&&e.data.tag=="addMember"){var t=roomKeeper.findRoom(e.data.roomid);t&&t.model.addMember(e.data);return}if(e.data&&e.data.tag=="removeMember"){var t=roomKeeper.findRoom(e.data.from);t&&t.model.removeMember(e.data.uid);return}o.log1("收到一条cluster广播: ",e),e.data.posted=1,m(e.data)}),webpager.addEvent("notifyClearInput",function(e){var t={tag:"clearInput",roomid:e.roomid};v.broadcast(t,1)}),window.webpager.addEvent("chat_error",function(e){var t;e.type=="sr"?t={tag:"sr_error",id:e.to}:t={tag:"error",msg:e.info,id:e.from},v.broadcast(t,1)}),window.webpager.addEvent("group_info",function(e){var t={tag:"error",msg:e.description,id:e.groupid};v.broadcast(t,1)}),window.webpager.addEvent("group_inviteitem",function(e){var t=e;t.tag="addMember",v.broadcast(t,1)}),window.webpager.addEvent("group_quititem",function(e){var t=e;t.tag="removeMember",v.broadcast(t,1)}),webpager.addEvent("notifySys",function(e){var t={tag:"notifySys",msg:e.msg,roomid:e.roomid};v.broadcast(t,1)}),a.messager.addEvent("message",function(e){m(e.sgl)}),roomKeeper.init(),g.init(e),e.addEvent("remove",function(e){var t=roomKeeper.findRoom(e.data);t&&t.zombie()})},roomKeeper={rooms:{},_rooms_pending:{},_rooms_dead:{},init:function(){var e=this;i.pagerTimer.addEvent("timeout",function(t){var n=e._rooms_dead;for(var r in n)t.timestamp-n[r]._dead>6e5&&(n[r].destroy(),delete n[r])}),a.notify.addEvent("load",function(t){e.validNotify()})},dispatch:function(e){o.log1("messager发布的signal",e);var t=this,n=e.target,r=t.findRoom(n);if(e.action=="create"||!r){if(r)return;t._rooms_pending[n]=[],t.buildRTChatroom(e,function(r,i){if(r){t._rooms_pending[n]="dead";return}if(i){var s=t._rooms_pending[n];t.addRoom(i,n),i.signal(s)}e.posted||v.broadcast(e),e.callback&&e.callback(r)});if(e.action=="create")return}if(r&&r.signal)r.signal(e),e.posted||v.broadcast(e);else{if(!(t._rooms_pending[n]instanceof Array))throw new Error("findRoom的结果不是新概念UGC聊天室,pendding列表中没有该roomId对应的信号队列");t._rooms_pending[n].push(e)}},throwToChatRoom:function(e){try{t.nlog_once&&(window.frames.imengine.WPC.reportLogMsg("bug_missed_msg"),t.nlog_once=!1)}catch(n){}f.get("im_disabled")&&e.source=="user"&&(f.set("im_disabled",!1),f.set("quiet_mode",!1)),o.log1("收到新单聊消息",e);var r=this,s=e.data,l=i.isMyself(s.fromuin)?s.touin:s.fromuin;if(f.get("ban_stranger")&&e.source!="webpager"&&e.source!="user"){var h=this.findRoom(l,!0);!h&&!a.friendbook.getLocalFriend(l),h=this.findRoom(l)}else var h=this.findRoom(l);if(!h)try{h=new c.ConvChatroom(l),r.addRoom(h,l);if(e.source=="wpi.renren.com"){h.model.pushMessage(s),h.model.loadHistory();return}}catch(n){o.err(n),u.reportExpt("creatOTOChatroom",n,l)}switch(e.source){case"user":h.ui.unfold(!0,!0),s.unread&&h.loadEarlyMsg(s.unread,"clear");break;case"webpager":break;default:h.model.pushMessage(s)}},throwToGroupChatRoom:function(e){o.log1("收到新群聊天消息",e);var t=this;try{var n=e.data,r=n.type,i=n.info,s=t.findRoom(i.roomid,!0);if(!s){if(r!="groupchat"&&r!="settingchange")return;var a={id:i.roomid,memberList:i.memberList,name:i.roomname};s=new h.GroupChatroom(i.roomid,a),t.addRoom(s,i.roomid)}}catch(f){o.log1(f.stack),u.reportExpt("createGroupChatroom",f,JSON.stringify(e.data))}switch(e.source){case"user":s.ui.unfold(!0,!0);break;case"webpager":break;default:s.model.pushMessage(n)}},buildRTChatroom:function(e,t){if(e.data.rt_topic){new d.GiftChatroom(e.target,e.data,function(e,n){t&&t(e,n)});return}try{p.makeRoom(e.target,e.data,function(e,n){e&&(n.destroy(),o.log1("该实时化类型业务逻辑决定不展示这一次实时化: "+e)),t&&t(e,n)})}catch(n){t&&t(n,null),o.err(n),u.reportExpt("createUgcChatroom",n,JSON.stringify(e.data))}},processSpam:function(e){var t=e.data,n=t.to,r=this.findRoom(n,1);r&&r.model.sysMessage(t)},findRoom:function(e,t){var n=this.rooms[e]||this._rooms_pending[e];return n?n:t?null:(n=this._rooms_dead[e],n?(n.resume(),this.addRoom(n,e,!0),delete this._rooms_dead[e],n):null)},addRoom:function(e,t,n){var r=this;g.addWindow(e.ui,t,n),this.rooms[t]=e,r._rooms_pending[t]&&delete r._rooms_pending[t],r.validNotify(e,t),e.addEvent("dead",function(n){delete r.rooms[t],r._rooms_dead[t]=e,e.removeEvent("dead",arguments.callee)}),e.addEvent("signal",function(t){var n={actor:t.actor,action:t.action,data:t.data,service:e.service,target:e.id};v.broadcast(n,!!t.forall)})},validNotify:function(e,t){var n=this;if(e&&t)a.notify.valid(t)&&e.ui.highLight();else{var r=n.rooms,i;for(i in r)a.notify.valid(r[i].id)&&r[i].ui.highLight()}}};var g={winSlider:null,_timestamp:0,skey:"winslider_layout",winInfo:{},init:function(e){var t=this;t.slider=e,t.cluster=new i.Cluster_Client("winslider_layout"),t.slider.addEvent("changed",function(e){e.data&&(o.log2("窗口布局有改变",e.data),t.cluster.broadcast(e.data)),t.save()}),t.cluster.addEvent("message",function(e){var n=e.data,r=t.slider;r.applyChange(n),t.save()});try{window.webpager.addEvent("groupListReady",function(e){if(window.webpager.isGroupLoaded)return;window.webpager.isGroupLoaded=!0,t.load()})}catch(n){window.frames.imengine.WPC.reportExpt("roomKeeper_layout_load",n,"")}},load:function(){var e=this,t=s.persistMgr.storageGet(this.skey,1);if(t){t=JSON.parse(t);if(t.t!=XN.cookie.get("t"))return;var n=t.stats;o.log1("总共有"+t.order.length+"个窗口需要重建"),t.order.forEach(function(t){var r=n[t].rebuild;if(!r)return;e.slider.addPlaceholder(n[t]),r.source||(r.source="webpager");try{r.action="create",m(r)}catch(i){console.error(i)}})}},addWindow:function(e,t,n){var r=this;this.slider.appendWindow(e,t,n)},isInStack:function(e){return this.isInStack(e)},save:function(){var e=this;if(!e.cluster.isMaster())return;var t=this.slider.getOrder(),n=e.slider.getStats(),r={t:XN.cookie.get("t"),order:t,stats:n};s.persistMgr.storageSet(e.skey,JSON.stringify(r),1,1),o.log2("保存了布局: ",JSON.stringify(r))}},y=function(e,t){o.log1("通过消息打开一个单聊窗口");var n={service:"oto_chat",data:{fromuin:e,touin:i.User.id},source:"user"};t&&(n.data.unread=t),v.broadcast(n,1)},b=function(e,t){if(!e||!e.length)return!1;var n=[];for(var r=0;r<e.length;r++)n.push("			<member>",e[r],"</member>\n");if(e.length>100)return XN.DO.showError("一个群最多100个成员。"),!1;var i=['<iq id="1" type="set">\n','	<query xmlns="http://muc.talk.renren.com/create">\n','		<item name="',t.join(","),'" >\n',n.join(""),"		</item>\n","	</query>\n","</iq>\n\0"].join("");return webpager.sendMessage(i,"newProtocal"),!0},w=function(e){var t={info:{roomid:e},type:"groupchat"},n={service:"group_chat",data:t,source:"user"};v.broadcast(n,1)},E={18:"701",16:"502",14:"chat"};a.regService("notify/view",function(e,t,n,r){var i=!1;if(typeof e=="string"){e=e.split("-");var s=E[e[0]];e=e[1];var o=t.match(/&uid=(\d+)/)[1]}else{if(typeof e!="object")return;var u=e,o=u.actor,s=u.stype;e=u.source,i=t}if(i||f.get("notify_viewer")&&s){var a={feed_actor:o,feed_source:e,feed_stype:s},l={service:"ugc_chat",action:"create",source:"notify/view",actor:"user",data:a,callback:function(e){if(!e)return;var t=['<p style="background:url(http://a.xnimg.cn/imgpro/icons/error.png) no-repeat;padding-left:70px;margin:15px" >',"获取消息失败,请点击下面的链接到终端页查看<br/>",'<a href="'+r+'" target="_blank">点这里</a>',"</p>"].join(""),n=new XN.ui.dialog({title:"消息提醒",noFooter:!0,showCloseButton:!0,message:t});n.body.addEvent("click",function(e){e.target.tagName.toLowerCase()=="a"&&n.remove()})}},c={service:"ugc_chat",action:"focus",actor:"user",source:"notify/view",data:a};return m(l),m(c),1}return 0}),a.regService("chat/group/create",b),a.regService("chat/group/start",w),a.regService("chat/conv/open",y),webpager.roomKeeper=roomKeeper,window.talkto=function(e,t){a.request("chat/conv/open",e)}}),object.define("webpager/im/preferpanel","../lib/base, ../service, ../lib/tools, ../lib/uikit, ../lib/channel_api",function(e,t,n){var r=e("../lib/base"),i=r.dom,s=e("../service"),o=e("../lib/tools"),u=e("../lib/uikit"),a=s.preferences,f=new Class(u.UIcommon,function(){this._dropdown=!1,this.initialize=function(e,t){var n=e.buildFrame();e.showBirthday=parseInt(XN.user.id)%10==8||parseInt(XN.user.id)%10==7||parseInt(XN.user.id)%10==1||parseInt(XN.user.id)==229528266&&!XN.browser.IE6,e.getUIRef(),e.bindEvent(),e.getStrangerState()},this.getStrangerState=function(e){var t=['<iq id="',+(new Date),'"  type="get">\n','	<query xmlns="http://blockstranger.talk.renren.com/blockstranger" />\n',"</iq>\n\0"].join("");webpager.sendMessage(t,"newProtocal"),window.webpager.addEvent("setStrange",function(t){var n=jxn(e.frame).find("dd[key='ban_stranger']");a.get("ban_stranger")?(n.removeClass("pref-on"),a.set("ban_stranger",!1)):(n.addClass("pref-on"),a.set("ban_stranger",!0))}),window.webpager.addEvent("getStrange",function(e){var t=+e.blockvalue?!0:!1;a.set("ban_stranger",t)})},this.setStrangerState=function(e,t){var n=jxn(e.frame).find("dd[key='ban_stranger']"),r=['<iq id="',+(new Date),'"  type="set">\n','<query xmlns="http://blockstranger.talk.renren.com/blockstranger">\n',"<blockvalue>",t,"</blockvalue>\n","</query>\n","</iq>\n\0"].join("");webpager.sendMessage(r,"newProtocal")},this.makeFrameHTML=function(e){var t=['<div class="wp-preferences">','	<a class="pref-btn">O</a>','	<dl class="pref-menu" style="display:none">',"	</dl>","</div>"].join("");return t},this.makeListHTML=function(e){var t="";e.showBirthday&&(t="<dd "+(a.get("quiet_birthday")?'class="pref-on"':"")+' key="quiet_birthday"><a>屏蔽生日提醒</a></dd>');var n=["<dd "+(a.get("ban_stranger")?'class="pref-on"':"")+' key="ban_stranger"><a>屏蔽陌生人消息</a></dd>',"<dd "+(a.get("quiet_mode")?'class="pref-on"':"")+' key="quiet_mode"><a>关闭声音提醒</a></dd>',t];return o.whiteList.checkSpread()&&(a.isSet("notify_viewer")||a.set("notify_viewer",!0),n.push("<dd "+(a.get("notify_viewer")?'class="pref-on"':"")+' key="notify_viewer"><a>小窗查看提醒</a></dd>')),n.join("")},this.getUIRef=function(e){var t=e.frame,n={btn_gear:i.getElement("a.pref-btn",t),list:i.getElement("dl.pref-menu",t)};e.nodes=n},this.bindEvent=function(e){var t=e.nodes;e.frame.addEvent("click",function(e){e.cancelBubble=!0}),t.btn_gear.addEvent("click",function(t){e._dropdown?e.pickup():e.dropdown()}),t.list.addEvent("click",function(t){var n=t.target;n.tagName.toLowerCase()=="a"&&(n=n.parentNode),e.onClick(n)})},this.dropdown=function(e){e.nodes.list.innerHTML="",e.nodes.list.appendChild(o.parseHTML(e.makeListHTML())),e.nodes.list.show(),e._dropdown=!0;var t=i.getElement(".birthday-box",i.getElement("#webpager"));t&&t.getStyle("display")=="inline-block"&&(t.style.display="none")},this.pickup=function(e){e.nodes.list.hide(),e._dropdown=!1},this.onClick=function(e,t){var n=t.getAttribute("key");if(!n)return;var r=i.getElement(".birthday-remind",i.getElement("#webpager"));if(t.className.indexOf("pref-on")<0){if(n=="ban_stranger"){e.setStrangerState(1);return}t.className="pref-on",a.set(n,!0),r&&n=="quiet_birthday"&&(r.style.display="none")}else{if(n=="ban_stranger"){e.setStrangerState(0);return}t.className="",a.set(n,!1);if(r&&n=="quiet_birthday"){r.style.display="block";var s=i.getElement(".birthday-box",i.getElement("#webpager"));s&&s.getStyle("display")=="block"&&(s.style.display="none")}}}});t.PreferMenu=f}),object.define("webpager/im/birthday","../lib/base,../service",function(e,t,n){var r=e("../lib/base"),i=r.dom,s=e("../service"),o=s.preferences;t.birthdayRemind=new Class(function(){this.cookie=window.frames.imengine.WPC.cookie,this.userid=XN.user.id,this.initialize=function(e,t,n){function i(){new XN.net.xmlhttp({url:"http://gift.renren.com/api/mainpage/birthdaystatus",data:"id="+e.userid,method:"POST",onSuccess:function(n){if(n.responseText=="false"){jxn.storage.set("webpager_showBirthday",1);return}jxn.storage.set("webpager_showBirthday",2),e.getBirthdayData(t)},onError:function(e){jxn.storage.set("webpager_showBirthday",0)}})}this.prefer_menu=n,e.newDay=!1;var r=new Date;jxn.storage.get("webpager_birthdayNewDate")?jxn.storage.get("webpager_birthdayNewDate")!=r.getDate()&&(jxn.storage.set("webpager_birthdayNewDate",r.getDate()),e.newDay=!0):jxn.storage.set("webpager_birthdayNewDate",r.getDate()),jxn.storage.get("webpager_showBirthday")||jxn.storage.set("webpager_showBirthday",0);if(e.newDay)i();else if(jxn.storage.get("webpager_showBirthday")==0)i();else{if(jxn.storage.get("webpager_showBirthday")==1)return;jxn.storage.get("webpager_showBirthday")==2&&e.getBirthdayData(t)}},this.getBirthdayData=function(e,t){var n=document.createElement("div"),r=['<div class="birthday-box">','<div class="header">',"   <h4>今日寿星</h4>",'   <a id="birthdayminimize" class="minimize" label="最小化" title="最小化"></a>','   <a id="birthdayclose" class="close" title="关闭"></a>',"</div>",'<div class="bir-content"><ul>',"</ul>","</div>","</div>",'<div class="panelbarbutton" style="width:33px;padding:0;"><a class="birthday-btn" href="#nogo"  onclick="return false;"></a></div>'].join("");n.className="popupwindow birthday-remind",n.appendChild(i.getDom(r)),this.frame=n;var s=i.getElement("#webpager #friends-panel");s.insertBefore(n,s.lastChild);var u=new Date,a="bt_re";if(!e.cookie.get(a)||e.cookie.get(a)==u){e.cookie.set(a,u.getDate()+1,365);var f=i.getElement(".panelbarbutton",this.frame);f.addClass("birthday-btn-hovered")}var l=o.get("quiet_birthday");l&&jxn("#webpager .birthday-remind").hide(),jxn(".panelbarbutton").bind("click",function(){jxn(".panelbarbutton").unbind("click",arguments.callee);var n=this,r=i.getElement(".birthday-box",this.frame),s=i.getElement(".panelbarbutton",this.frame);new XN.net.xmlhttp({url:"http://gift.renren.com/api/mainpage/birthdaydates",data:"id="+e.userid,method:"POST",onSuccess:function(n){var r=JSON.parse(n.responseText);e.renderFrame(r,t),jxn(".birthday-box").show()},onError:function(e){}})})},this.renderFrame=function(e,t,n){e.buildFrame(t),e.bindEvent(n)},this.buildFrame=function(e,t){var n="",r=document.createElement("div");for(var i=0;i<t.length;i++){var s=t[i].receiveGiftNum+"人已祝福";t[i].receiveGiftNum<1&&(s="抢先送祝福");var o=["<li>",'   <a target="_blank" class="head"  href="http://www.renren.com/',t[i].id,'/profile"> <img src="',t[i].head_url,'" width="35" height="35" title="',t[i].name,'" class="imgclick" /></a>','   <div class="info">','       <a target="_blank" class="giftheadurl" href="http://www.renren.com/',t[i].id,'/profile">',t[i].name.substring(0,5),'<img src="http://a.xnimg.cn/webpager/cssimg/birthday2.gif" /></a>',"       <p>",s,"</p>","   </div>",'   <a class="gift" href="#nogo" onclick="return false;" dataid="',t[i].id,'" href="',t[i].head_url,'">祝福TA</a>',"</li>"].join("");n+=o}jxn(".bir-content ul").empty().append(jxn(n))},this.bindEvent=function(e,t){var n=this,r=i.getElement(".panelbarbutton",this.frame),s=i.getElement(".birthday-box",this.frame),o=i.getElement(".bir-content",this.frame),u=i.id("birthdayminimize"),a=i.id("birthdayclose"),f=i.getElement("#webpager .birthday-remind");o.addEvent("click",function(e){var t=i.wrap(e.target);t.hasClass("giftheadurl")&&new XN.net.xmlhttp({url:"http://gift.renren.com/api/mainpage/usemainpagename",data:"",method:"POST",onSuccess:function(e){}}),t.hasClass("imgclick")&&new XN.net.xmlhttp({url:"http://gift.renren.com/api/mainpage/usemainpageimage",data:"",method:"POST",onSuccess:function(e){}});if(t.hasClass("gift")){var n=t.getAttribute("dataid");XN.loadFiles(["http://a.xnimg.cn/xnapp/giftpro/home/birthdayTip/css/birth.css","http://a.xnimg.cn/xnapp/giftpro/home/birthdayTip/js/birth.15400.js","http://a.xnimg.cn/xnapp/giftpro/js/xn.alertChange.15343.js","http://s.xnimg.cn/a13589/jspro/xn.ui.pager.js","http://s.xnimg.cn/xnapp/common/js/swfobjectv2.2.1558.js"],function(){object.use("xn/birthGiftFlow",function(e){new e.birthGiftFlow(n)})})}}),r.addEvent("click",function(){var e=i.getElement("#webpager .pref-menu");r.removeClass("birthday-btn-hovered"),s.getStyle("display")=="none"?(s.show(),t.fold(),e.getStyle("display")=="block"&&n.prefer_menu.pickup()):s.hide()}),u.addEvent("click",function(e){s.style.display="none",r.removeClass("birthday-btn-hovered")}),a.addEvent("click",function(e){f.style.display="none",r.removeClass("birthday-btn-hovered")}),t.nodes.bar.addEvent("click",function(){t._fold||(s.style.display="none")})}})}),object.define("webpager/buddy","./lib/base, ./service/friendbook, ./service/ubbparser,./service, ./lib/tools, ./buddy/buddywin, ./lib/channel_api",function(e,t,n){var r=e("./lib/base"),i=e("./service/friendbook"),s=e("./service"),o=e("./lib/tools"),u=e("./buddy/buddywin"),a=e("./lib/channel_api"),f=e("./service/ubbparser"),l=r.dom,c=r.events,h=null,p=null,d={nodes:{},init:function(e){var t=this;e.nodes.handler.addClass("wp-friend-ico"),this.nodes.domBtn=e.nodes.handler,this.nodes.frame=e.nodes.frame,e.addEvent("unfocus",function(e){t.foldMode(!0)}),e.addEvent("focus",function(e){t.foldMode(!1)}),t.foldMode(e._fold)},foldMode:function(e){if(!e){this.nodes.domBtn.title="收起";var t=""}else{var n=i.getOnlineCount();this.nodes.domBtn.title="展开列表";var t='好友列表<span class="wp-frid-num"></span>'}this.nodes.domBtn.innerHTML=t}};window.webpager.initGroupList=function(e){setTimeout(function(){window.webpager.fireEvent("groupLoaded",{})},0);var t=e.length;if(!t>0||l.id("wp-group-list"))return;var n="";for(var r=0;r<t;r++)n+=['<dd uid="g',e[r].id,'">','<a href="#nogo" class="wp-f-avatar-box"><img class="wp-f-avatar" src="http://a.xnimg.cn/webpager/res/group-avatar.png"',"></a>",'<div class="wp-f-info"><span title="',e[r].name,'"><em>',o.noMoreThan(e[r].name,7,!1,!0),"</em>(",e[r].count,")","</span></div></dd>"].join("");var i=['<dl class="wp-list-open" id="wp-group-list"><dt title="点击展开">讨论组(',t,")</dt>",n,"</dl>"].join("");jxn(".wp-frid-list:first").find("dl:first").before(jxn(i))};var v=function(){i.ready(function(){function e(e){var t=[],n=e.length;for(var r=0;r<n;r++){var s={};s.title=e[r],s.count=i.getBuddiesInCat(e[r]).length,t.push(s),s=null}return t}function t(){var e=['<dl class="wp-list-open" id="wp-site-msg">','<dt title="站内信" class="site_msg">站内信</dt>',"</dl>"].join("");jxn(".wp-frid-list:first").append(e)}function n(e,t){var n=t=="u"?"chat":"muc",r=['<iq id="',e,'" type="get">\n','<query xmlns="http://',n,'.talk.renren.com/latestmsgs">\n','<item id="',e,'" lmax_msgid="0" count="2"/>\n',"</query>\n","</iq>\n\0"].join("");window.webpager.sendMessage(r,"newProtocal"),setTimeout(function(){var t=webpager.roomKeeper.findRoom(e);if(!t)return;t.ui.components.talkflow.replaceContent([],function(){}),t.getHistoryMessage(t.ui,function(e){var n=e.chatlist,r=n.length;t.model.upTime=2;for(var i=0;i<r;i++){var s=
XN.json.parse(n[i].info),u=XN.json.parse(n[i].content),a=u.contenttype=="0"?o.htmlFilter(u.content):u.content;f.hasUbb(a)&&(a=f.parseTxt(a));var l={avatar:o.makeHeadTinyurl(s.head),name:n[i].name,time:o.getTime((new Date(n[i].time)).getTime()),id:s.id,content:a,profile:o.makeProfileUrl(s.id)};t.ui.pushDialog(l,t.getDialogTemplate(l))}var c=n[n.length-1].sessionId;if(!c)return;t.upMaxMsgKey(c);var h={msgkey:c,uid:t.model.id};t.buildRR(h,1)})},400)}function a(){if(jxn("#wp-sn-new")[0])return;setTimeout(function(){jxn("#friends-panel").append('<img src="http://a.xnimg.cn/a.gif" id="wp-sn-new"/>')},0)}function c(e){var t=l.id("wp-sn-list"),n=l.getElements("dd",t),r=n.length,i=null;if(!t)return;for(var s=0;s<r;s++){var o=n[s].getAttribute("uid");k=o.substr(1);if(k==e){i=n[s];break}}return i}function h(e){var t=e.chat_type,n=e.from,r,i=1,s,a,f=l.id("wp-sn-list"),c=0,h=jxn(f).find("dt"),p=e.count;f&&(c=u.ddFindDtNum(f));if(t=="muc")r="g",s=window.webpager.service.getGroupInfo(null,n).name,a="http://a.xnimg.cn/webpager/res/group-avatar.png";else{r="u";var d=window.webpager.service.getUser(null,n);s=d.userName,a=d.tiny,s||new XN.net.xmlhttp({url:"http://notify.renren.com/wpi/getuserinfo2.do",data:"uids="+d.id,method:"get",onSuccess:function(e){var t=XN.json.parse(e.responseText),n={name:t[d.id].userName,from:d.id};setTimeout(function(){window.webpager.fireEvent("updateGroupName",n)},1e3)}})}var v=['<dd uid="',r,e.from,'">','	<a href="#nogo" class="wp-f-avatar-box">',"		<var>",p,'</var><img class="wp-f-avatar" src="',a,'" alt="头像">',"	</a>",'	<div class="wp-f-info">','<span title="',s,'"><em>',o.noMoreThan(s,7,!1,!0),"		</em></span>","	</div>","</dd>"].join(""),m=['<dl class="wp-list-close" id="wp-sn-list"><dt title="点击收起">未读消息(',i,")</dt>","	</dl>"].join("");if(f){var g=jxn(f).find("dd[uid="+r+e.from+"]");if(!g.length){jxn(f).append(v),i=+c+i,h[0].innerHTML=h.html().replace(/\d{1,}/,i);return}g.find("var").html(e.count),h[0].innerHTML=h.html().replace(/\d{1,}/,c);return}jxn(".wp-frid-list:first").find("dl:first").before(jxn(m)),setTimeout(function(){jxn("#wp-sn-list").append(v)},0)}function v(){u.init(p,{cats:i.getCats(),onlineCount:i.onlineCount,catsWithCount:e(i.getCats())}),window.webpager.groupListInfo&&window.webpager.initGroupList(window.webpager.groupListInfo),t(),u.ui.gspList.addEvent("click",function(e){var t=e.target,n;if(t.tagName.toLowerCase()=="dt"){n=t.parentNode.title;if(l.wrap(t).hasClass("site_msg"))return;u.showCat(n,i.getBuddiesInCat(n))}});var n=l.getElements("dt",u.ui.gspList);(function(){var e=l.getElements("dt",u.ui.gspList),t=e[0];dt1=e[1];if(!t)return;dt=dt1;var n=dt.parentNode.title;dt.parentNode.className="wp-list-close",dt.title="点击收起",u.showCat(n,i.getBuddiesInCat(n))})()}p.enable(),d.init(p),window.webpager.sn={},window.webpager.getChatLastestMsg=n;var r=[];window.webpager.handleSN=function(e){var t=window.webpager.roomKeeper.findRoom(e.from);if(e.from in window.webpager.sn&&e.count==window.webpager.sn[e.from].count)return;window.webpager.sn[e.from]={count:i};if(t&&e.count==0&&t.ui._highlight)t.ui.highLight(-1),t.ui.fireEvent("focus",{focus:!1}),t.ui.message();else{if(t&&e.count>0&&t.ui._highlight){var n=e.chat_type=="chat"?"u":"g";window.webpager.clearGroupUntreat(e.from,n,!0);return}t&&(e.count=0)}var i=e.count,s="wp_sn_list",o=webpager.getItem(s)||"{}",u=l.id("wp-group-list");o=JSON.parse(o);if(e.count>0){r.push(e),setTimeout(function(){var e=r.length;r.forEach(function(t,n){o[t.from]=JSON.stringify(t),a(),n==e-1&&(webpager.setItem(s,JSON.stringify(o)),r=[])})},1500);if(!u)return;h(e)}else{var n=e.chat_type=="chat"?"u":"g";window.webpager.clearGroupUntreat(e.from,n)}},setTimeout(function(){var e=webpager.getItem("wp_sn_list")||"{}";e=JSON.parse(e);var t=!1;for(var n in e)t=!0;if(!t)return;a()},2500),window.webpager.handleLastMessage=function(e,t){var r=c(e);if(!r)return;n(e,t),window.webpager.clearGroupUntreat(e,t)},window.webpager.clearGroupUntreat=function(e,t,n){var r=c(e),i=l.id("wp-sn-list"),s="wp_sn_list",o=!1;if(!i||!e||!r)return;jxn(r)[0].style.display=="none"&&(o=!0);if(!n){jxn(r).remove();var a=webpager.getItem(s)||"{}";a=JSON.parse(a),delete a[e],delete window.webpager.sn[e],webpager.setItem(s,JSON.stringify(a))}else jxn(r).hide();var f=u.ddFindDtNum(i);o&&f++,f>1?jxn(i).find("dt")[0].innerHTML=jxn(i).find("dt").html().replace(/\d{1,}/,--f):n?(jxn(i).hide(),jxn("#wp-sn-new").remove()):(jxn(i).remove(),jxn("#wp-sn-new").remove())},window.webpager.addEvent("groupLoaded",function(){var e=webpager.getItem("wp_sn_list");if(!e)return;e=JSON.parse(e);for(var t in e){var n=window.webpager.roomKeeper.findRoom(t);h(JSON.parse(e[t])),n&&function(e){setTimeout(function(){var t=window.webpager.roomKeeper.findRoom(e),n=t.model.chatType=="muc"?"g":"u";window.webpager.clearGroupUntreat(e,n,!0)},500)}(t)}}),p._fold?p.addEvent("focus",function(e){v(),p.removeEvent("focus",arguments.callee)}):v(),u.addEvent("search_change",function(e){var t=e.data,n;if(!t){u.showBuddyList();return}i.asyncSearch(t,function(e){if(!e.candidate.length)u.renderNoResult(t);else{for(var n=0;n<e.candidate.length;n++)e.candidate[n].userId=e.candidate[n].id,e.candidate[n].userName=e.candidate[n].name,e.candidate[n].tiny=e.candidate[n].head;u.renderSearchResult(e.candidate),u.upDownSlcting(!1)}})}),u.addEvent("selected",function(e){XN.net.sendStats("http://message.renren.com/statistics/wp/friend");var t=e.data,n=t.charAt(0);t=t.substr(1);switch(n){case"g":s.request("chat/group/start",t);break;case"u":s.request("chat/conv/open",t)}var r=window.frames.imengine.WPC.cookie,i="chrome-ntc-slient1day";if(window.webkitNotifications&&window.webpager.notificationPermission()==1){var o=r.get(i);if(o&&parseInt(o)>=2)return;webpager.notificationRequest(function(e){switch(e){case 1:UGC.Network.ping.clickStream("900","101","Notify.Chrome.notifications.cancel");break;case 2:UGC.Network.ping.clickStream("900","102","Notify.Chrome.notifications.refused");break;case 0:UGC.Network.ping.clickStream("900","100","Notify.Chrome.notifications.allow"),window.webpager.notificationShow({head:"http://a.xnimg.cn/n/core/res/webpager/notifications.gif",name:"操作成功",content:"您已经成功开启桌面提醒功能,Chrome浏览器专有哦."})}r.set(i,"2",1)})}})})},m=function(e){function t(){var t=document.createElement("div");t.className="wp-guide",t.style.display="block",t.innerHTML=['<a href="#nogo" onclick="return false;" class="wp-guide-remove" tag="remove" title="关闭">&nbsp;</a><div class="text"><a href="javascript:;" class="guide-icon">&nbsp;</a>来看我啦？有啥吩咐您<a href="javascript:;" class="talk">说话</a>^-^</div><span>&nbsp;</span>'].join(""),l.wrap(t);var n=l.getElement("#bottombar");n.insertBefore(t,n.firstChild),t.addEvent("click",function(e){var n=e.target;if(n.getAttribute("tag")&&n.getAttribute("tag")=="remove"){var r=window.imengine.imHelper.getCookie("wp-guide");r?window.imengine.imHelper.setCookie("wp-guide",parseInt(r)+1,7):window.imengine.imHelper.setCookie("wp-guide",1,7),t.dispose()}(n.className=="talk"||n.className=="guide-icon")&&XN.profile_owner&&webpager.service.request("chat/conv/open",XN.profile_owner)}),e.addEvent("focus",function(){t.dispose()})}};t.init=function(e){window.webpager.addEvent("updateGroupName",function(e){jxn("#wp-group-list dd, #wp-sn-list dd").each(function(t){var n=jxn(t).attr("uid").slice(1);e.from==n&&jxn(t).find(".wp-f-info em").text(o.noMoreThan(e.name,7,!1,!0))})}),h=e.nodes,p=e,e.nodes.body.addClass("friends-window"),e.nodes.container.addClass("wp-frid-box"),e.nodes.handler.addEvent("click",function(){XN.net.sendStats("http://message.renren.com/statistics/wp/list")}),e.addEvent("focus",function(e){u.ready(function(){e.focus&&u.searchFocus()})}),e.addEvent("resize",function(e){if(!e.height)return;u.container_height=e.height,u.setPanelHeight()});var t=!1;p.disable({color:"#f5f6f9",opacity:1},'<p style="position:relative;width:90px;margin:auto;top:50%">好友加载中&nbsp;<img src="http://a.xnimg.cn/n/core/res/loading.gif"></img></p>'),p.nodes.handler.innerHTML="",v(),setTimeout(function(){m(p),window.webpager.addEvent("group_list_load",function(){})})}}),object.define("webpager/buddy/buddywin","../lib/jqtpl, ../lib/base, ../lib/tools,../FriendSelect,../lib/uikit",function(e,t,n){function S(e){var t=jxn(e).find("dt").html(),n=/(\d+)/,r=n.exec(t)[0];return r}var r=e("../lib/jqtpl"),i=e("../lib/base"),s=e("../lib/tools"),o=e("../FriendSelect"),u=e("../lib/uikit"),a='<!--module{name:\'tpl/buddy/buddy_win\'}--><article><section class="wp-frid-list"><!-- 好友内容显示在这里 -->        {{each(i, cat) cats}}		{{if cat.title == \'最近联系\'}}        <dl class="wp-list-open" title="${cat.title}" id="wp-list-recent">		{{else}}		<dl class="wp-list-open" title="${cat.title}">		{{/if}}			<dt title="点击展开">${cat.title}(${cat.count})</dt></dl>        {{/each}}    </section><section class="wp-frid-list wp-frid-search" style="display:none;"></section><footer><div class="wp-searchbox"><form method="post" action="#" onsubmit="return false;"><input type="text" onsubmit="return false;" id="webpager_friend_search" /></form></div><div class="buddy-clent-ad"><p><a href="http://im.renren.com/desktop/rrsetup-54.exe?wp01" target="_blank"><img src="http://a.xnimg.cn/webpager/cssimg/download-icon.png"><var>隐身登录，悄悄在线-人人桌面</var></a></p></div></footer></article>',f='<!--module{name:\'tpl/buddy/buddy_groups\'}-->{{each(i, group) buddies}}{{if !group.title}}<dl class="wp-list-close">{{else}}<dl class="wp-list-open">{{/if}}</dl>{{/each}}',c='<!--module{name:\'tpl/buddy/aBuddy\'}-->{{if type==2}}<dd uid="g${userId}" title="${title}">{{else}}<dd uid="u${userId}" title="${title}">{{/if}}	{{if isRecent}}	<a href="javascript:;" class="wp-remove-contact" title="从最近联系人中删除" tag="remove">&nbsp;&nbsp;</a>{{/if}}<a href="${profile}" title="TA的主页" target="_blank" class="wp-profile">个人主页</a>    {{if !tiny}}    <a href="#nogo" onclick="return false;" class="wp-f-avatar-box"><img class="wp-f-avatar" src="http://img.xiaonei.com/photos/0/0/men_tiny.gif" title="${userName}" alt="头像" /></a>    {{else}}	<a href="#nogo" onclick="return false;" class="wp-f-avatar-box">		{{if type==2}}					{{/if}}		{{if status == 0 }}			<img src="http://a.xnimg.cn/a.gif" title="不在线" class="wp-status wp-offline" />		{{else}}			<img src="http://a.xnimg.cn/a.gif" title="在线" class="wp-status wp-online" />		{{/if}}			<img class="wp-f-avatar" src="${tiny}" title="${title}" alt="头像" /></a>    {{/if}}    <div class="wp-f-info"><span>${shortName}</span>		{{if (status&2) == 2}} {{else}}		{{if (status&4) == 4}} <img src="http://a.xnimg.cn/a.gif" title="人人桌面在线" class="wp-device wp-client" /> {{else}}		{{if (status&8) == 8}}<img src="http://a.xnimg.cn/a.gif" title="手机在线" class="wp-device wp-phone" />{{/if}}		{{/if}}{{/if}}     </div></dd>',h="<!--module{name:'tpl/buddy/buddyLis'}-->{{each(i, buddy) buddies}}{{html getAbuddyTpl(buddy)}}{{/each}}",p="<!--module{name:'tpl/buddy/noResult'}--><p style=\"padding: 20px;\">您的好友中没有<strong>${name}</strong></p>",d=i.$extend,v=i.Sizzle,m=i.events,g=i.readly,y=i.dom,b=i.XN,w=s.getLogger("buddywin");r.template("buddy_win",a),r.template("buddy_groups",f),r.template("aBuddy",c),r.template("noResult",p),r.template("buddyLis",h);var E=new i.events.Events;return E.ddFindDtNum=S,d(E,{ui:{},buddies:[],curQuery:"",cats:null,isHtmlMade:{},search_tobeused:0,_ad_height:30,init:function(e,t){try{d(this.ui,e.nodes),this.cats=t.cats,this.win=e,this.catsWithCount=t.catsWithCount,this.initData(),this.initUI(),this.getUIRef(),this.prepareUI(),this.bindEvent(),this.doReady(),this.setBuddyClentAd(),this.setPanelHeight()}catch(n){}},initData:function(){return 0},initUI:function(){return this.win.nodes.header.innerHTML='<a href="#nogo" title="选择讨论组" onclick="return false;" class="start-groupchat">+</a><p class="wp-friend-ico">好友列表</p>',this.renderBuddyWin(this.catsWithCount),0},prepareUI:function(){var e=this;return e._searchHelper=b.form.help(e.ui.searchInput),e._defaultValue="搜索全部好友",e.ui.searchInput.value=e._defaultValue,e.ui.searchInput.style.color="#888",0},getUIRef:function(){d(this.ui,{gspList:y.getElement("section.wp-frid-list",this.ui.container),searchInput:y.getElement("input",this.ui.container),searchPanel:y.getElement("section.wp-frid-search",this.ui.container),btnStartGroup:y.getElement(".start-groupchat",this.ui.body)});var e=y.getElements("dl",this.ui.gspList);for(var t=0;t<e.length;t++)this.ui[e[t].title]=e[t];return 0},getUI:function(e){return this.ui[e]},removeRecent:function(e){var t=e.parentNode.getAttribute("uid"),n=t.charAt(0),t=t.substr(1),r=S(y.id("wp-list-recent")),i=jxn("#wp-list-recent").find("dt")[0],s=/(\d+)/;switch(n){case"g":n=2;break;case"u":n=1}new b.net.xmlhttp({url:"http://message.renren.com/user/recent/delete",data:"type="+n+"&sessionid="+t,onSuccess:function(t){var n=b.json.parse(t.responseText);n.code||(y.wrap(e.parentNode),e.parentNode.dispose(),i.innerHTML=i.innerHTML.replace(s,--r))}})},setBuddyClentAd:function(){if(webpager.imRunning||window.frames["imengine"].AD_FOR_RRZM==undefined){y.getElement(".buddy-clent-ad",this.win.frame).hide(),y.getElement(".wp-searchbox",this.win.frame).style.border="none",this._ad_height=0;return}var e=window.frames.imengine.AD_FOR_RRZM,t=e.buddybar,t=t[Math.floor(Math.random()*t.length)],n=t.text,r=t.link,i=y.getElement(".buddy-clent-ad",this.win.frame);if(i){var s=y.getElement("var",i),o=y.getElement("a",i);s.innerHTML=n,o.href=r}},rendGroupPanel:function(){var e=webpager.groupListInfo,t=e.length,n="";for(var r=0;r<t;r++)n+=['<dd uid="',e[r].id,'" title="',e[r].name,'">','<img src="http://a.xnimg.cn/webpager/res/group-avatar.png" alt="头像">','<span class="wp-group-name">',s.noMoreThan(e[r].name,16),'</span><span class="wp-group-total"> (',e[r].count,")</span></dd>"].join("");var i=['<dl class="wp-group-buddy">',n,"</dl>"].join("");return jxn(i)},bindEvent:function(){function t(t){if(t.getAttribute("target")=="_blank")return;if(t.getAttribute("tag")&&t.getAttribute("tag")=="remove"){e.removeRecent(t);return}var n;while(t&&t.tagName.toLowerCase()!="section"){n=t.getAttribute("uid");if(t.tagName.toLowerCase()=="dd"&&n){e.fireEvent("selected",{data:n}),y.wrap(t);var r=n.charAt(0),i=n.substr(1);window.webpager.handleLastMessage(i,r);break}if(!t.parentNode)break;t=t.parentNode}}var e=this;i.addEvent(this.ui.gspList,"click",function(e){var n=e.target,r=n.tagName.toLowerCase();if(y.wrap(n).hasClass("site_msg")){window.open("http://msg.renren.com/msg/getMessageList");return}if(r=="dt"){var i=n.parentNode.title;i==="最近联系"?b.net.sendStats("http://message.renren.com/statistics/wp/recent"):i=="在线好友"&&b.net.sendStats("http://message.renren.com/statistics/wp/online"),n.parentNode.className=="wp-list-close"?(n.parentNode.className="wp-list-open",n.title="点击展开"):(n.parentNode.className="wp-list-close",n.title="点击收起");return}t(n)}),i.addEvent(this.ui.searchPanel,"click",function(e){var n=e.target;t(n)}),i.addEvent(this.ui.searchInput,"focus",function(){this.value==e._defaultValue&&(this.value="",this.style.color="#333"),clearInterval(e.searchTimer),e.searchTimer=setInterval(function(){e._searchHelper.getRealValue()!=e.curQuery&&(e.curQuery=e._searchHelper.getRealValue(),e.fireEvent("search_change",{data:e.curQuery}),e.search_tobeused==0&&(b.net.sendStats("http://message.renren.com/statistics/wp/search"),e.search_tobeused=-1))},500)}),i.addEvent(this.ui.searchInput,"blur",function(){this.value==""&&(e.search_tobeused=0,this.value=e._defaultValue,this.style.color="#888"),clearInterval(e.searchTimer)}),i.addEvent(this.ui.searchInput,"keydown",function(t){if(e.mode!="search")return;w.log2(t.keyCode);if(t.keyCode==38)e.upDownSlcting(!0);else if(t.keyCode==40)e.upDownSlcting(!1);else if(t.keyCode==13){var n=e.getSelecting();n?e.fireEvent("selected",{data:n.getAttribute("uid")}):(y.getElement("#navSearchInput").value=e._searchHelper.getRealValue(),y.getElement("#globalSearchForm").submit()),e.clearSlcting(),e.commonMode()}}),i.addEvent(this.ui.btnStartGroup,"click",function(){function f(){t?(jxn(r).append(t),webpager.fs.clear()):(webpager.fs=new o.FriendSelect(r),setTimeout(function(){t=y.id("wp-friend-select"),webpager.fs.clear()},0)),webpager.fs.room=null}function l(){webpager.fs.addEvent("selected",function(e){webpager.fs.fireEvent("selectedItem",e)}),i.addEvent(a,"click",function(i){var o=y.wrap(i.target);o.hasClass("sf-close")&&(a.style.display="none");if(o.hasClass("sitem")){y.getElements(".sitem",a).forEach(function(e){y.wrap(e).removeClass("in")}),jxn(a).find(".sw").children().forEach(function(e){y.wrap(e).style.display="none"}),o.addClass("in"),o.hasClass("sf")&&(n&&(n.style.display="none"),r.style.display="block",r.appendChild(t),webpager.fs.clear());if(o.hasClass("sg")){r.style.display="none";if(!n){var u=document.createElement("div");u.id="wp-group-select",jxn(u).append(e.rendGroupPanel()),s.appendChild(u),jxn("#wp-group-select dd").click(function(e){var t=jxn(this).attr("uid");webpager.service.request("chat/group/start",t)}),setTimeout(function(){n=y.id("wp-group-select")},0)}else n.style.display="block"}}if(o.hasClass("wp-friend-confirm")){if(o.hasClass("wp-friend-confirm-disable"))return;window.webpager.fs.disableBtn();var f=webpager.fs.memberList,l=webpager.fs.memberName;if(!f.length>0){b.DO.showMessage("请至少选择一个好友。");return}f.length>1?webpager.service.request("chat/group/create",f,l):webpager.service.request("chat/conv/open",f[0])}})}var t=y.id("wp-friend-select"),n=y.id("wp-group-select"),r=y.id("wp-friend-sg"),s=y.getElement(".sw",a),u=y.id("add-friend-box");if(!u){var a=document.createElement("div");a.id="add-friend-box",a.innerHTML=['<h3>选择讨论组<a href="#nogo" onclick="return false;" class="sf-close">关闭</a></h3>','<p class="smenu clearfix">','	<span class="sitem sf in">选择好友</span><span class="sitem sg">选择讨论组</span></p>',"<p>",'<div class="sw">','	<div id="wp-friend-sg"></div>',"</div>"].join(""),u=a,y.id("webpager").appendChild(u),setTimeout(function(){s=y.getElement(".sw",u),r=y.id("wp-friend-sg"),f(),l()},0)}else u.style.display="block",f()})},searchMode:function(){this.mode="search",this.ui.searchPanel.show(),this.ui.gspList.hide()},commonMode:function(){this.mode="common",this.ui.searchPanel.hide(),this.ui.gspList.show(),this.searchReset()},getSelecting:function(){return y.getElement("dd.selecting",this.ui.searchPanel)},makeBuddyList:function(e){return r.tmpl("buddyListInner",{buddies:e,getAbuddyTpl:function(e){return r.tmpl("aBuddy",e)},aBuddyTpl:c.html})},makeBuddyWin:function(e){return r.tmpl("buddy_win",{cats:e})},makeABuddy:function(e){return r.tmpl("aBuddy",e)},makeNoResult:function(e){return r.tmpl("noResult",{name:e})},makeBuddyLis:function(e,t){return r.tmpl("buddyLis",{buddies:e,getAbuddyTpl:function(e){return t?e.isRecent=!0:e.isRecent=!1,e.status=e.status,e.title=e.userName,e.shortName=s.noMoreThan(e.userName,5),e.type==2?e.profile="http://message.renren.com/message/list/"+e.userId+"/2":e.profile="http://www.renren.com/profile.do?id="+e.userId,r.tmpl("aBuddy",e)}})},renderBuddyList:function(e){this.ui.gspList.removeClass("wp-frid-search");var t=this.makeBuddyList(e);return this.ui.gspList.innerHTML=t,0},renderBuddyLis:function(e,t,n){if(!e)return;n==="最近联系"?e.innerHTML+=this.makeBuddyLis(t,!0):e.innerHTML+=this.makeBuddyLis(t)},renderBuddyWin:function(e){return this.ui.container.innerHTML="",this.ui.container.appendChild(s.parseHTML(this.makeBuddyWin(e))),0},renderSearchResult:function(e){return this.searchMode(),this.ui.searchPanel.innerHTML="<dl>"+this.makeBuddyLis(e)+"</dl>",0},renderNoResult:function(e){return this.searchMode(),this.ui.searchPanel.innerHTML=this.makeNoResult(e),0},showBuddyList:function(){this.commonMode()},showCat:function(e,t){this.isHtmlMade[e]||(this.renderBuddyLis(this.ui[e],t,e),this.isHtmlMade[e]=!0)},clearSlcting:function(){var e=y.getElement("dd.selecting",this.ui.searchPanel);e&&e.removeClass("selecting")},upDownSlcting:function(e){w.log2("upDownSlcting");var t=y.getElement("dd.selecting",this.ui.searchPanel),n;if(t){t.removeClass("selecting"),n=e?function(){var e=t.previousSibling;if(e)return e.nodeType==8?e.previousSibling.nodeType==8?null:e.previousSibling:e}():function(){var e=t.nextSibling;if(e)return e.nodeType!=8?e:e.nextSibling}();if(n)n=y.wrap(n),n.addClass("selecting");else{var r=y.getElements("dd",this.ui.searchPanel);n=e?r[r.length-1]:r[0],n&&n.addClass("selecting"),l}}else{var r=y.getElements("dd",this.ui.searchPanel);n=e?r[r.length-1]:r[0],n&&n.addClass("selecting")}},searchReset:function(){this.ui.searchInput.value=""},searchFocus:function(){this._searchHelper.focus()},setPanelHeight:function(e){var t=e||this.container_height;t-=this._ad_height;if(!this.ui.gspList)return;this.ui.container.style.height=t+"px",this.ui.gspList.style.height=t-40-44+"px",this.ui.container.style.zoom=1.1,this.ui.container.style.zoom=1}}),g(E),E}),object.define("webpager/ugc","./lib/base, ./lib/tools",function(e,t,n){function u(e){o[e].inited=1;var n=o[e].q;n.forEach(function(e){t.makeRoom(e.roomId,e.ugc,e.callback)})}var r=e("./lib/base"),i=e("./lib/tools"),s=i.QA,o={common:{inited:-1,q:[]},photo:{inited:-1,q:[]},video:{inited:-1,q:[]},group:{inited:-1,q:[]},blog:{inited:-1,q:[]}};t.makeRoom=function(t,n,r){var i=parseInt(n.feed_stype);switch(i){case 505:case 503:case 502:var s="common";if(o[s].inited<=0){o[s].q.push({roomId:t,ugc:n,callback:r}),o[s].inited&&(o[s].inited=0,e.async("webpager/ugc/common",function(e){u(s)}));break}e.async("webpager/ugc/common",function(e){var i=new e.UgcChatroom(t,n,r)});break;case 701:case 708:case 709:var s="photo";if(o[s].inited<=0){o[s].q.push({roomId:t,ugc:n,callback:r}),o[s].inited&&(o[s].inited=0,e.async("webpager/ugc/photo",function(e){u(s)}));break}e.async("webpager/ugc/photo",function(e){var i=new e.PhotoChatroom(t,n,r)});break;case 5030:case 110:var s="video";if(o[s].inited<=0){o[s].q.push({roomId:t,ugc:n,callback:r}),o[s].inited&&(o[s].inited=0,e.async("webpager/ugc/video",function(e){u(s)}));break}e.async("webpager/ugc/video",function(e){var i=new e.VideoChatroom(t,n,r)});break;case 103:var s="photo";if(o[s].inited<=0){o[s].q.push({roomId:t,ugc:n,callback:r}),o[s].inited&&(o[s].inited=0,e.async("webpager/ugc/photo",function(e){u(s)}));break}e.async("webpager/ugc/photo",function(e){var i=new e.SharePhotoChatroom(t,n,r)});break;case 209:var s="group";if(o[s].inited<=0){o[s].q.push({roomId:t,ugc:n,callback:r}),o[s].inited&&(o[s].inited=0,e.async("webpager/ugc/group",function(e){u(s)}));break}e.async("webpager/ugc/group",function(e){var i=new e.GroupChatroom(t,n,r)});break;case 601:var s="blog";if(o[s].inited<=0){o[s].q.push({roomId:t,ugc:n,callback:r}),o[s].inited&&(o[s].inited=0,e.async("webpager/ugc/blog",function(e){u(s)}));break}e.async("webpager/ugc/blog",function(e){var i=new e.BlogChatroom(t,n,r)});break;case 102:var s="blog";if(o[s].inited<=0){o[s].q.push({roomId:t,ugc:n,callback:r}),o[s].inited&&(o[s].inited=0,e.async("webpager/ugc/blog",function(e){u(s)}));break}e.async("webpager/ugc/blog",function(e){var i=new e.ShareBlogChatroom(t,n,r)})}}}),object.define("webpager/ugc/common","../lib/base, ../lib/uikit, ../im/chatroom,../service ,../lib/tools",function(e,t,n){var r=e("../lib/base"),i=r.dom,s=e("../lib/uikit"),o=e("../im/chatroom"),u=e("../lib/tools"),a=e("../service"),f=u.getLogger("ugc/common"),l=u.QA,c={502:{n:3,tag:"status",text:"状态"},503:{n:3,tag:"status",text:"被动with"},505:{n:3,tag:"status",text:"分享状态"},701:{n:1,tag:"photo",text:"照片"},708:{n:1,tag:"photo",text:"照片"},709:{n:1,tag:"photo",text:"照片"},110:{n:4,tag:"share",text:"分享"},103:{n:4,tag:"share",text:"分享"},5030:{n:4,tag:"share",text:"分享"},209:{n:25,tag:"group",text:"小组"},601:{n:0,tag:"blog",text:"日志"},102:{n:4,tag:"share",text:"分享"},801:{n:17,tag:"gift",text:"礼物回复",ico:"wp-gift-ico"},8301:{n:20,tag:"gift",text:"礼物"},8302:{n:21,tag:"gift",text:"礼物"},807:{n:17,tag:"gift",text:"礼物"},808:{n:17,tag:"gift",text:"礼物"}},h=new Class(o.Chatroom,function(){this.service="ugc_chat",this.textCollection={title:'<p class="wp-status-ico">状态回复</p>',handler:"状态回复"},this.initialize=function(e,t,n,r){if(!r)throw Error("创建Ugc聊天室必须提供ondone这个参数");e.id=t,e.ugc=n,e._ondone=r,this.parent(e)},this.buildUI=function(e){var t=e.ugc,n=new v({title:e.getText("title"),handler:e.getText("handler"),ugc:t});n.rebuild_message={service:"ugc_chat",target:e.id,data:{feed_actor:t.feed_actor,feed_source:t.feed_source,feed_stype:t.feed_stype}},n.id=e.id,e.ui=n;var r=e.buildTopic();r.addEvent("load",function(t){e._ondone(t.err,e);if(t.err)return;e.loadHistory(t.data)}),r.load()},this.loadHistory=function(e,t){e.model.loadHistory("from_ugc_chatroom")},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon("wp-status-ico");var r=new m(n);return t._assemble("topic",r),t.nodes.drawer.appendChild(r.frame),r.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px",t.nodes.drawer.style.width=e.data.width+"px"}),r},this.buildModel=function(e){var t=new p(e.ugc);e.model=t},this.bindEvent=function(e){this.parent(e),e.ui.addEvent("exit",function(t){e.model.leave(function(){e.ui.close()})}),e.model.addEvent("broadcast_error",function(e){XN.DO.showError('消息"'+e.gsp.content+'"未发送成功: '+e.ret.msg)})},this.extendMessage=function(e,t){var n={content:t.replyContent,avatar:t.replyer_tinyurl,name:t.ubname,time:t.replyTime,callback:t.callback,isAt:t.isAt,profile:"http://www.renren.com/profile.do?id="+t.ubid};u.isMyself(t.ubid)||(n.reply_btn=!0,n.rid=t.id,n.uid=t.ubid,n.whisper=t.whisper);if(t.vocal_url){if(!XN.vocalPlayer)var r=this,i=arguments.callee;XN.loadFiles(["http://s.xnimg.cn/a52454/n/apps/status/module/vocal/player-all-min.css","http://s.xnimg.cn/a53841/n/apps/status/module/vocal/player.js"]),n.content=n.content.replace("这是一条语音评论。","<a class=\"vocal-player vocal-player-tiny\" 				 data-vocal=\"{'url': '"+t.vocal_url+"', 'time': "+t.vocal_length+",'ownerId':"+t.ownerId+",'voiceId':"+t.id+", 'sourceOwner':"+t.sourceOwner+", 'sourceId':"+t.sourceId+', \'ugcType\':4}" href     ="javascript:;">				   <span class="btn"></span>				   <span class="time"><span class="num">'+t.vocal_length+"</span>秒</span>				 </a>")}return n=this.parent(e,n),n},this.signal=function(e,t){function n(t){switch(t.action){case"focus":e.ui.unfold(0,1);break;case"message":e.model.pushMessage(t.data)}}if(t instanceof Array){var r=[],i=[];t.forEach(function(e){e.action=="message"?r.push(e.data):i.push(e)}),e.model.pushMessage(r);var s;while(s=i.shift())n(s)}else n(t)}}),p=new Class(function(){this.__mixins__=[r.events.Events],this.msgs=[],this.chatWordNum=140,this.initialize=function(e,t){e.ugc=t},this.pushMessage=function(e,t){var n=[].concat(t);if(!n.length)return;var r=e.msgs.length;n.forEach(function(t,n){if(!t.ugc_content)return;if(!(!t.source||t.feed_stype!=502&&t.feed_stype!=505||t.source.indexOf("541-")!=0)){t.rmessagecallback&&XN.net.sendStats(u.unescapeHTML(t.rmessagecallback));return}e.msgs.push(e.dataAdapt(t))});var i=e.msgs.slice(r);if(!i.length)return;e.fireEvent("message",{data:i})},this.send=function(e,t){t.content&&t.content.length>e.chatWordNum&&(t.content=XN.string.trim(t.content),t.content=t.content.substring(0,e.chatWordNum-3)+"..."),t.content=u.htmlFilter(t.content),e.broadcastGsp(t);var n=u.User,r=e.ugc,i={from_id:n.id,from_name:n.name,from_pic:n.head,time:(new Date-0)/1e3,is_whisper:t.isWhisper,ugc_content:e.atFilter(t.content),feed_actor:r.feed_actor,feed_source:r.feed_source,feed_stype:r.feed_stype,pass:!0};return e.pushMessage(i),{action:"message",data:i,forall:0}},this.dataAdapt=function(e,t){var n=e.ugc;try{if(/这是一条语音评论。$/.test(t.ugc_content)){var r=u.unescapeHTML(t.content).match(/(http:[^"]*)/g);r&&r.length&&(r=r[r.length-1],t.ugc_content=t.ugc_content.replace("这是一条语音评论。",'<a href="'+r+'" title="到终端页收听" target="_blank">这是一条语音评论</a>'))}}catch(i){}var s={id:t.ugc_id,replyContent:e.atFilter(t.ugc_content),replyer_tinyurl:u.makeHeadTinyurl(t.from_pic),replyTime:u.getDateTime(t.time*1e3),ubname:t.from_name,ubid:t.from_id,whisper:parseInt(t.is_whisper)};return t.rmessagecallback&&(s.callback=u.unescapeHTML(t.rmessagecallback)),t.is_at&&(s.isAt=t.is_at),s},this.atFilter=function(e,t){var n=/@([^\(\)@]+)\((\d+)\)/img,r=t.replace(n,function(e,t,n){return n.toString().length==19?'@<img src="http://a.xnimg.cn/imgpro/icons/mention-friend-group3.png">'+t+"&nbsp;":'<a target="_blank" href="http://www.renren.com/profile.do?id='+n+'">'+"@"+t+"</a>"});return r},this.loadHistory=function(e,t,n){if(t!="from_ugc_chatroom")return;var n=n||e.ugc,r={doingId:n.feed_source,owner:n.feed_actor,source:n.feed_source,t:c[n.feed_stype].n};l.log2("22&source="+n.feed_source+"&stype="+n.feed_stype+"&actor="+n.feed_actor+"&empty=5"),f.log2(">>>>>>>>>> UGC  loadHistory"),new XN.net.xmlhttp({url:"http://status.renren.com/feedcommentretrieve.do",data:XN.array.toQueryString(r),onSuccess:function(t){try{f.log2("<<<<<<<<<<<<<<<<< UGC loaded",t.responseText);var r=XN.json.parse(t.responseText);r.replyList?e.replaceHistory(r.replyList):l.log2("23&source="+n.feed_source+"&stype="+n.feed_stype+"&actor="+n.feed_actor+"&empty=2")}catch(i){l.log2("24&source="+n.feed_source+"&stype="+n.feed_stype+"&actor="+n.feed_actor+"&empty=3")}},onError:function(){l.log2("25&source="+n.feed_source+"&stype="+n.feed_stype+"&actor="+n.feed_actor+"&empty=4")}})},this.replaceHistory=function(e,t){e.msgs.forEach(function(e){e.whisper&&t.push(e)}),t.sort(function(e,t){return e.replyTime>t.replyTime?1:-1}),e.msgs=t,e.fireEvent("historyReplace",{data:t})},this.broadcastGsp=function(e,t){var n=e.ugc,r={c:t.content,t:c[n.feed_stype].n,source:n.feed_source,owner:n.super_feed_actor||n.feed_actor,replyName:t.replyName||"",replyTo:t.replyTo||"",secondaryReplyId:t.replyId||"",isWhisper:t.isWhisper||!1};!r.replyTo&&r.t==3&&l.log2("status_nobody"),r.t==3&&l.log2("a1"),new XN.net.xmlhttp({url:"http://status.renren.com/feedcommentreply.do?from=wp&fromu="+u.User.id+"&tou="+r.replyTo+"&source="+r.source+"&fowner="+r.owner+"&t="+r.t+"&stype="+e.ugc.feed_stype,data:XN.array.toQueryString(r),onSuccess:function(n){var r=n.responseText;if(!r)return;if(r=="empty")return;var i=XN.json.parse(n.responseText);i&&i.code&&e.fireEvent("broadcast_error",{ret:i,gsp:t})},onComplete:function(){e.replyName="",e.replyTo="",e.isWhisper=!1}})},this.leave=function(e,t){e.x=!0;var n=e.ugc;new XN.net.xmlhttp({url:"http://notify.renren.com/quitchat.notify?groups="+n.feed_source+"-"+n.feed_stype+"-"+n.feed_actor,onSuccess:function(e){t&&t()},onError:function(){XN.DO.showError("网络不稳定,请重试.")}})},this.destroy=function(e){}}),d=new Class(s.TalkFlow,function(){this.initialize=function(e){e._ugc_talkflow=!0,this.parent(e),e.bindEvent()},this.bindEvent=function(e){var t=e.frame;t.addEvent("click",function(t){var n=t.target;if(n.tagName.toLowerCase()=="a"&&n.getAttribute("click")=="reply"){var r={name:n.getAttribute("wname"),id:n.getAttribute("wid"),rid:n.getAttribute("rid")};n.getAttribute("whisper")=="1"&&(r.whisper=!0),e.fireEvent("replyTo",{data:r}),XN.net.sendStats("http://message.renren.com/statistics/win/reply")}})},this.buildDialog=function(e,t){if(t.reply_btn)var n='<a click="reply" class="wp-chat-reply" whisper="'+(t.whisper?1:0)+'" wname="'+t.name+'" wid="'+t.uid+'" rid="'+t.rid+'" href="javascript:void(0)">回复</a>';var r="wp-chatlist-ugc",i=['<section class="',r,'">','	<figure class="avatar">','		<a href="'+t.profile+'" target="_blank" title="'+t.name+'"><img width="35" height="35" src="'+t.avatar+'" /></a>','		<p class="wp-name-tip" style="display:none">'+t.name+'<span class="wp-arrow"></span></p>',"	</figure>",'	<section class="wp-chat-content">','		<p><a href="'+t.profile+'" target="_blank">'+t.name+"</a>："+t.content+(t.whisper?'&nbsp;<img title="悄悄话" src="http://a.xnimg.cn/img/lock_red_new.png" />':"")+"</p>","	</section>","	<footer>"+(n||"")+'<span class="wp-chat-time">'+t.time+"</span></footer>","</section>"].join(""),s=u.parseHTML(i);return s}}),v=new Class(s.WindowWithDrawer,function(){this.initialize=function(e,t){this.parent(e,t),e.buildTalkflow(),e.buildInputer(t.ugc),e.nodes.body.style.width="500px",e.addExitBtn()},this.buildTalkflow=function(e){var t={};t.early_btn=!1;var n=new d(t);e._assemble("talkflow",n),e.nodes.container.appendChild(n.frame),e.addEvent("fold",function(e){e.data||n.scrollBottom()}),n.addEvent("replyTo",function(t){var n=t.data;e.components.inputer.replyTo(n)})},this.buildInputer=function(e,t){var n={ugcId:t.feed_source,ugcType:c[t.feed_stype].tag,ownerId:t.feed_actor},r=new s.Inputer({emotion:!0,mention:n,maxinput:{num:140,tip:"每次回复最多140个字符."}});e._assemble("inputer",r),e.nodes.container.appendChild(r.frame)},this.pushDialog=function(e,t){e.components.talkflow.pushDialog(t),e._fold&&e.highLight()}}),m=new Class(s.UIcommon,function(){this.initialize=function(e,t){e.ugc=t;var n=e.buildFrame()},this.getUIRef=function(e){},this.bindEvent=function(e){},this.buildContent=function(e,t){e.fireEvent("resize",{data:{width:228}});var n=['<section class="topic wp-status-topic" style="max-width:208px;">'
,"<figure>",'	<a href="http://www.renren.com/profile.do?id='+t.host_id+'"><img width="30" height="30" src="'+t.host_pic+'" /></a>',"</figure>",'<div class="wp-status-main">','	<a href="http://www.renren.com/profile.do?id='+t.host_id+'">'+t.host_name+"</a>："+u.unescapeHTML(t.content),'	<p class="wp-topic-time">'+u.getDate(t.timestamp)+"</p>","</div>","</section>"].join("");return n},this.render=function(e,t){var n=e.buildContent(t);e.frame.innerHTML="",e.frame.appendChild(u.parseHTML(n)),e.getUIRef(),e.bindEvent()},this.load=function(e){var t=e.ugc,n=e.frame;n.innerHTML=" loading... ";var r="http://notify.renren.com/get2.feed?actor="+t.feed_actor+"&source="+t.feed_source+"&stype="+t.feed_stype;new XN.net.xmlhttp({url:r,useCache:!0,onSuccess:function(t){var n=XN.json.parse(t.responseText);if(!t.responseText||JSON.stringify(n)=="{}"){n=null,e.fireEvent("load",{err:t.responseText});return}try{e.topic=n,e.render(n)}catch(r){l.reportExpt("ugc_renderTopic",r,""),s("渲染过程出错:"+r.stack)}e.fireEvent("load",{data:n})},onError:function(){f.err("网络错误, ugc Topic 加载失败!"),l.log2("34&source="+t.feed_source+"&stype="+t.feed_stype+"&actor="+t.feed_actor+"&empty=1"),e.fireEvent("loadFaild"),s("网络错误")}});var s=function(t){n.innerHTML="";var r=i.getDom('<p style="width:120px;margin-top:35px;">抱歉,主题加载失败(也可能已经被主人删除),请点击<a class="retry" href="#nogo" onclick="return false;">重试</a></p><span style="display:none;">'+t+"</span>");n.appendChild(r);var s=i.getElement("a.retry",n);s.addEvent("click",function(t){e.load()})}}});t.UgcChatroom=h,t.UgcChatroom_window=v,t.UgcTopic=m,t.UgcChatroom_model=p,t.stypeMap=c}),object.define("webpager/ugc/gift","../lib/base, ../lib/tools, ../lib/uikit, ./common",function(e,t,n){var r=e("../lib/base"),i=r.dom,s=e("../lib/tools"),o=e("../lib/uikit"),u=s.QA,a=e("./common"),f=a.stypeMap,l=new Class(a.UgcChatroom,function(){this.buildUI=function(e){var t=e.ugc,n=new c({title:'<p class="'+f[t.rt_type].ico+'">'+f[t.rt_type].text+"</p>",handler:f[t.rt_type].text,ugc:t});n.rebuild_message={service:"ugc_chat",target:e.id,data:{feed_actor:t.feed_actor,feed_source:t.feed_source,feed_stype:t.feed_stype,feed_ntype:t.feed_ntype,rt_topic:t.rt_topic,rt_comments:t.rt_comments||"",rt_reply:t.rt_reply||"",rt_type:t.rt_type}},n.id=e.id,e.ui=n;var r=e.buildTopic();r.addEvent("load",function(t){e._ondone(t.err,e);if(t.err)return;e.loadHistory(t.data)}),r.load()},this.buildModel=function(e){var t=new h(e.ugc);e.model=t},this.buildTopic=function(e){var t=e.ui,n=e.ugc;t.setIcon(f[n.rt_type].ico);var r=new p(n);return t._assemble("topic",r),t.nodes.drawer.appendChild(r.frame),r.addEvent("resize",function(e){t.nodes.body.style.width=322+e.data.width+"px",t.nodes.drawer.style.width=e.data.width+"px"}),r}}),c=new Class(a.UgcChatroom_window,function(){this.buildInputer=function(e,t){var n={ugcId:t.feed_source,ugcType:f[t.rt_type].tag,ownerId:t.feed_actor},r=new o.Inputer({emotion:!0,mention:n,maxinput:{num:140,tip:"每次回复最多140个字符."}});e._assemble("inputer",r),e.nodes.container.appendChild(r.frame)}}),h=new Class(a.UgcChatroom_model,function(){this.loadHistory=function(e,t,n){if(!e.ugc.rt_comments){this.parent(e,t,n);return}var n=n||e.ugc;if(t!="from_ugc_chatroom")return;var r={doingId:n.feed_source,owner:n.feed_actor,source:n.feed_source,t:n.feed_ntype};new XN.net.xmlhttp({url:e.ugc.rt_comments,data:XN.array.toQueryString(r),onSuccess:function(t){try{var n=XN.json.parse(t.responseText);n.replyList&&e.replaceHistory(n.replyList)}catch(r){}},onError:function(){}})},this.broadcastGsp=function(e,t){if(!e.ugc.rt_reply){this.parent(e,t);return}var n=e.ugc,r={c:t.content,t:n.feed_ntype,source:n.feed_source,owner:n.feed_actor,replyName:t.replyName||"",replyTo:t.replyTo||"",secondaryReplyId:t.replyId||"",isWhisper:t.isWhisper||!1};!r.replyTo&&r.t==3&&u.log2("status_nobody"),r.t==3&&u.log2("a1"),new XN.net.xmlhttp({url:e.ugc.rt_reply+"?from=wp&fromu="+s.User.id+"&tou="+r.replyTo+"&source="+r.source+"&fowner="+r.owner+"&t="+r.t+"&stype="+e.ugc.feed_stype,data:XN.array.toQueryString(r),onSuccess:function(n){var r=n.responseText;if(!r)return;if(r=="empty")return;var i=XN.json.parse(n.responseText);i&&i.code&&e.fireEvent("broadcast_error",{ret:i,gsp:t})},onComplete:function(){e.replyName="",e.replyTo="",e.isWhisper=!1}})}}),p=new Class(a.UgcTopic,function(){this.buildContent=function(e,t){return e.fireEvent("resize",{data:{width:228}}),e.frame.innerHTML="",e.frame.appendChild(s.parseHTML(t)),t},this.buildTopicHtml=function(e,t){var n,r,i;t.replace(/\[Data\]([\w\W]*?)\[\/Data\]/img,function(e,t){return n=t,e}).replace(/\[HTML\]([\w\W]*?)\[\/HTML\]/img,function(e,t){return r=t,e});try{if(!n){e.fireEvent("load",{err:t});return}if(!r){e.fireEvent("load",{err:t});return}n=JSON.parse(n)}catch(o){e.fireEvent("load",{err:t})}n.topic.timestamp=s.getDate(n.topic.timestamp);try{i=s.renderTpl(r,n)}catch(o){u.reportExpt("ugc_renderTpl",o,"")}return i},this.load=function(e){var t=e.ugc,n=e.frame,r=t.rt_topic,o="topic_"+t.feed_actor+"_"+t.feed_source+"_"+t.feed_stype,a=webpager.getItem(o);if(a){setTimeout(function(){e.buildContent(a),e.fireEvent("load",{data:{}})},0);return}n.innerHTML=" loading... ",new XN.net.xmlhttp({url:s.unescapeHTML(r),useCache:!0,onSuccess:function(t){var n=e.buildTopicHtml(t.responseText.replace(/[\n\r]/mg,""));webpager.setItem(o,n);try{e.buildContent(n)}catch(r){u.reportExpt("ugc_renderTopic",r,""),f("渲染过程出错:"+r.stack)}e.fireEvent("load",{data:{}})},onError:function(){f("网络错误")}});var f=function(t){n.innerHTML="";var r=i.getDom('<p style="width:120px;margin-top:35px;">抱歉,主题加载失败(也可能已经被主人删除),请点击<a class="retry" href="#nogo" onclick="return false;">重试</a></p><span style="display:none;">'+t+"</span>");n.appendChild(r);var s=i.getElement("a.retry",n);s.addEvent("click",function(t){e.load()})}}});t.GiftChatroom=l}),object.define("webpager/ugc/radio","",function(e,t,n){var r=window.$,i=function(e){var t=r(e);return window.asyncHTMLManager&&(t.addEvent=function(e,n,r){window.asyncHTMLManager.dom.Element.prototype.addEvent.call(t,e,n,r)}),t},s=function(){if(navigator.plugins&&navigator.plugins.length&&navigator.plugins["Shockwave Flash"])return!0;if(navigator.mimeTypes&&navigator.mimeTypes.length){var e=navigator.mimeTypes["application/x-shockwave-flash"];return e&&e.enabledPlugin}try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash"),!0}catch(t){}return!1}(),o=!1,u;typeof console=="undefined"||o==0?u=XN.func.empty:(u=console.log,XN.browser.WebKit&&(u=function(){console.log.apply(console,Array.prototype.slice.call(arguments,0))}),setTimeout(function(){window.radio=XN.radio.home},100)),XN.namespace("XN.radio.home"),$extend(XN.radio.home,{seedInit:function(e,t){if(!s)return;this.radioFileList=e,i(t).innerHTML=this.seedInitHTML(),this.seedAddEvents(),this.seedIfHasNotice(),this.seedInited=!0},seedIfHasNotice:function(){XN.radio.home.noticeContent&&this.seedLoad()},seedMainLoading:!1,seedInitHTML:function(){return'<div id="radio-home-con">	<div class="radio-display"  id="radio-home-panel" style="display:none;"></div>	<div id="home-radio-bar">   	<div id="home-radio-btns">			<div class="home-radio-playOrPause"><a id="home-radio-play" href="#nogo" onclick="return false;" hidefocus="true" title="播放" class="playPause"><span></span></a></div>			<div class="home-radio-next"><a id="home-radio-next" href="#nogo" onclick="return false;" hidefocus="true"  title="播放音乐时可用" class="nextDisable"><span></span></a></div>			<div class="home-radio-fav"><a id="home-radio-fav" href="#nogo" onclick="return false;" hidefocus="true" title="播放音乐时可用" class="favDisable"><span></span></a></div>    	</div>		<div  class="listNormal"><a id="home-radio-listbar" href="#nogo"  onclick="return false;"  title="电台列表" hidefocus="true"></a></div>	</div><div id="radio-home-favPanel" style="display:none;"><span class="heart"></span><span class="addHeartSucc">加心成功！</div><div id="radio-home-songInfoPanel"  style="display:none;"></div></div>	<div id="radio_home_flashcon"></div>'},seedAddEvents:function(){var e=this,t=!1,n=i("home-radio-listbar");n.addEvent("mouseover",function(){n.delEvent("mouseover",arguments.callee);if(t||e.seedMainLoaded)return;t=!0,e.seedLoad("list")});var r=i("home-radio-play");r.addEvent("click",function(){r.delEvent("click",arguments.callee);if(t||e.seedMainLoaded)return;t=!0,e.seedLoad("play")})},playFeedSong:function(e,t,n,r){var i=this;if(i.seedMainLoading)return;i.seedMainLoaded?i.mainPlayFeedSong(e,t,n,r):i.seedLoad(function(){i.mainPlayFeedSong(e,t,n,r)})},seedLoad:function(e){this.seedMainLoading=!0,/^apps?\./.test(window.location.hostname)||XN.loadFiles(this.radioFileList,function(){object.use("xn/radio",function(){e&&(i("radio-home-panel").style.display="block"),XN.radio.home.init(e)})})}}),XN.event.enableCustomEvent(XN.radio.home),t.radio=XN.radio.home});