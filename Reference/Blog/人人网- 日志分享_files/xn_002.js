/** 
 * ILIKE
 * code by bo.hu@opi-corp.com
 *
 * 构造 new XN.app.ILike( p )
 *	 p = {
 * 			type :  String [ photo | album | blog ],
 * 			id   :  Int [ item id ]
 * 			userId : Int [ current User ID ]
 * 		}
 *
 *
 * 方法：
 * 		add() :
 * 		首先要扩展实例的属性，下面的两个属性必须，要发webPager
 * 				$extend(ilike, {
 * 					guestName: [ current　User Name ],
 * 					ownerId  : [ item owner id]
 * 				})
 * 		event: getAddSuccess
 *
 * 		remove():
 * 		viewCount():
 * 		viewDetail():
 *
 */XN.namespace("app"),XN.app.ILike=function(e){$extend(this,e)},function(e){var t={},n;getILike=function(e){return t[e]},getActiveILike=function(){return getILike(n)};var r=function(e){var t=e.url,n=e.method||"GET",r=e.callback,i=e.errorMsg||"未知错误，请稍后重试",s=e.data,o=this;try{new XN.net.xmlhttp({url:t,data:s,method:n,onSuccess:function(e){var t=XN.JSON.parse(e.responseText);if(t.code!=0){XN.DO.alert(t.msg);return}r.call(o,t)},onError:function(){XN.DEBUG_MODE&&XN.DO.showError(i)}})}catch(u){XN.log("数据发送失败")}};e.prototype={gid:0,uid:0,userLike:!1,likeCount:null,likeList:[],ilikeButton:null,ilikeBox:null,ilikeHeader:null,ilikeDetailBox:null,baseUrl:"http://like."+XN.env.domain,addUrl:"/addlike",removeUrl:"/removelike",viewCountUrl:"/showlike",veiwDetailUrl:"/showlikedetail",urlProfile:"http://www."+XN.env.domain+"/profile.do",loadingStr:'<span id="temp-loading">加载中&nbsp;<img src="'+XN.env.staticRoot+'imgpro/bg/indicator_blue_small.gif" /></span>',isDetailShow:!1,oldDetailShow:null,guestName:null,ownerId:null,itemName:null,cookieNameHour:null,cookieNameDay:null,maxHourLikeCounts:30,maxDayLikeCounts:80,hourAlertMsg:"您赞的次数太多了，请休息一小时再赞吧！",dayAlertMsg:"您今天赞的次数太多了，请明天再赞吧！",lastLikeTime:null,limitInteval:3,limitAlertMsg:"您的操作太快了，请稍后再重试",init:function(){if(isUndefined(this.type)||isUndefined(this.id)||isUndefined(this.userId))return XN.log("type|id|userId must needed!!"),!1;this.gid=this.type+"_"+this.id,this.uid=this.userId,this.params={gid:this.gid,uid:this.uid},t[this.gid]=this,n=this.gid,this.cookieNameHour="IL_H",this.cookieNameDay="IL_D"},commentInit:function(){var e;this.commentUrl={add:this.baseUrl+"/comment"+this.addUrl,remove:this.baseUrl+"/comment"+this.removeUrl},this.gid=this.stype+"comment_"+this.cid;switch(this.stype){case"status":e=12;break;case"blog":e=9;break;case"share":e=11}this.params={gid:this.gid,resource:this.rid,uid:this.uid,owner:this.oid,resourceownerid:this.roid,url:this.url,type:e,name:this.name},t[this.gid]=this,n=this.gid,this.cookieNameHour="IL_H",this.cookieNameDay="IL_D"},commentAdd:function(){this.fireEvent("startAdd");var e=this.checkHasLiked();if(e.alreadyMax)return XN.DO.alert(e.msg),!1;if(!this.checkActionInteval())return this.actionIntevalCallBack?this.actionIntevalCallBack():XN.DO.showError(this.limitAlertMsg),!1;r.call(this,{url:this.commentUrl.add+"?"+XN.array.toQueryString(this.params),callback:this.addCallback})},commentRemove:function(){this.fireEvent("remove");var e=this.checkHasLiked();if(e.alreadyMax)return XN.DO.alert(e.msg),!1;if(!this.checkActionInteval())return this.actionIntevalCallBack?this.actionIntevalCallBack():XN.DO.showError(this.limitAlertMsg),!1;r.call(this,{url:this.commentUrl.remove+"?"+XN.array.toQueryString(this.params),callback:this.removeCallback})},add:function(){var e;switch(this.type){case"blog":e=0;break;case"album":e=1;break;case"photo":e=2;break;case"share":e=3;break;case"edm":e=4;break;case"video":e=5;break;case"status":e=6}var t=$extend(this.params,{owner:this.ownerId,type:e,name:this.guestName}),n=this.getUrl(this.addUrl,t);this.fireEvent("startAdd");var i=this.checkHasLiked();if(i.alreadyMax)return XN.DO.alert(i.msg),!1;if(!this.checkActionInteval())return this.actionIntevalCallBack?this.actionIntevalCallBack():XN.DO.showError(this.limitAlertMsg),!1;r.call(this,{url:n,callback:this.addCallback})},addCallback:function(e){XN.log(e),this.likeCount=e.likeCount,this.userLike=e.ownerLike,this.likeList=e.likeList,this.setCheckCookie(),this.fireEvent("addSuccess")},remove:function(){var e;switch(this.type){case"blog":e=0;break;case"album":e=1;break;case"photo":e=2;break;case"share":e=3;break;case"edm":e=4;break;case"video":e=5;break;case"status":e=6}var t=$extend(this.params,{owner:this.ownerId,type:e,name:this.guestName}),n=this.getUrl(this.removeUrl,t);this.fireEvent("remove");var i=this.checkHasLiked();if(i.alreadyMax)return XN.DO.alert(i.msg),!1;if(!this.checkActionInteval())return this.actionIntevalCallBack?this.actionIntevalCallBack():XN.DO.showError(this.limitAlertMsg),!1;r.call(this,{url:n,callback:this.removeCallback})},removeCallback:function(e){XN.log(e),this.likeCount=e.likeCount,this.userLike=e.ownerLike,this.likeList=e.likeList,this.setCheckCookie(),this.fireEvent("removeSuccess")},viewCount:function(){var e=this.getUrl(this.viewCountUrl,this.params);this.fireEvent("getViewCount");if(getILike(this.gid).likeCount!=null)return this.fireEvent("getViewCountSuccess"),!1;r.call(this,{url:e,callback:this.viewCountCallback})},viewCountCallback:function(e){XN.log(e),this.likeCount=e.likeCount,this.userLike=e.ownerLike,this.fireEvent("getViewCountSuccess")},viewDetail:function(){var e=this.getUrl(this.veiwDetailUrl,this.params);this.fireEvent("getViewDetail");if(this.likeList.length!=0){this.fireEvent("getViewDetailSuccess");return}r.call(this,{url:e,callback:this.veiwDetailCallback}),this.addLoading()},veiwDetailCallback:function(e){XN.log(e),this.likeCount=e.likeCount,this.userLike=e.ownerLike,this.likeList=e.likeList,this.removeLoading(),this.fireEvent("getViewDetailSuccess")},getUrl:function(e,t){return $extend(t,{t:Math.random()}),this.baseUrl+e+"?"+XN.array.toQueryString(t)},setCheckCookie:function(){this.setHourLiked(),this.setDayLiked()},setCookie:function(e,t,n,r,i,s){var o;if(isNumber(n)){var u=new Date,a=new Date(u.getTime()+n*1e3);o=a.toGMTString()}else isString(n)?o=n:o=!1;i=i||XN.env.domain,r="/",document.cookie=e+"="+encodeURIComponent(t)+(o?";expires="+o:"")+(r?";path="+r:"")+(i?";domain="+i:"")+(s?";secure":"")},setHourLiked:function(){var e=60-(new Date).getMinutes();if(!XN.cookie.get(this.cookieNameHour))this.setCookie(this.cookieNameHour,1,e*60);else{var t=parseInt(XN.cookie.get(this.cookieNameHour));this.setCookie(this.cookieNameHour,t+1,e*60)}},setDayLiked:function(){var e=new Date;e.setDate(e.getDate()+1),e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0);var t=e.getTime()-(new Date).getTime();if(!XN.cookie.get(this.cookieNameDay))this.setCookie(this.cookieNameDay,1,t/1e3);else{var n=parseInt(XN.cookie.get(this.cookieNameDay));this.setCookie(this.cookieNameDay,n+1,t/1e3)}},checkHourLiked:function(){var e=parseInt(XN.cookie.get(this.cookieNameHour));return e>this.maxHourLikeCounts},chekcDayLiked:function(){var e=parseInt(XN.cookie.get(this.cookieNameDay));return e>this.maxDayLikeCounts},checkHasLiked:function(){return this.checkHourLiked()?{alreadyMax:!0,msg:this.hourAlertMsg}:this.chekcDayLiked()?{alreadyMax:!0,msg:this.dayAlertMsg}:{alreadyMax:!1}},checkActionInteval:function(){if(!this.lastLikeTime)return this.lastLikeTime=(new Date).getTime(),!0;var e=(new Date).getTime(),t=(e-this.lastLikeTime)/1e3;return this.lastLikeTime=e,t>this.limitInteval},addLoading:function(){$("temp-loading")||this.ilikeHeader.appendHTML(this.loadingStr)},removeLoading:function(){var e=this.ilikeHeader.getElementsByTagName("span")[0];e&&this.ilikeHeader.removeChild(e)},elShow:function(e){e.style.display=""},elHide:function(e){e.style.dispay="none"}},XN.EVENT.enableCustomEvent(e.prototype)}(XN.app.ILike);var ILike={ilike:null,init:function(e){var t=this,n=e.type+"_"+e.id;getILike(n)?this.ilike=getILike(n):this.ilike=new XN.app.ILike(e),XN.log(this.ilike.likeCount),this.ilike.init(),this.ilike.addEvent("getViewCountSuccess",function(){t.renderButton(),t.renderHeaderBox()}),this.ilike.ilikeBox&&delete this.ilike.ilikeBox,this.createBox(),this.ilike.isDetailShow=!1,this.ilike.guestName=$("guestName").value||e.guestName,this.ilike.viewCount(),this.inputParams=e;try{Blog&&Blog.addEvent("onShowMoreComments",function(){ILike.patchShowMoreComments()})}catch(r){}try{AlbumComments&&AlbumComments.albumId&&AlbumComments.addEvent("onShowMoreComments",function(){ILike.patchShowMoreComments()})}catch(r){}try{XN.PAGE.albumPhoto&&XN.PAGE.albumPhoto.currentPhotoId&&(XN.PAGE.albumPhoto.addEvent("onShowMoreComments",function(){ILike.patchShowMoreComments()}),XN.PAGE.albumPhoto.addEvent("onPhotoRefresh",ILike.patchPhotoRefresh))}catch(r){}},toggleUserLike:function(){var e=this.ilike,t=this;e.userLike==0?(e.addEvent("addSuccess",function(){t.renderAll()}),e.add()):(e.addEvent("removeSuccess",function(){t.renderAll()}),e.remove())},toggleShowDetail:function(){var e=this.ilike,t=this;e.isDetailShow===!0?e.ilikeDetailBox.style.display="none":(e.addEvent("getViewDetailSuccess",function(){t.renderLikeList()}),e.viewDetail()),e.isDetailShow=e.isDetailShow===!0?!1:!0},renderAll:function(){var e=this,t=this.ilike;e.renderButton(),e.renderHeaderBox(),t.isDetailShow&&e.renderLikeList()},renderButton:function(){var e=this.ilike;e.userLike==1?e.ilikeButton.innerHTML="取消赞":e.ilikeButton.innerHTML="赞",e.ilikeButtonAddtional&&(e.userLike==1?e.ilikeButtonAddtional.innerHTML="取消赞":e.ilikeButtonAddtional.innerHTML="赞")},renderHeaderBox:function(){var e=this.ilike,t,n,r="ILike.toggleShowDetail();return false;";e.likeCount>0&&(e.userLike===!0?(e.likeCount-1>0&&(t='<a onclick="'+r+'" href="javascript:;">我和'+(e.likeCount-1)+"个人觉得赞！</a>"),e.likeCount-1==0&&(t="我觉得赞！")):t='<a onclick="'+r+'" href="javascript:;">'+e.likeCount+"个人觉得赞！</a>"),t?(e.ilikeHeader.parentNode.style.display="block",e.ilikeHeader.innerHTML=t):e.ilikeHeader.parentNode.style.display="none"},renderLikeList:function(){var e=this.ilike,t=e.likeList,n='<ul class="figures">';for(var r=0,i=t.length;r<i;r++){var s=t[r].keepUse?" lively-user":"",o=t[r].keepUse?"连续登录7天, 即可获得橙名特权":t[r].name;n+=['<li><div class="figure">','<a namecard="'+t[r].id+'" href="'+e.urlProfile+"?id="+t[r].id+'" target="_blank">','<img src="'+t[r].headUrl+'" alt="'+t[r].name+'" />',"</div></li>"].join("")}n+="</ul>",e.ilikeDetailBox.innerHTML=n,e.ilikeDetailBox.style.display="block"},createBox:function(){$("ILike_Box")&&$("ILike_Box").parentNode.removeChild($("ILike_Box")),this.ilike.ilikeBox=document.createElement("dl"),this.ilike.ilikeBox.id="ILike_Box";var e=['<dt class = "digged" style="display:none;">','<span  id="ILike_Text_'+this.ilike.id+'">',"</span>","</dt>",'<dd id="ILike_Detail_'+this.ilike.id+'" class = "diggers" style="display:none;"></dd>'].join("");this.ilike.ilikeBox.innerHTML=e,this.ilike.ilikeBox.className="replies  with-arrow";var t=XN.dom.getElementsByClassName("replies","document","dl")[0];t!=undefined?(t.className=t.className.replace(/\swith-arrow/ig,""),t.parentNode.insertBefore(this.ilike.ilikeBox,t)):XN.dom.getElementsByClassName("replies","document","div")[0].appendChild(this.ilike.ilikeBox),this.getHTMLhandles()},getHTMLhandles:function(){this.ilike.ilikeButton=$("ILike_UserLike_Handle"),$("photoGood")&&(this.ilike.ilikeButtonAddtional=$("photoGood")),this.ilike.ilikeHeader=$("ILike_Text_"+this.ilike.id),this.ilike.ilikeDetailBox=$("ILike_Detail_"+this.ilike.id)},patchShowMoreComments:function(){this.createBox(),this.renderAll()},patchPhotoRefresh:function(e){XN.page.albumPhoto.delEvent("onPhotoRefresh",ILike.patchPhotoRefresh),ILike.inputParams.id=e,ILike.init(ILike.inputParams)}};(function(){var e=function(e){var t=getILike(e),n=t.likeList,r="";for(var i=0,s=n.length;i<s;i++){var o=n[i].keepUse?" lively-user":"",u=n[i].keepUse?"连续登录7天, 即可获得橙名特权":n[i].name;r+=["<li>",'<a namecard="'+n[i].id+'" href="'+t.urlProfile+"?id="+n[i].id+'" target="_blank">','<img src="'+n[i].headUrl+'" alt="'+n[i].name+'" />',"</a>","</li>"].join("")}t.ilikeDetailBox.forEach(function(e){e.innerHTML=r,e.style.display="block"})},t=function(e){var t=getILike(e);t.userLike==1?t.ilikeButton.forEach(function(e){e.innerHTML="取消赞"}):t.ilikeButton.forEach(function(e){e.innerHTML="赞"})},n=function(e){var t=getILike(e),n;t.likeCount>0&&(t.userLike===!0?(t.likeCount-1>0&&(n='<a href="javascript:;" onclick="ILike_toggleShow(\''+t.type+"',"+t.id+","+t.userId+')" href="javascript:;">我和'+(t.likeCount-1)+"个人觉得赞！</a>"),t.likeCount-1==0&&(n="我觉得赞！")):n="<a onclick=\"ILike_toggleShow('"+t.type+"','"+t.id+"',"+t.userId+')" href="javascript:;">'+t.likeCount+"个人觉得赞！"),n?t.ilikeHeader.forEach(function(e){e.parentNode.style.display="block",e.innerHTML=n}):t.ilikeHeader.forEach(function(e){e.parentNode.style.display="none"})},r=function(r,i){var s=getILike(r);i||t(r),n(r),s.isDetailShow&&e(r)};ILike_createBox=function(e){var t="",n="none",r="";e.digged=isNaN(e.digged)?0:e.digged,e.digged&&!e.userDigged?t='<a href="javascript:;" onclick="ILike_toggleShow(\''+e.type+"','"+e.id+"','"+e.userId+"')\">"+e.digged+"个人觉得赞！</a>":e.digged&&e.userDigged?t='<a href="javascript:;" onclick="ILike_toggleShow(\''+e.type+"','"+e.id+"','"+e.userId+"')\">我和"+e.digged+"个人觉得赞！</a>":!e.digged&&e.userDigged&&(t="我觉得赞！");if(e.digged||e.userDigged)n="block";r+='<div class="mincmt-diggers statuscmtitem" style="display:'+n+'">',r+="<p>"+t+"</p>",r+='<ul id="diggers'+e.id+'" class="digger"></ul>',r+="</div>";if(!getILike(e.type+"_"+e.id)){var i=XN.cookie.get("id"),s=new XN.app.ILike({type:e.type,id:e.id,ownerId:e.ownerId,likeCount:e.digged,userLike:!!e.userDigged,userId:i});s.init()}return r},iLike_init_n=function(e,t){var n=document.getElementById("get-params-for-ilike-"+e),r;object.use("dom",function(e){r=e});if(n){var i=n.getElementsByTagName("div")[0],s=JSON.parse(i.innerHTML),o=i.id.split("-")[2],u=s.type=="share_edm"?"edm":s.type;u=="page"&&(u=t);if(!document.getElementById("get-params-for-ilike-"+e).ilikeInited&&!getILike(u+"_"+e)){var a=isNaN(s.digged)?0:s.digged,f={type:u,id:e,ownerId:s.oid,likeCount:a,userLike:!!s.userDigged,userId:XN.user.id},l=new XN.app.ILike(f);l.init();var c=r.getElements("[id=get-params-for-ilike-"+e+"]");c.forEach(function(e){e.ilikeInited=!0})}var h=$("newsfeed-"+o)?$("feedbody"+e):$("ilikebody"+e);if(!h){var p=$("newsfeed-"+o)?$("feedbody"+o):$("ilikebody"+o);p||(p=$("get-params-for-ilike-"+e)),r.wrap(p);if(p.getParent(".a-feed"))var d=p.getParent(".a-feed").getElement(".reply-new-body");var v=$("newsfeed-"+o)?$("newsfeed-"+o):$("status-"+o),m=Sizzle(".details",v)[0];h=$element("div"),h.id=$("newsfeed-"+o)?"feedbody"+e:"ilikebody"+e,h.className="ilike-body",!$("newsfeed-"+o)&&Sizzle(".legend",v).length>0?XN.dom.insertAfter(h,Sizzle(".legend",v)[0]):d?d.parentNode.insertBefore(h,d):p.parentNode.insertBefore(h,p),h.innerHTML='<div class="min-cmtbox statustab"><div class="mincmt-body"><div style="display:none" class="mincmt-diggers statuscmtitem"><p></p><ul class="digger" id="diggers'+e+'"></ul></div></div></div>'}return!0}return!1},ILike_toggleUserLike=function(e,t,n,i,s,o){var u;object.use("dom",function(e){u=e}),iLike_init_n(t,e);var e=e=="share_edm"?"edm":e,a=getILike(e+"_"+t),f=[];u.getElements("[id=ilikebody"+t+"]").length>=1?f=u.getElements("[id=ilikebody"+t+"]"):u.getElements("[id=feedbody"+t+"]").length>=1?f=u.getElements("[id=feedbody"+t+"]"):u.getElements("[id=share_ilike_"+t+"]").length>=1&&(f=u.getElements("[id=share_ilike_"+t+"]")),a.ilikeButton=u.getElements("[id=ILike"+t+"]"),a.ilikeHeader=[],f.forEach(function(e){var n=XN.dom.getElementsByClassName("mincmt-diggers",e);n.length?a.ilikeHeader.push(n[0].getElementsByTagName("p")[0]):a.ilikeHeader.push(Sizzle(".mincmt-diggers",$("get-params-for-ilike-"+t).parentNode)[0].getElementsByTagName("p")[0])}),a.ilikeDetailBox=u.getElements("[id=diggers"+t+"]"),a.ownerId=i,a.guestName=s;if(o){a.likeCount=o.likeCount,a.userLike=o.ownerLike,a.likeList=o.likeList,r(a.gid,!0);return}a.userLike==1?(a.addEvent("removeSuccess",function(){r(a.gid),$("XILike"+t)&&($("XILike"+t).className="ilike-link",$("XILike"+t).innerHTML="赞")}),a.remove()):(a.addEvent("addSuccess",function(){r(a.gid),$("XILike"+t)&&($("XILike"+t).innerHTML="取消赞")}),a.add())},ILike_toggleShow=function(t,n,r){iLike_init_n(n,t);var i;object.use("dom",function(e){i=e});var t=t=="share_edm"?"edm":t,s=getILike(t+"_"+n),o=$("ilikebody"+n)?$("ilikebody"+n):$("feedbody"+n);s.ilikeButton=$("ILike"+n),s.ilikeHeader=XN.dom.getElementsByClassName("mincmt-diggers",o)[0].getElementsByTagName("p")[0],s.ilikeDetailBox=i.getElements("[id=diggers"+n+"]"),s.isDetailShow===!0?s.ilikeDetailBox.forEach(function(e){e.style.display="none"}):(s.addEvent("getViewDetailSuccess",function(){e(s.gid)}),s.viewDetail()),s.isDetailShow=s.isDetailShow===!0?!1:!0},XN.dom.ready(function(){if(!window.__delegateLike){var e;window.__delegateLike=!0,object.use("dom",function(t){e=t}),e.getElement("body").delegate(".ilike_comment","click",function(e){XN.event.stop(e);var t=XN.JSON.parse(this.getAttribute("comment-data")),n=["stype","cid","rid","uid","oid","roid","name","url","liked"],r=this,i=t.stype+"comment_"+t.cid,s,o,u,a="";for(o in n)if(n.hasOwnProperty(o)&&typeof t[n[o]]=="undefined")return XN.Do.alert("缺少必要参数："+n[o]),!1;getILike(i)?(s=getILike(i),u=s.userLike):(s=new XN.app.ILike(t),s.commentInit(),u=t.liked),u?(s.addEvent("removeSuccess",function(){$(r).delClass("ilike_comment_liked"),a=s.likeCount>0?s.likeCount+" ":"",r.innerHTML=a+"赞"}),s.commentRemove()):(s.addEvent("addSuccess",function(){$(r).addClass("ilike_comment_liked"),a=s.likeCount>0?s.likeCount+" ":"",r.innerHTML=a+"取消赞"}),s.commentAdd())},2)}}),XN.dom.ready(function(){if(!window.__delegateLikeIcon){window.__delegateLikeIcon=!0;var e;object.use("dom",function(t){e=t}),e.getElement("body").delegate(".ilike_comment_icon","click",function(e){XN.event.stop(e);var t=XN.JSON.parse(this.getAttribute("comment-data")),n=["stype","cid","rid","uid","oid","roid","name","url","liked"],r=this,i=t.stype+"comment_"+t.cid,s,o,u,a="";for(o in n)if(n.hasOwnProperty(o)&&typeof t[n[o]]=="undefined")return XN.Do.alert("缺少必要参数："+n[o]),!1;getILike(i)?(s=getILike(i),u=s.userLike):(s=new XN.app.ILike(t),s.commentInit(),u=t.liked),u?(s.addEvent("removeSuccess",function(){$(r).delClass("ilike_comment_liked"),a=s.likeCount>0?s.likeCount+" ":"",r.innerHTML=a}),s.commentRemove()):(s.addEvent("addSuccess",function(){$(r).addClass("ilike_comment_liked"),a=s.likeCount>0?s.likeCount+" ":"",r.innerHTML=a}),s.commentAdd())},2)}})})();try{XN.APP.status&&!window.ilike_listen_status&&(XN.APP.status.addEvent("ILikeInit",function(e,t,n,r,i,s,o){if(t=="blog"||t=="album"||t=="photo"||t=="share"||t=="edm"){var u=t;o&&o=="share_edm"&&(u="edm");var a=ILike_createBox({type:u,id:n,ownerId:r,digged:i,userDigged:s});e.push(a)}}),window.ilike_listen_status=!0)}catch(e){};