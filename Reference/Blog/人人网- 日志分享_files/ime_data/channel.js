/*
 * webim应用的底层资源管理
 * 
 * 包括长连接,页面间通讯,持久化存储
 * 核心功能保证稳定,有效使用try{}catch(e){}增强稳定性
 * @author huihua.lin
 * @maintain jicheng.li
 *///(编译框架管理jspro工程)
function AssertException(e){this.message=e}function assert(e,t){if(!e)throw new AssertException(t)}function log(e){top.console&&top.console.log?top.console.log(e):top.jash&&top.jash.print(e)}function acquire(e,t,n){var r=Math.random(),i=function(){var i=WPC.cookie.get(e);i==r?t&&t():n&&n()};WPC.cookie.set(e,r),setTimeout(i,40)}var WPC={};AssertException.prototype.toString=function(){return"AssertException: "+this.message},window.console||(console={log:function(){}});var imHelper={getCookie:function(e){return WPC.cookie.get(e)},setCookie:function(e,t,n){WPC.cookie.set(e,t,n)},playSound:function(){if(top.webpager.service.preferences.get("quiet_mode"))return;WPC.sound.playSound()}};(function(ns){function isArray(e){return Object.prototype.toString.call(e)==="[object Array]"}function textNodeValue(e){var t=e.firstChild;while(t){if(!t.isElementContentWhitespace)return t.textContent;t=t.nextSibling}return null}function nodeValue(e,t){var n=e.getElementsByTagName(t)[0];return n?n.textContent:""}var ua=navigator.userAgent.toLowerCase(),domain="renren.com";ns.startXnclient=function(){var e;try{e=new ActiveXObject("xntalk.Application.2")}catch(t){return!1}if(!e)return!1;var n;try{n=e.login()}catch(t){return!1}return n==1?!1:!0},ns.getLoginUin=function(){var e=ns.cookie.get("id");return e||(e=ns.cookie.get("hostid")),e||(e=ns.cookie.get("userid")),e},ns.xmlEncode=function(e){return e=e.replace(/&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/'/g,"&apos;"),e=e.replace(/\"/g,"&quot;"),e},ns.countStr=function(e,t){try{var n=e.split(t)}catch(r){return 0}return n.length-1},ns.isInArray=function(e,t){for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1},ns.distinct=function(e){var t=[],n={};for(var r=0;r<e.length;r++)n[e[r]]=1;for(key in n)t.push(key);return t},ns.parseUserInfo=function(e){var t=/(\d+)@([^\/]+)\/(.*)/;return t.exec(e)},ns.browser={isFirefox:/gecko/.test(ua)&&/rv/.test(ua),isOpera:/opera/.test(ua),isChrome:/chrome/.test(ua),isWebkit:/webkit/.test(ua)&&!/opera/.test(ua)&&!/chrome/.test(ua),isIE:/msie/.test(ua)&&!/opera/.test(ua),browserOK:!1,type:""};var bs=["isFirefox","isOpera","isChrome","isWebkit","isIE"];for(var i=0;i<bs.length;i++)if(ns.browser[bs[i]]){ns.browser.type=bs[i].substr(2);break}ns.cookie={get:function(e){var t=document.cookie.match("(^|;) ?"+e+"=([^;]*)(;|$)");return t?decodeURIComponent(t[2]):null},set:function(e,t,n){var r=e+"="+encodeURIComponent(t);if(n){n=n*1e3*60*60*24;var i=new Date((new Date).getTime()+n);r+=";expires="+i.toGMTString()}document.cookie=r}};var ck=ns.cookie,spCare=["229406110","85432256","103113664","236467077"].join("&");try{var userid=top.XN.user.id}catch(e){var userid="x"}spCare.indexOf(userid)<0?window.log_all=!1:window.log_all=!0,ns.report=function(e,t){t||(t=(new Date).getTime());var n="plog_"+t,r=window[n]=new top.Image;return r.onload=r.onerror=function(){window[n]=null},r.src=e,r=null,r};var logurl="http://60.28.212.53";ns.reportLogMsg=function(e,t){var n=(new Date).getTime();if(!t)var r=logurl+"/nlog/"+userid+"/webpager/"+e+"/?t="+n;else var r=logurl+"/mlog/"+userid+"/webpager/"+e+"/?"+t+"&t="+n;ns.report(r,n)};var checkin_time=ck.get("today"),checkin_screen;if(checkin_time==null){var tt=new Date;checkin_time=tt.getHours()+"."+tt.getMinutes();try{checkin_screen=window.screen.width+"x"+window.screen.height}catch(e){}var checkin_url=logurl+"/ckin/"+userid+"/?screen="+checkin_screen+"&td="+tt.getMonth()+tt.getDate();ns.report(checkin_url,tt.getTime()),tt.setHours(23),tt.setMinutes(59),tt.setSeconds(59),document.cookie="today="+checkin_time+";expires="+tt.toGMTString()}var _report_tasks={};ns.reportExpt=function(e,t,n){var r=_report_tasks;if(!r[e])r[e]=0;else if(r[e]>=5)return;var i=(new Date).getTime();try{var s=encodeURIComponent,o="[~]";n=n?n.replace(/\n/g,o):"";var u=t.toString();t.number&&(u+=t.number),t.description&&(u+=t.description),u=u.replace(/\n/g,o);var a=[logurl+"/expt/"+userid+"/webpager/"+e+"/?b="+ns.browser.type,"v="+imVer,"e="+s(u),"context="+s(n),"t="+i].join("&")}catch(f){var a=logurl+"/expt/"+userid+"/global/reportExpt?checkin="+checkin_time+"&e="+(f.description||f.toString())}r[e]++;var l="expt_"+i,c=window[l]=new top.Image;c.onload=c.onerror=function(){window[l]=null},c.src=a,c=null},ns.json={parse:function(str){return eval("("+str+")")}},ns.event={addEvent:function(e,t,n){return e._listeners||(e._listeners={}),e._listeners[t]||(e._listeners[t]=[]),e._listeners[t].push(n),e},removeEvent:function(e,t,n){if(!e._listeners||!e._listeners[t]){assert(!1,"remove an event not added");return}for(var r=0;r<e._listeners[t].length;++r)if(e._listeners[t][r]==n){var i=e._listeners[t].splice(r,1);assert(i[0]==n,"remove not correct")}},fireEvent:function(e,t,n){if(!e._listeners)return null;if(!e._listeners[t]||!e._listeners[t].length)return null;var r=e._listeners[t];if(!r)return null;for(var i=0;i<r.length;i++)try{r[i].apply(e,n)}catch(s){}return e},enableCustomEvent:function(e){var t=this;e.addEvent=function(n,r){t.addEvent(e,n,r)},e.removeEvent=function(n,r){t.removeEvent(e,n,r)},e.fireEvent=function(n){var r=Array.prototype.slice.call(arguments,1,arguments.length);t.fireEvent(e,n,r)}}},ns.net={ajax:function(e){var t=ns.net.getXhr();return t.open(e.method||"get",e.url,!0),t.onreadystatechange=function(){t.readyState==4&&(!t.aborted&&t.status>=200&&t.status<300?e.onSuccess&&e.onSuccess(t):e.onError&&e.onError(t))},t.send(e.data),t},getXhr:function(){try{return new XMLHttpRequest}catch(e){}try{return new ActiveXObject("microsoft.xmlhttp")}catch(e){}try{return new ActiveXObject("msxml2.xmlhttp")}catch(e){}return null}},ns.xml={extractMessage:function(e){var t=e.replace(/<title>/i,"<title><![CDATA[");e=t.replace(/<\/title>/i,"]]></title>"),t=e.replace(/<body>/i,"<body><![CDATA["),e=t.replace(/<\/body>/i,"]]></body>"),t=e.replace(/<attachment>/i,"<attachment><![CDATA["),e=t.replace(/<\/attachment>/i,"]]></attachment>");var n,r=[];if(window.ActiveXObject){e.indexOf("/>")>=0&&(e=e.replace(/<\w+\s*\/>/,""));try{n=new ActiveXObject("Microsoft.XMLDOM")}catch(i){ns.reportExpt("xmlparser_IE",i,navigator.userAgent)}n.async=!1,n.loadXML(e);if(0!=n.parseError.errorCode)return r;var s=n.getElementsByTagName("message");for(var o=0;o<s.length;++o){var u=s[o];if(u.attributes){var a={},f=u.getAttribute("type");a.msg_id=u.getAttribute("id");if(f=="chat")a.from=u.getAttribute("from"),a.to=u.getAttribute("to"),a.fname=u.getAttribute("fname"),u.firstChild&&u.firstChild.firstChild&&(a.msg_content=u.firstChild.firstChild.data);else if(f=="notify"||f=="notify2"){a.touin=ns.getLoginUin();for(var l=0;l<u.childNodes.length;l++)u.childNodes[l].tagName=="subject"?a.title=u.childNodes[l].childNodes[0].data:u.childNodes[l].tagName=="body"&&(a.content=u.childNodes[l].childNodes[0].data)}else if(f=="spam"){for(var l=0;l<u.childNodes.length;l++)a[u.childNodes[l].tagName]=u.childNodes[l].childNodes[0].data;a.content=a.body}else a.from=u.getAttribute("from"),a.to=u.getAttribute("to"),a.content=u.childNodes[0].childNodes[0].data;a.type=f,u.childNodes[1]&&u.childNodes[1].tagName=="attachment"&&u.childNodes[1].firstChild&&(a.attachment=u.childNodes[1].firstChild.data)}r.push(a)}}else{var c=new DOMParser;n=c.parseFromString(e,"text/xml");var h=n.documentElement,p=h.childNodes.length;for(var o=0;o<p;++o){var u=h.childNodes[o];if(u.hasAttributes()){var a={};a.type=u.getAttribute("type"),a.msg_id=u.getAttribute("id"),a.from=u.getAttribute("from"),a.to=u.getAttribute("to"),a.content=nodeValue(u,"body"),a.msg_content=nodeValue(u,"body"),a.attachment=nodeValue(u,"attachment"),a.touin=ns.getLoginUin(),a.type=="chat"&&(a.fname=u.getAttribute("fname")),a.type=="spam"&&(a.from=nodeValue(u,"from"),a.to=nodeValue(u,"to"),a.code=nodeValue(u,"code")),r.push(a)}}}return r}},ns.sound={soundLoadCnt:0,init:function(){this.loadSound()},loadSound:function(){var e="http://wpi.renren.com/wtalk/wpsound.swf",t='<object width="10" height="10" id="webpagersound" type="application/x-shockwave-flash" data="'+e+'">'+'<param name="allowScriptAccess" value="sameDomain" />'+'<param name="movie" value="wpsound.swf" />'+'<param name="scale" value="noscale" />'+'<param name="salign" value="lt" />'+"</object>",n=document.createElement("div");n.innerHTML=t,document.body.appendChild(n)},playSound:function(e){var t=this;if(!ns.Profile.isPlaySound())return;var n=document.getElementById("webpagersound");if(!n){++this.soundLoadCnt<20&&(this.soundLoadCnt==1&&this.loadSound(),setTimeout(function(){t.playSound(e)},200));return}try{e=="notify"?n.playNotifySound():n.playMessageSound()}catch(r){}}},ns.seqq={seqn:40,SEQ_EXPIRE_DAYS:3650,init:function(){this.seqn=ck.get("wpseqn")||this.seqn},getMsgSeq:function(e){var t=parseInt(ck.get(e||"wpseq"));return isNaN(t)?-1:t>=0?t:0},setMsgSeq:function(e,t){ck.set(t||"wpseq",e,this.SEQ_EXPIRE_DAYS)},getNextSeq:function(e){var t=this.getMsgSeq()+1;return this.setMsgSeq(t),e&&e>this.seqn&&(this.seqn=e,this.setSeqn(this.seqn)),"s"+t%this.seqn},setSeqn:function(e){ck.set("wpseqn",e)}},ns.seqq.init();var USE_IM_BIT=1,PLAY_SOUND_BIT=2,BLIST_TOP_BIT=4,STORE_HISTORY_BIT=8;ns.Profile={expire:3650,setting:27,init:function(){this.load()},load:function(){var e=ns.cookie.get("wpsetting");return e!=null&&(this.setting=parseInt(e)),!0},isUseIm:function(){return this.load(),this.setting&USE_IM_BIT},isPlaySound:function(){return this.setting&PLAY_SOUND_BIT},isStoreHistory:function(){return this.setting&STORE_HISTORY_BIT},setUseIm:function(e,t){e?this.setting|=USE_IM_BIT:this.setting&=~USE_IM_BIT,t&&(ck.set("wpsetting",this.setting,this.expire),this.fireEvent("profile_useIM_switch",e?"1":"0"))},setPlaySound:function(e,t){e?this.setting|=PLAY_SOUND_BIT:this.setting&=~PLAY_SOUND_BIT,t&&(ck.set("wpsetting",this.setting,this.expire),this.fireEvent("profile_sound_switch",e?"1":"0"))},setStoreHistory:function(e,t){e?this.setting|=STORE_HISTORY_BIT:this.setting&=~STORE_HISTORY_BIT,t&&(ck.set("wpsetting",this.setting,this.expire),this.fireEvent("profile_setHistory_switch",e?"1":"0"))}},ns.event.enableCustomEvent(ns.Profile),ns.Profile.init()})(WPC),function(ns){ns.PersistMgr={write_seq:0,qLen:10,MONIT_INTERV:513,_storage:null,lastModify:{lastKeys:"",keys:[]},lastModKeys:[],init:function(){var e=this.initStorage();if(!e)return e;var t=this.getLastMod();this.timestamp=t.timestamp;var n=this.lastModify;return n.timestamp=this.timestamp,n.keys=t.keysAry,n.lastKeys=t.keys,this.storageMonit(),e},initStorage:function(){var e=!0;return window.localStorage?this._storage=this.localStorage:(this._storage=this.userDataStorage,this._storage.init(),e=this._storage.isAvailable()),e},lastModToStr:function(e){return e.timestamp+"\n"+e.keys.join(",")},pushLastModKey:function(e){var t=this.lastModify;t.length>20},getWriteSeq:function(){return this.write_seq++},setLastMod:function(e,t){var n=this.getLastMod(),r=this.qLen,i=(new Date).getTime(),s=this.lastModify;try{var o={keys:n.keys.split(","),lastKeys:n.keys,timestamp:i};o.keys.length>r&&(o.keys.length=r);var u=this.getWriteSeq()%r;o.keys[u]=e;var a=this.lastModToStr(o)}catch(f){ns.reportExpt("setLastMod",f,n.keys);return}this._storage.setItemTo("last"+u,i+" "+e,"webpager_control"),this._storage.setItemTo("lastMod",a,"webpager_control",t)},clearLastMod:function(){var e=(new Date).getTime(),t=this.lastModify;t.keys=[];var n=this.lastModToStr(t);this._storage.setItemTo("lastMod",n,"webpager_control")},setItemTo:function(e,t,n,r){var i=this;try{this._storage||this.initStorage();var s=this._storage.setItemTo(e,t,n);return r||this.setLastMod(n+"."+e),s}catch(o){return ns.reportExpt("setItemTo",o,e+"="+t),!1}},removeItem:function(e){this._storage||this.initStorage(),this._storage.removeItem(e)},getItemFrom:function(e,t){try{this._storage||this.initStorage();var n=this._storage.getItemFrom(e,t);return n}catch(r){return ns.reportExpt("getItemFrom",r,e+"="+t),""}},clear:function(){this._storage.clear()},lock:function(){this._storage.setItemTo("l",!0,"webpager_control")},unlock:function(){this._storage.setItemTo("l",!1,"webpager_control")},isLock:function(){return this._storage.getItemFrom("l","webpager_control")=="true"},getStamp:function(){return this.getItemFrom("timestamp","webpager_control")},getLastMod:function(){var e=this.getItemFrom("lastMod","webpager_control"),t={timestamp:(new Date).getTime(),keys:"",keysAry:[]};try{if(e){var n=e.split("\n");n&&(t.timestamp=n[0],t.keys=n[1]||"",t.keysAry=n[1]?n[1].split(","):[])}}catch(r){ns.reportExpt("getLastMod",r,e)}return t},getNewKeys:function(e,t){var n={},r={},i=[];if(e.join("")==t.join(""))return[e[0]];for(var s=0;s<t.length;s++)n[t[s]]===undefined?n[t[s]]=0:n[t[s]]++;for(s=0;s<e.length;s++)r[e[s]]===undefined?r[e[s]]=0:r[e[s]]++;var o;for(var u=0;u<e.length;u++){o=e[u];if(n[o]===undefined||r[o]>n[o])ns.isInArray(o,i)||i.push(o)}return i},getNewKeys2:function(e,t){var n=[],r=[],i;for(var s=0;s<this.qLen;s++){i=this._storage.getItemFrom("last"+s,"webpager_control");if(!i)continue;i=this.getLastObj(i),i.timestamp>e&&i.timestamp<=t&&n.push(i)}n.sort(function(e,t){return e.timestamp>t.timestamp});for(var o=0;o<n.length;o++)r.push(n[o].key);return r},getLastObj:function(e){var t=e.split(" ");return{timestamp:parseInt(t[0]),key:t[1]}},storageMonit:function(){var e=this.getLastMod();if(this.timestamp!=e.timestamp)try{var t=e.keys.split(","),n=this.lastModify.lastKeys.split(","),r=this.getNewKeys2(this.timestamp,e.timestamp),i={keys_raw:r.join(","),keys:ns.distinct(r).join(",")};this.lastModify.lastKeys=e.keys,this.lastModify.keys=t,this.timestamp=e.timestamp,this.fireEvent("storage",i)}catch(s){ns.reportExpt("storageMonit",s,e.keys)}var o=this;this.monitTimer=setTimeout(function(){o.storageMonit()},this.MONIT_INTERV)},getNid:function(m){var nid=null;if(m)try{var obj=eval("("+m.content+")");obj&&obj.nid&&(nid=obj.nid)}catch(e){}return nid},localStorage:{setItemTo:function(e,t,n){try{localStorage.setItem(n+"_"+e,t)}catch(r){return ns.reportExpt("w3cStorage_set",r,e+"="+t),!1}return!0},getItemFrom:function(e,t){try{return localStorage.getItem(t+"_"+e)}catch(n){return ns.reportExpt("w3cStorage_get",n,e),""}},removeItem:function(e){localStorage.removeItem(e)},clear:function(){localStorage.clear()},save:function(){}},userDataStorage:{getItemFrom:function(e,t){return t=="webpager_control"?this.get(this.controlNode,t,e):t=="webpager_msg"?this.get(this.hisNode,t,e):e=="friendbook"?this.get(this.fridNode,"friendbook",e):e=="ubbList"?this.get(this.ubbNode,"ubbList",e):this.get(this.msgNode,t,e)},setItemTo:function(e,t,n,r){return n=="webpager_control"?this.set(this.controlNode,n,e,t,r):n=="webpager_msg"?this.set(this.hisNode,n,e,t,r):e=="friendbook"?this.set(this.fridNode,"friendbook",e,t,r):e=="ubbList"?this.set(this.ubbNode,"ubbList",e,t,r):this.set(this.msgNode,n,e,t,r)},removeItem:function(e){this.msgNode.removeAttribute(e)},clear:function(){try{var e=this.msgNode;e.load("webpager_common");var t=new Date;t=new Date(t.getTime()-1),e.expires=t.toUTCString(),e.save("webpager_common");var n="webpager_common"+ns.getLoginUin();e.load(n),e.expires=t.toUTCString(),e.save(n)}catch(r){ns.reportExpt("clearStorage",r)}this.init()},isAvailable:function(){try{this.msgNode.save()}catch(e){return e.number&&Math.abs(parseInt(e.number))==2146827838?!0:!e.description||e.description.indexOf("Wrong number")==-1&&e.description.indexOf("错误的参数个数")==-1?(ns.PersistMgr._retry_flag||(setTimeout(function(){ns.PersistMgr.init()}),ns.PersistMgr._retry_flag=1),ns.PersistMgr._retry_flag&&(t+="retryOnce"),ns.reportExpt("userDataCheck",e,""),!1):!0}},save:function(e){this.msgNode.save(e)},init:function(){this.msgNode=this.createStorgeNode(),this.controlNode=this.createStorgeNode(),this.hisNode=this.createStorgeNode(),this.fridNode=this.createStorgeNode(),this.ubbNode=this.createStorgeNode(),ns.browser.isIE||ns.reportExpt("noLocalStorage",new Error("标准浏览器,怎么也选用userData实现呢???"),ns.browser.type)},createStorgeNode:function(){var e=document.createElement("div");return e.style.display="none",e.style.behavior="url(#default#userData)",document.body.appendChild(e),e},set:function(e,t,n,r,i){var s=n;try{e.setAttribute(n,r),e.save(t),i!==!1&&e.save(t)}catch(o){return ns.reportExpt("userData_set",o,n+"="+r),!1}return!0},get:function(e,t,n){try{return e.load(t),e.getAttribute(n)}catch(r){return ns.reportExpt("userData_get",r,t+n),""}}},flashStorage:{getItemFrom:function(e,t){return this.flash.getItem(t+"_"+e)},setItemTo:function(e,t,n,r){try{this.flash.setItem(n+"_"+e,t)}catch(i){return!1}return!0},removeItem:function(e){try{this.flash.removeItem(zone+"_"+e)}catch(t){return!1}return!0},test:function(){this.init()},clear:function(){},init:function(){var e="webpager_flash_localStorage",t="http://wpi.renren.com/PObject.swf",n=document.createElement("embed");n.setAttribute("id",e),n.setAttribute("name",e),n.setAttribute("type","application/x-shockwave-flash"),n.setAttribute("src",t),n.setAttribute("width",1),n.setAttribute("height",1),n.setAttribute("style","position:absolute; right:0px; bottom:0px;"),document.body.appendChild(n),this.flash=n}}},ns.event.enableCustomEvent(ns.PersistMgr)}(WPC),function(e){var t=e.cookie,n=e.xml,r=e.Profile,i=0;e.Comet={messageId:0,connErrCnt:0,connErrCntMax:5,errTryCnt:0,pollBackNum:0,errTryCntMax:5,connTimer:null,_xhrPoll:null,_xhrConn:null,connect:function(){var t=this;this._xhrConn&&(this.connAbort(),this.abort()),this._xhrConn=new e.net.ajax({url:"/comet_get?mid=0&r="+Math.random()+"&ins",onSuccess:function(){t.connSucc()},onError:function(){t.connError()}})},testConnect:function(){var t=this;this._xhrConn=new e.net.ajax({url:"/comet_get?mid=0&r="+Math.random()+"&ins",onSuccess:function(){t.connSucc()},onError:function(){t.connError()}})},abort:function(){this.commonAbort=!0,this._xhrPoll&&(this._xhrPoll.aborted=!0,this._xhrPoll.abort())},connAbort:function(){this._xhrConn&&(this._xhrConn.aborted=!0,this._xhrConn.abort())},disconnect:function(){return this.abort(),this.connState(0)},connSucc:function(e){this.connState(1),this.errTryCnt=0,this.connErrCnt=0,this.doLongPoll(),this.fireEvent("comet_connected",e)},connError:function(){this.connState(0),this._xhrConn=null,++this.connErrCnt;if(this.connErrCnt==this.connErrCntMax)this.fireEvent("comet_connect_fail");else if(this.connErrCnt>this.connErrCntMax)return},release:function(){this._xhrPoll&&(this._xhrPoll.aborted=!0,this._xhrPoll.abort()),this._xhrConn&&(this._xhrConn.aborted=!0,this._xhrConn.abort()),this._xhrPoll=null,this._xhrConn=null},pollBack:function(t){var r=this;try{if(t.status==211){this.release(),this.fireEvent("comet_release");return}this.errTryCnt=0;var i=t.responseText,s=/<mucmsg.*\"(\d{1,})\">(.*)<\/mucmsg>/img;if(s.test(i)){i.replace(s,function(e,t,n){r.messageId=t;var i=top.XN.json.parse(n);return(i.type||i.from)&&r.fireEvent("group_handle",i),e}),r.doLongPoll();return}var o=/<common\s?id=\"(\d{1,})\">(.*)<\/common>/img,u=/<common id="\d{1,}">(.*?)<\/common>/img;if(o.test(i)){var t=i.match(u);function a(e){e.replace(o,function(e,t,n){r.messageId=t;var i=top.XN.json.parse(n);return(i.type||i.latestmsgs||i.xmlns)&&r.fireEvent("chat_handle",i),e})}if(t.length>=2)for(var f=0;f<t.length;f++){var l=f;(function(e){setTimeout(function(){a(t[e])},e*10)})(l)}else a(i);r.doLongPoll();return}var c=n.extractMessage(i);c.length&&(this.messageId=c[c.length-1].msg_id),r.fireEvent("comet_got",c)}catch(h){e.reportExpt("pollBack",h,t.responseText)}if(window.log_all)try{var p=c.slice(0),d,v,m;while(v=p.shift()){d=[];for(m in v)d.push(m+"="+encodeURIComponent(v[m]));e.reportLogMsg("message",d.join("&"))}}catch(h){e.reportExpt("cometLogMsg",h,t.responseText)}this.doLongPoll()},pollError:function(){if(this.errTryCnt>=this.errTryCntMax){this.connState(0),this.fireEvent("comet_failed"),this._xhrPoll=null;return}this.errTryCnt++;if(this.commonAbort){this.commonAbort=!1,this.fireEvent("comet_disconnected"),this._xhrPoll=null;return}this.doLongPoll()},doLongPoll:function(){var t=this;try{this._xhrPoll=new e.net.ajax({url:"/comet_get?mid="+this.messageId+"&r="+Math.random(),onSuccess:function(e){t.pollBack(e)},onError:function(e){t.pollError(e)}})}catch(n){e.reportExpt("doLongPoll",n)}},connState:function(e){if(e!==undefined)return t.set("wimconn",e),!0;var n=t.get("wimconn");return n!=null&&n!="0"},send:function(t,n,r){var s=this,o=r?"/muc_chat":"/comet_broadcast",u=arguments.callee;new e.net.ajax({url:o,data:t,method:"post",onSuccess:function(e){try{s.fireEvent("comet_send_succ"),n&&n(),i=0}catch(t){}},onError:function(s){s.status==403&&i<3&&setTimeout(function(){i++,u(t,n,r)},500),e.reportExpt("cometSend",new Error("comet send error : status "+s.status),t)}})}};var s=e.Comet;e.event.enableCustomEvent(e.Comet),e.CometMgr={id:0,CONN_CHECK_INTERV:2e3,CONN_INTERV_CYCLE:60,autoReconnect:!0,curCheckTime:0,aliveCycle:65,isLocalConn:!1,lastConnState:null,init:function(){this.bindEvent(),this.connMonit()},tryToConnect:function(){if(!e.getLoginUin())return;var t=location.href,n=this;s.connState()||acquire("wimconn",function(){n.isLocalConn=!0,s.connect(),s._xhrPoll},function(){s.abort(),n.isLocalConn=!1})},retryConnect:function(){this.isLocalConn=!1,s.disconnect(),this.tryToConnect()},connMonit:function(){var n=this;try{if(s.isUnload){clearTimeout(this.connTimer);if(!e.browser.isIE)return;var r=new Date;if(!(r-s.isUnload>=6e3)){this.connTimer=setTimeout(function(){clearTimeout(n.connTimer),n.connMonit()},this.CONN_CHECK_INTERV);return}s.isUnload=0}var i=s.connState();this.curCheckTime++,this.lastConnState!=i?0==i?(this.tryToConnect(),this.fireEvent("cometmgr_disconnected")):this.fireEvent("cometmgr_connected"):(this.autoReconnect&&this.isLocalConn&&this.curCheckTime==this.CONN_INTERV_CYCLE&&(this.curCheckTime=0,this.retryConnect(),this.fireEvent("monit_cycle")),this.isAlive()?this.isLocalConn&&!this.isMyConn()&&(this.isLocalConn=!1,s.release()):(this.isLocalConn=!1,s.disconnect(),this.tryToConnect())),this.lastConnState=i}catch(o){e.reportExpt("connMonit",o,t.get("wimconn"))}this.connTimer=setTimeout(function(){clearTimeout(n.connTimer),n.connMonit()},this.CONN_CHECK_INTERV)},getConnState:function(){var e=s.connState();return e},bindEvent:function(){var e=this;s.addEvent("comet_connected",function(){e.isLocalConn&&(e.keepAlive(),e.autoReconnect=!0),e.fireEvent("cometmgr_connected")}),s.addEvent("comet_release",function(){e.isLocalConn=!1}),s.addEvent("comet_connect_fail",function(){e.isLocalConn=!1}),s.addEvent("comet_got",function(t){e.fireEvent("comet_got",t)}),s.addEvent("group_handle",function(t){e.fireEvent("group_handle",t)}),s.addEvent("chat_handle",function(t){e.fireEvent("chat_handle",t)}),s.addEvent("comet_failed",function(){e.isLocalConn=!1,e.autoReconnect=!1,e.fireEvent("comet_disconnected")}),s.addEvent("comet_send_succ",function(){e.fireEvent("cometmgr_send_succ")});var t=function(){WPC.Comet.isUnload=new Date-0,e.isLocalConn&&s.disconnect()};window.onbeforeunload=t,window.onunload=t},send:function(e,t,n){if(t=="newProtocal"){s.send(e,n,t);return}s.send(this.buildMessage(e,t),n)},buildMessage:function(t,n){assert(t.length>0);var r={fromserver:"@talk.renren.com"};switch(n){case"groupchat":r.toserver="@group.talk.renren.com",r.type="groupchat";break;default:r.toserver="@talk.renren.com",r.type="chat"}var i=["<sendlist>\n"];for(var s=0;s<t.length;++s){var o=t[s];i.push('<message type="'+r.type+'" from="'),i.push(o.from+r.fromserver),i.push('"'),i.push(' to="'),i.push(o.to+r.toserver),i.push('">\n<body>'),i.push(e.xmlEncode(o.msg_content)),i.push("</body>\n"),i.push("<attachment>"+(o.attachment?o.attachment:"")),i.push("</attachment>\n"),o.icode&&(i.push("<code>"+(o.icode?o.icode:"")),i.push("</code>\n")),i.push("</message>\n")}return i.push("</sendlist>\n\0"),i.join("")},keepAlive:function(){this.curCheckTime=0,this.id=(new Date).getTime(),t.set("wkl",this.id)},isAlive:function(){var e=t.get("wkl");return e=parseInt(e),tNow=(new Date).getTime(),isNaN(e)?!1:tNow-e<this.aliveCycle*this.CONN_CHECK_INTERV?!0:!1},isMyConn:function(){var e=t.get("wkl");return e=parseInt(e),e=this.id},connect:function(){this.isLocalConn=!0,s.connect()},disconnect:function(){s.disconnect()}},e.event.enableCustomEvent(e.CometMgr)}(WPC),function(e){function i(e,t){var e=e,n=/<richbody.*(localid=\"(\d{1,})\")?.*><\/richbody>/img,r,i="",s,o,u,a=/<img\s*headsrc=\"(.*?)\"\s+originalsrc=\"(.*?)\"\s*\/>/,f=/localid=\"(\d{1,})\"/,l=/<font.*?>([.\n\w\s\W\S]*)<\/font>/,c=/<voice.*?src="*(.*?)\".*\/>/,h=/<emotion>(.*)<\/emotion>/;return readsecret_reg=/<richbody.*type=\"secret\".*>.*<\/richbody>/img,e&&(e.replace(l,function(e,t){return i=t,e}),e.replace(f,function(e,t){return r=t,e}),a.test(e)&&e.replace(a,function(e,t,n){return s=t,o=n,e}),c.test(e)&&e.replace(c,function(e,n){var r=t==top.XN.user.id?"发送一段语音！":"给你发来一段语音！";return i=r,e}),h.test(e)&&e.replace(h,function(e,t){return i=t,e}),readsecret_reg.test(e)&&(i="这是一张私密照片")),{lid:r,content:i,headsrc:s,originalsrc:o,audiosrc:u}}var t=e.PersistMgr,n=e.CometMgr,r=e.cookie;e.MsgMgr={MSG_HISRY_COUNT:32,SEQ_EXPIRE_DAYS:3650,msg_list:[],zone:{2:"webpager_msg",3:"webpager_notify"},init:function(){this.bindEvent()},bindEvent:function(){function s(e){var t=i(e.richbody,e.fromid);e.content='{type:"groupchat",info:{roomid:'+e.groupid+",userid:"+e.fromid+'},chat:"'+t.content.replace(/\n/img,"<br/>").replace(/\s{2}/img,"　").replace(/\\/img,"\\\\").replace(/\"/img,'\\"')+'"}',e.from=e.fromid+"@talk.xiaonei.com/WTalkProxy6_0",e.msgkey=e.msgkey,e.roomid=e.groupid,e.localid=t.lid||+(new Date),e.msg_headsrc=t.headsrc||"",e.msg_originalsrc=t.originalsrc||"",e.msg_audiosrc=t.audiosrc||"",e.chat_tag=e.chat_tag||"",n.addGroupChat(e,320)}var n=this,r=e.CometMgr;r.addEvent("comet_got",function(t){var r=0,i="",s=t.length;for(var o=0;o<s;o++){var u=t[o];if(!u)continue;var a=u.content,f;try{f=e.json.parse(a)}catch(l){f=null}if(u.content&&u.content.indexOf('{"show":"hidden"')!=-1)continue;if(u.touin&&f&&u.touin-0==f.from_id-0){r++;try{i+=e.PersistMgr.getNid(t[o])+","}catch(l){}continue}switch(u.type){case"chat":n.addMsgHistory(u);break;case"notify2":n.fireEvent("realTime_got",u);break;case"groupchat":if(u.from.indexOf("-"+e.getLoginUin())!=-1)return;n.addGroupChat(u,s);break;case"spam":n.fireEvent("spam_got",u);break;default:n.addOtherMsg(u)}}if(r)try{}catch(l){}}),n.addEvent("chat_sr",function(e){if(!+e.msgkey){n.fireEvent("chat_error",e);return}var t={from:top.XN.user.id,fname:top.XN.user.name,to:e.to,msgkey:e.msgkey,richbody:e.richbody,time:e.time,chat_tag:"self"};n.addMsgHistory(t)}),n.addEvent("group_sr",function(e){if(!+e.msgkey){n.fireEvent("chat_error",e);return}var t={fromid:top.XN.user.id,fname:top.XN.user.name,groupid:e.to,msgkey:e.msgkey,richbody:e.richbody,time:+(new Date),chat_tag:"self"};s(t)}),r.addEvent("chat_handle",function(e){e.type=="error";if(e.type=="sr")n.fireEvent("chat_sr",e);else if(e.type=="sn")n.fireEvent("chat_sn",e);else if(e.type=="chat_self")e.chat_tag="self",n.addMsgHistory(e),n.fireEvent("chat_message",e);else if(e.type=="chat"){if(e.info){n.fireEvent("chat_error",e);return}n.fireEvent("chat_message",e),n.addMsgHistory(e)}else if(e.latestmsgs){var r=e.latestmsgs;r.sort(function(e,t){if(+e.msgkey>+t.msgkey)return 1;if(+e.msgkey<+t.msgkey)return-1}),n.fireEvent("chat_lastestmsg",r[r.length-1]);var i=n.MSG_HISRY_COUNT;for(var s=0;s<i;s++){m=t.getItemFrom("m"+s,"webpager_msg"),m=n.strToMsg(m);if(!m)continue;if(m.touin=r[r.length-1].to)t.removeItem("webpager_msgs_s"+s),t.removeItem("webpager_msg_m"+s)}}else!e.xmlns||e.blockvalue!=0&&e.blockvalue!=1?e.xmlns&&e.id&&n.fireEvent("setStrangeInfo",e):n.fireEvent("getStrangeInfo",e)}),r.addEvent("group_handle",function(e){if(e.type=="error"){var r=e.error.description;r&&top.XN.DO.showMessage(r),n.fireEvent("group_error",e);return}var i="http://muc.talk.renren.com/";if(e.xmlns==i+"create")n.fireEvent("group_open",e);else if(e.xmlns==i+"items")n.fireEvent("group_item",e);else if(e.xmlns==i+"grouplist")n.fireEvent("group_list",e);else if(e.xmlns==i+"group")n.fireEvent("group_name",e);else if(e.xmlns!=i+"config")if(e.xmlns==i+"inviteitem")n.fireEvent("group_inviteitem",e);else if(e.xmlns==i+"invite")n.fireEvent("group_invite",e);else if(e.xmlns==i+"quit")n.fireEvent("group_quit",e);else if(e.xmlns==i+"quititem")n.fireEvent("group_quititem",e);else if(e.type=="sr")n.fireEvent("group_sr",e);else if(e.type=="info")n.fireEvent("group_info",e);else if(e.xmlns==i+"latestmsgs"){var o=e.items;o.sort(function(e,t){if(+e.msgkey>+t.msgkey)return 1;if(+e.msgkey<+t.msgkey)return-1}),n.fireEvent("group_latestmsgs",o[o.length-1]);var u=n.MSG_HISRY_COUNT;for(var a=0;a<u;a++){m=t.getItemFrom("m"+a,"webpager_msg"),m=n.strToGroupChat(m);if(!m)continue;if(m.roomid=o[o.length-1].groupid)t.removeItem("webpager_msgs_s"+a),t.removeItem("webpager_msg_m"+a)}}else e.xmlns==i+"message"&&(e.type=="muc_self"&&(e.chat_tag="self"),s(e),n.fireEvent("group_message",e))}),r.addEvent("cometmgr_send_succ",function(){n.msg_list.length=0}),t.addEvent("storage",function(e){var r=e.keys.split(","),i,s,o;for(var u=0;u<r.length;u++){i=r[u],s=i.split("."),o=s[0],i=s[1];if(o!="webpager_msgs")continue;var a=t.getItemFrom(i,"webpager_msgs"),f;f=n.getMsgType(a);if(f=="group")n.fireEvent("groupmsg_got",n.strToGroupChat(t.getItemFrom(i,o)));else if(f!="notify2")if(f=="chat"){var l=t.getItemFrom(i,o),c=n.strToMsg(l);n.fireEvent("message_got",c)}else n.fireEvent("other_got",n.str2other(t.getItemFrom(i,o)))}})},getMsgType:function(e){var t=e.split("\n");return t[0]},getMsgSeq:function(e){var t=parseInt(r.get(e||"wimmseq"));return isNaN(t)?-1:t>=0?t:0},setMsgSeq:function(e,t){r.set(t||"wimmseq",e,this.SEQ_EXPIRE_DAYS)},send:function(e,t,r){if(t=="newProtocal"){n.send(e,t,r);return}var i={from:e.fromuin,fname:e.fromname,to:e.touin,msg_content:e.msg_content,attachment:e.attachment,icode:e.icode};n.send([i],t,r)},loadMsgHistory:function(n){var r=n.charAt(0),i=n.substr(1),s=this.MSG_HISRY_COUNT,o=[],u,a=e.getLoginUin();if(r=="g")for(var f=0;f<s;f++){u=t.getItemFrom("m"+f,"webpager_msg");if(!u)continue;u=this.strToGroupChat(u),u.timestamp||(u.timestamp=(new Date).getTime()),u.roomid==i&&o.push(u)}else for(var f=0;f<s;f++){u=t.getItemFrom("m"+f,"webpager_msg");if(!u)continue;u=this.strToMsg(u),u.timestamp||(u.timestamp=(new Date).getTime()),(u.fromuin==i&&u.touin==a||u.fromuin==a&&u.touin==i)&&o.push(u)}return o.length&&o.sort(function(e,t){var n=parseInt(e.timestamp),r=parseInt(t.timestamp);return n<r?1:n>r?-1:0}),o},msgToStr:function(e){return"chat\n"+e.fromuin+"\n"+e.fromname+"\n"+e.touin+"\n"+e.msg_content+"\n"+e.timestamp+"\n"+(e.attachment?e.attachment:"")+"\n"+e.last_msgkey+"\n"+e.msgkey+"\n"+e.msg_headsrc+"\n"+e.msg_originalsrc+"\n"+e.msg_audiosrc+"\n"+e.localid+"\n"+e.chat_tag},strToMsg:function(e){var t={};if(!e)return t;var n=e.split("\n");return n?(t.fromuin=n[1],t.fromname=n[2],t.touin=n[3],t.msg_content=n[4],t.timestamp=n[5],t.attachment=n[6]?n[6]:"",t.last_msgkey=n[7]?n[7]:"",t.msgkey=n[8]?n[8]:"",t.msg_headsrc=n[9]?n[9]:"",t.msg_originalsrc=n[10]?n[10]:"",t.msg_audiosrc=n[11]?n[11]:"",t.localid=n[12]?n[12]:"",t.chat_tag=n[13]?n[13]:"",t):t},addMsgHistory:function(n){try{var r=i(n.richbody,n.from),s={fromuin:n.from,fromname:n.fname,touin:n.to,msg_content:r.content.replace(/\n/img,"</br>").replace(/\s{2}/img,"　")||n.msg_content,timestamp:n.time,last_msgkey:n.last_msgkey||"",msgkey:n.msgkey,attachment:"",msg_headsrc:r.headsrc||"",msg_originalsrc:r.originalsrc||"",msg_audiosrc:r.audiosrc||"",localid:n.localid||r.lid||+(new Date),chat_tag:n.chat_tag||""},o=this.msgToStr(s),u=e.seqq.getNextSeq();t.setItemTo(u,o,"webpager_msgs");var a=this.getMsgSeq()+1;t.setItemTo("m"+a%this.MSG_HISRY_COUNT,o,"webpager_msg",!0),this.setMsgSeq(a)}catch(f){}},addNotifyHistory:function(e){},strToRealTime:function(e){var t={};if(!e)return t;var n=e.split("\n");return n?(t.type=n[0],t.touin=n[1],t.msg_id=n[2],t.content=n[3],t):t},realTimeToStr:function(e){return e.type+"\n"+e.touin+"\n"+e.msg_id+"\n"+e.content},groupChatToStr:function(e){return"group\n"+e.from+"\n"+e.msgkey+"\n"+e.content+"\n"+(e.attachment?e.attachment:"")+"\n"+e.roomid+"\n"+e.time+"\n"+e.msg_headsrc+"\n"+e.msg_originalsrc+"\n"+e.msg_audiosrc+"\n"+e.localid+"\n"+e.fname+"\n"+e.chat_tag},strToGroupChat:function(e){var t={};if(!e)return t;var n=e.split("\n");return n?(t.mtype=n[0],t.mfrom=n[1],t.msgkey=n[2],t.content=n[3],t.attachment=n[4],t.roomid=n[5],t.timestamp=n[6],t.msg_headsrc=n[7]?n[7]:"",t.msg_originalsrc=n[8]?n[8]:"",t.msg_audiosrc=n[9]?n[9]:"",t.localid=n[10]?n[10]:+(new Date),t.fname=n[11]?n[11]:"",t.chat_tag=n[12]?n[12]:"",t):t},str2other:function(e){var t={};if(!e)return t;var n=e.split("\n");return n?(t.mtype=n[0],t.from=n[1],t.touin=n[2],t.msg_id=n[3],t.content=n[4],t):t},other2str:function(e){return e.type+"\n"+e.from+"\n"+
e.to+"\n"+e.msg_id+"\n"+e.content},addOtherMsg:function(n){var r=this.other2str(n),i=e.seqq.getNextSeq();t.setItemTo(i,r,"webpager_msgs")},addRealTime:function(n){var r=this.realTimeToStr(n),i=e.seqq.getNextSeq();t.setItemTo(i,r,"webpager_msgs")},addGroupChat:function(n,r){var i=this.groupChatToStr(n),s=e.seqq.getNextSeq();t.setItemTo(s,i,"webpager_msgs");var o=this.getMsgSeq()+1;t.setItemTo("m"+o%this.MSG_HISRY_COUNT,i,"webpager_msg",!0),this.setMsgSeq(o)}},e.event.enableCustomEvent(e.MsgMgr)}(WPC),function(e){var t=e.CometMgr,n=e.Sound,r=e.Profile,i=e.MsgMgr,s=e.PersistMgr,o=e.cookie;e.PagerChannel={init:function(){this.bindEvent()},bindEvent:function(){var e=this;i.addEvent("message_got",function(t){e.fireEvent("message_got",t)}),i.addEvent("group_open",function(t){e.fireEvent("group_open",t)}),i.addEvent("group_item",function(t){e.fireEvent("group_item",t)}),i.addEvent("group_list",function(t){e.fireEvent("group_list",t)}),i.addEvent("group_name",function(t){e.fireEvent("group_name",t)}),i.addEvent("group_config",function(t){e.fireEvent("group_config",t)}),i.addEvent("group_invite",function(t){e.fireEvent("group_invite",t)}),i.addEvent("group_inviteitem",function(t){e.fireEvent("group_inviteitem",t)}),i.addEvent("group_quit",function(t){e.fireEvent("group_quit",t)}),i.addEvent("group_quititem",function(t){e.fireEvent("group_quititem",t)}),i.addEvent("group_message",function(t){e.fireEvent("group_message",t)}),i.addEvent("group_sr",function(t){e.fireEvent("group_sr",t)}),i.addEvent("group_error",function(t){e.fireEvent("group_error",t)}),i.addEvent("chat_message",function(t){e.fireEvent("chat_message",t)}),i.addEvent("group_latestmsgs",function(t){e.fireEvent("group_latestmsgs",t)}),i.addEvent("group_info",function(t){e.fireEvent("group_info",t)}),i.addEvent("chat_sr",function(t){e.fireEvent("chat_sr",t)}),i.addEvent("chat_sn",function(t){e.fireEvent("chat_sn",t)}),i.addEvent("chat_self",function(t){e.fireEvent("chat_self",t)}),i.addEvent("chat_error",function(t){e.fireEvent("chat_error",t)}),i.addEvent("chat_lastestmsg",function(t){e.fireEvent("chat_lastestmsg",t)}),i.addEvent("getStrangeInfo",function(t){e.fireEvent("getStrangeInfo",t)}),i.addEvent("setStrangeInfo",function(t){e.fireEvent("setStrangeInfo",t)}),i.addEvent("realTime_got",function(t){t.timestamp=(new Date).getTime(),t.type=56,e.fireEvent("realTime_got",t)}),i.addEvent("groupmsg_got",function(t){e.fireEvent("groupmsg_got",t)}),i.addEvent("other_got",function(t){e.fireEvent("other_got",t)}),i.addEvent("spam_got",function(t){e.fireEvent("spam_got",t)}),t.addEvent("cometmgr_connected",function(){try{top.$msg_proxy&&top.$msg_proxy.onConnected()}catch(e){}}),t.addEvent("cometmgr_disconnected",function(){try{top.$msg_proxy&&top.$msg_proxy.onDisconnected(),e.fireEvent("channel_disconnected")}catch(t){}}),s.addEvent("storage",function(t){e.fireEvent("storage",t)})},checkPlugin:function(e,t){var n=window.navigator.plugins;if(!!n&&!window.ActiveXObject){var s=[],o=n.length;for(var u=0;u<o;u++)if(n[u].name.indexOf(e)>=0)return!0;return!1}try{var r=new ActiveXObject(t);if(r)return!0}catch(i){return!1}throw new Error(" 暂时不支持的浏览器 ")},startIM:function(){var t=document.domain.indexOf("renren.com")!=-1,n=top.XN.cookie.get,r=!1,i;if(!n("id")||!n("t")||!n("xnsid")||!t){top.webpager.fireEvent("im_start_over",r);return}try{if(this.checkPlugin("npxntalk","renren.Renren.1")){top.webpager.IMInstalled=!0;if(window.ActiveXObject){i=new ActiveXObject("renren.Renren.1");var r=i.IfNeedStart("xntalk");r==1&&(i.StartUp("xntalk")==0?r=e.startXnclient():r=!0)}else i=document.createElement("embed"),i.type="application/xntalk-plugin",document.body.appendChild(i),r=!!i.IfNeedStart("xntalk"),r&&(r=i.StartUp("xntalk"))}else r=e.startXnclient()}catch(s){r=e.startXnclient()}top.webpager.fireEvent("im_start_over",r)},sendMessage:function(e,t,n){i.send(e,t,n)},getMessageHistory:function(e){var t=i.loadMsgHistory(e);return t},enableConn:function(e){e?r.setUseIm(!0,!0):r.setUseIm(!1,!0)},isLocalConnect:function(){return t.isLocalConn},showRealTime:function(t){i.addRealTime({content:t,type:"notify2",touin:e.getLoginUin(),msg_id:i.messageId})},setItem:function(t,n,r,i){setTimeout(function(){return s.setItemTo(t,n,"webpager_common"+(r?"":e.getLoginUin()),i)},0)},getItem:function(t,n){return s.getItemFrom(t,"webpager_common"+(n?"":e.getLoginUin()))},showGroupChat:function(e){},getConnState:function(){return t.getConnState()},setPlaySound:function(e){return r.setPlaySound(e,!0)},getShowPager:function(){return!0},notificationRequest:function(e){window.webkitNotifications.requestPermission(function(){var t=window.webkitNotifications.checkPermission();e(t)})},notificationShow:function(e){if(!window.webkitNotifications.checkPermission()){var t;t=window.webkitNotifications.createNotification(e.head,e.name,e.content),t.show(),t.onclick=function(){top.focus(),this.cancel();try{e.callback()}catch(t){}},setTimeout(function(){t.cancel()},8e3)}},notificationPermission:function(){return window.webkitNotifications.checkPermission()}},e.event.enableCustomEvent(e.PagerChannel),document.domain="renren.com",top.webpager=WPC.PagerChannel}(WPC),function(e){function t(t,n){var r=top.document.createElement("link");r.href=t,r.rel="stylesheet",top.document.head.appendChild(r);var i=top.document.createElement("div");i.id="webpager_css_loading";var s=function(e){return i.currentStyle?i.currentStyle[e]:i.ownerDocument.defaultView.getComputedStyle(i,null)[e]};top.document.body.appendChild(i);var o,u=new Date;(function(){var t=arguments.callee;"none"===s("display")?(clearTimeout(o),top.document.body.removeChild(i),n()):new Date-u<5e3?o=setTimeout(t,100):e.reportExpt("loadCSS",new Error("loadCSS timeout 5s"),"样式可能没加载成功")})()}function n(e,n){function a(){if(r>=1)return;try{r=1,setTimeout(function(){e.use("webpager/im",function(){r=2})},500)}catch(t){throw r=-1,t}}if(n.disableWebpager)return;var r=0,i;n.browser.IE6?i="http://s.xnimg.cn/"+cssVer+"/webpager/webpager-ie6-min.css":n.browser.IE7||n.browser.IE8?i="http://s.xnimg.cn/"+cssVer+"/webpager/webpager-ie7-min.css":i="http://s.xnimg.cn/"+cssVer+"/webpager/webpager-std-min.css";try{t(i,a)}catch(s){throw s}setTimeout(a,5e3);var o=document.head.getElementsByTagName("script"),u;while(o.length)u=top.document.createElement("script"),u.setAttribute("data-src",o[0].getAttribute("data-src")),u.setAttribute("data-module",o[0].getAttribute("data-module")),top.document.head.appendChild(u),document.body.appendChild(o[0])}top.document.head||(top.document.head=top.document.getElementsByTagName("head")[0],document.head=document.getElementsByTagName("head")[0]),top.webpager&&top.webpager.addEvent("im_start_over",function(t){top.webpager.imRunning=t,top.webpager.storageOk=e.PersistMgr.init(),e.CometMgr.init(),e.MsgMgr.init(),e.PagerChannel.init(),top.webpagerLoader&&top.webpagerLoader.fireEvent("channel_ok",uiVer),top&&top.XN&&n(top.object,top.XN)});var r="vid",i,s=e.cookie,o=s.get("id"),u=s.get(r);if(!u||u!=o){try{i=top.XN.user.ruid}catch(a){}o&&i&&i!=o?(u=o,s.set(r,u)):u=null}if(u&&parseInt(u)>2e9){try{var f=top.XN.smartyBuddy;f.frameLayout()&&(f.frameLayout(0),f.noLoading(),f.saveStat(0))}catch(a){}return}if(top.document.getElementById("webpager")){e.reportExpt("channel_iframe_reload",new Error("莫名其妙的重载了ime.htm"),navigator.userAgent);return}top.webpager.startIM()}(WPC);var _comet_conn_state=0;(function(){var e=WPC.Comet.connState();WPC.CometMgr.isAlive()||setTimeout(function(){WPC.CometMgr.isAlive()||WPC.reportExpt("cometAlive",new Error("not alive but no one retry!"),navigator.userAgent)},3e4);if(!_comet_conn_state&&!e){WPC.reportExpt("cometState",new Error("超过三分钟没有人连接"),navigator.userAgent);return}_comet_conn_state=e,setTimeout(arguments.callee,18e4)})();